# 主机服务安全之主机安全建设

主机服务安全分为两部分，主机安全与服务安全。

主机安全，其核心内容包括安全应用交付系统、应用监管系统、操作系统安全增强系统和运维安全管控系统。它的具体功能是指保证主机在数据存储和处理的保密性、完整性，可用性，它包括硬件、固件、系统软件的自身安全，以及一系列附加的安全技术和安全管理措施，从而建立一个完整的主机安全保护环境。

等保2.0中的主机安全部分：

身份鉴别（S3）
访问控制（S3）
安全审计（G3）
剩余信息保护（S3）
入侵防范（G3）
恶意代码防范（G3）
资源控制（A3）

[pdf文字](https://twosecurity-course.oss-cn-beijing.aliyuncs.com/安全运维/《网络安全等级保护基本要求》.pdf)



入侵防范（G3）：

- 应能够检测到对重要服务器进行入侵的行为，能够记录入侵的源 IP 、攻击的类型、攻击的目的、攻击的时间，并在发生严重入侵事件时提供报警；
- 应能够对重要程序的完整性进行检测，并在检测到完整性受到破坏后具有恢复的措施；
- 操作系统应遵循最小安装的原则，仅安装需要的组件和应用程序，并通过设置升级服务器等方式保持系统补丁及时得到更新。

互联网公司发展阶段

![img](http://wechatapppro-1252524126.file.myqcloud.com/appYbDKptvG2044/image/ueditor/23376200_1568893207.png)

互联网公司发展的特点：

- 乱，业务发展快而难以预期，拥抱变化是应该的，主动求变是鼓励的。
- 新，各种新技术被广泛使用，虚拟化、容器技术、NOSQL、DEVOPS等都是先在互联网公司流行起来的。
- 快，快速迭代，一天上线十几次都属于正常。

主机安全防御的两种思路：

- 主动防御，主动的加固系统安全，填补漏洞
- 被动防御，通过各种监控系统，审计系统，发现问题后及时反馈处理，实现被动的安全防御。


主机系统加固

1：账号口令安全
2：系统服务安全
3：网络服务安全
4：文件系统安全
5：日志审计

# 主机服务安全之基线配置管理

为什么要做基线配置管理？

一个公司在不同的时期部署了不同的业务系统，承载业务系统的是不同的操作系统和支持系统。业务系统在运行期间，基本上很少做操作系统的升级或变更。然后由于不同供应商的支持原因，导致现存的操作系统和应用版本跨度很广，安全人员或运维人员资源不够的情况下很难支持做基线配置工作。

对公司的运维和安全人员来说，如果运行的业务系统一直不出事，是想不到要做基线配置、升级补丁、修复漏洞这些事情的，考虑做基线管理，通常来自于3个原因：

- 合规性性要求，上级安全检查；
- 遇到安全事件，根源落在安全配置或加固未做好的原因上
- 有经验的安全运维人员主动推动。

做好基线配置和加固是安全运维工作中很基础的工作，却跟很多安全事件有着紧密关系，如登录策略未配置好导致账号可以爆破、敏感信息泄露、默认口令、开启了含有漏洞服务的端口。

做好基础的基线管理和系统加固可以在很多突发安全漏洞情况有足够的响应处理时间。

如何展开基线配置管理？

\1. 建立基线配置管理规划

在了解组织现有资产情况（负责人是谁？现在运行的操作系统是什么版本，支持系统是什么版本？供应商是谁？是否还有开发或外包开发支持等）。同业务、开发、运维一起讨论制定合理的版本统一化建议，对统一化的时间达成一致的共识，并寻求最高管理层的支持。

\2. 定制基础操作系统镜像

基础镜像包括选择那个版本的操作系统、如何进行分区，如何最小化安装，如何部署必须的工具软件（如杀毒，主机入侵检测、运维系统Agent等），统一做好的基础操作系统镜像分发给开发作为基础的定制开发环境。

\3. 制定基线配置模板

基线配置模板可以包含运维和安全2个部分，运维部分如性能相关配置、稳定性相关配置、个性化配置。同一个应用（Tomcat、IIS、Apache等）可以做成一个统一的配置模板由SaltStack、Puppet进行分发。同时也可以做一份标准化配置脚本，在部分能分发的情况下也能统一基线配置。 如何展开基线配置管理



参考等保 2.0（公安部的标准解读）：http://netinfo-security.org/article/2019/1671-1122-19-2-77.html

参考CIS：https://learn.cisecurity.org/benchmarks



# 主机服务安全之账号口令安全基础篇

帐号口令就如同堡垒的门钥匙，再坚固的堡垒配上一把劣质的锁都是于事无补。

检查点1



是否存在特权账户(/etc/passwd中存在uid为0的非root账户)
加固方法: 如果存在特权账户, 则需要删除此账户。

检查点2



是否存在空口令账户(/etc/shadow中密码字段为空的账户)
加固方法: 如果存在口口令账户, 判断此账户是否属于合法账户。对账户设置密码或者删除此账户。

检查点3



密码最小长度(/etc/login.defs中PASS_MIN_LEN的值)
加固方法: 推荐为8位, 如果小于8则修改为大于8的数值。

检查点4



UMASK值(/etc/login.defs中UMASK值是否为077)
加固方法: 修改/etc/login.defs中UMASK值为077

检查点5



用户UMASK值(/etc/profile中第一个umask值是否为027)
加固方法: 修改/etc/profile中第一个umask值为027 750

检查点6



BASH UMASK值(/etc/bashrc中第一个umask值是否为027)
加固方法: 修改/etc/bashrc中第一个umask值为027

# 主机服务安全之账号口令安全高级篇

检查点1

是否配置密码复杂度策略(/etc/pam.d/system-auth是否配置pam_cracklib规则)

加固方法：

```
编辑/etc/pam.d/system-auth

在 "password    sufficient    pam_unix.so sha512 shadow nullok try_first_pass use_authtok" 前 

添加

"password requisite pam_cracklib.so try_first_pass retry=5 type= minlen=10 ucredit=2 dcredit=-1 ocredit=-1"
```

检查点2

是否配置密码锁定策略(/etc/pam.d/system-auth是否配置pam_tally或者pam_tally2规则)

加固方法:

```
编辑/etc/pam.d/system-auth

在" auth        sufficient    pam_unix.so nullok try_first_pass" 前

添加

" auth        required      pam_tally2.so onerr=fail deny=3 even_deny_root unlock_time=30"
```

这里使用的是 pam_tally2 模块，如果不支持pam_tally2，可以使用pam_tally模块。 另外，不同的pam版本，设置可能有所不同，具体使用方法，可以参照相关模块的使用规则。


拓展学习：linux权限解释

一般权限

左边三个字符表示所有者权限，中间3个字符表示与所有者同一组的用户的权限，右边3个字符是其他用户的权限。这三个一组共9个字符，代表的意义如下：

- r(Read，读取)：对文件而言，具有读取文件内容的权限；对目录来说，具有浏览目录的权
- w(Write,写入)：对文件而言，具有新增、修改文件内容的权限；对目录来说，具有删除、移动目录内文件的权限
- x(eXecute，执行)：对文件而言，具有执行文件的权限；对目录了来说该用户具有进入目录的权限。
- -：表示不具有该项权限。

下面举例说明：

-rwx------: 文件所有者对文件具有读取、写入和执行的权限。
-rwxr―r--: 文件所有者具有读、写与执行的权限，其他用户则具有读取的权限。
-rw-rw-r-x: 文件所有者与同组用户对文件具有读写的权限，而其他用户仅具有读取和执行的权限。
drwx--x--x: 目录所有者具有读写与进入目录的权限,其他用户近能进入该目录，却无法读取任何数据。
drwx------: 除了目录所有者具有完整的权限之外，其他用户对该目录完全没有任何权限。



每个用户都拥有自己的专属目录，通常集中放置在/home目录下，这些专属目录的默认权限为rwx------:表示目录所有者本身具有所有权限，其他用户无法进入该目录。

执行mkdir命令所创建的目录，其默认权限为rwxr-xr-x,用户可以根据需要修改目录的权限。此外，默认的权限可用umask命令修改，用法非常简单，只需执行umask 777 命令，便代表屏蔽所有的权限，因而之后建立的文件或目录，其权限都变成000，依次类推。

通常root帐号搭配umask命令的数值为022、027和 077，普通用户则是采用002，这样所产生的权限依次为755、750、700、775。

用户登录系统时，用户环境就会自动执行rmask命令来决定文件、目录的默认权限。

特殊权限

其实文件还有所谓的特殊权限。由于特殊权限会拥有一些“特权”，因而用户若无特殊需求，不应该启用这些权限，避免安全方面出现严重漏洞，造成黑客入侵，甚至摧毁系统。

- s或S（SUID,Set UID）：可执行的文件搭配这个权限，便能得到特权，任意存取该文件的所有者能使用的全部系统资源。请注意具备SUID权限的文件，黑客经常利用这种权限，以SUID配上root帐号拥有者，无声无息地在系统中开扇后门，供日后进出使用。
- s或S（SGID，Set GID）：设置在文件上面，其效果与SUID相同，只不过将文件所有者换成用户组，该文件就可以任意存取整个用户组所能使用的系统资源。
- t或T（Sticky）：/tmp和 /var/tmp目录供所有用户暂时存取文件，亦即每位用户皆拥有完整的权限进入该目录，去浏览、删除和移动文件。

因为SUID、SGID、Sticky占用x的位置来表示，所以在表示上会有大小写之分。加入同时开启执行权限和SUID、SGID、Sticky，则权限表示字符是小写的；如果关闭执行权限，则表示字符会变成大写。



权限值说明

文件和目录的权限表示，是用rwx这三个字符来代表所有者、用户组和其他用户的权限。有时候，字符似乎过于麻烦，因此还有另外一种方法是以数字来表示权限，而且仅需三个数字。

| 字符 | 对应值 |
| ---- | ------ |
| r    | 4      |
| w    | 2      |
| x    | 1      |
| -    | 0      |

数字设定的关键是mode的取值，一开始许多初学者会被搞糊涂，其实很简单，我们将rwx看成二进制数，如果有则有1表示，没有则有0表示，那么rwx r-x r- -则可以表示成为：111 101 100再将其每三位转换成为一个十进制数，就是754。

例如，我们想让a.txt这个文件的权限为：

|        | 自己 | 同组用户 | 其他用户 |
| ------ | ---- | -------- | -------- |
| 可读   | 是   | 是       | 是       |
| 可写   | 是   | 是       |          |
| 可执行 |      |          |          |



那么，我们先根据上表得到权限串为：rw-rw-r--，那么转换成二进制数就是110 110 100，再每三位转换成为一个十进制数，就得到664，因此我们执行命令：

```
[root@localhost ~] chmod 664 a.txt
```

按照上面的规则，rwx合起来就是4+2+1＝7，一个rwx-rwx-rwx权限全开放的文件，数值表示为777；而完全不开放权限的文件“－－－－－－－－－”其数字表示为000。

下面举几个例子：

rwx------:等于数字表示700
rwxr―r--:等于数字表示744
rw-rw-r-x:等于数字表示
665drwx―x―x:等于数字表示
711drwx------:等于数字表示700

# 主机服务安全之系统服务安全

系统服务常用的是：SSH、防火墙等基础的系统服务。

SSHD

不仅仅是远程链接协议或工具

检查点1

SSHD默认端口(/etc/ssh/sshd_config中Port数值)
加固方法：推荐非22默认端口, 编辑sshd配置添加 Port NUM

检查点2



SSHD是否允许root远程登陆(sshd配置PermitRootLogin数值)
加固方法：建议禁止root远程登陆, 编辑sshd配置添加 PermitRootLogin no

检查点3



SSHD是否允许TCP转发(sshd配置AllowTcpForwarding数值)
加固方法：建议禁止TCP转发, 编辑sshd配置添加 AllowTcpForwarding no

检查点4



SSHD是否开启网关端口(sshd配置GatewayPorts数值)
加固方法：建议禁止网关端口, 编辑sshd配置添加 GatewayPorts no

配置生效：

```
sshd -t #无错误后

service sshd restart #重启sshd服务
```

[SSH隧道详解](https://twosecurity-course.oss-cn-beijing.aliyuncs.com/安全运维/ssh隧道详解.pdf)



防火墙

检查点: 检测系统是否开启防火墙
加固方法：建议开启防火墙并配置相应的防火墙策略

系统文件权限

检查点: 检测系统是否存在任意可写的文件或目录
加固方法：修改文件/目录的权限

漏洞检测

检查点1：是否存在bash破壳漏洞
加固方法：若存在bash破壳漏洞，则需要更新bash版本，yum update bash

检查点2：是否存在心脏滴血漏洞
加固方法：若存在心脏滴血漏洞，则需要更新openssl版本，yum update openssl

bash 破壳漏洞



```
env x='() { :;}; echo vulnerable' bash -c "echo this is a test" 
打印出： vulnerable  /  this is a test
```

心脏滴血漏洞

```
rpm -q --changelog openssl |grep CVE-2014-0160
```

网络服务加固

Apache 安全加固
IIS 安全加固
Nginx 安全加固
Tomcat 安全加固
php 安全加固
Mysql 安全加固
Sqlserver 安全加固

日志审计

- 系统日志：rsyslog/syslog
- linux用户空间审计系统：audit

# 主机服务安全之windows主机加固

帐号管理，认证授权

口令，账户，授权

口令：

- 最短密码长度 6个字符，启用本机组策略中密码必须符合复杂性要求的策略。即密码至少包含以下四种类别的字符中的三种。
- 对于采用静态口令认证技术的设备，账户口令的生存期不长于90天。
- 对于采用静态口令认证技术的设备，应配置设备，使用户不能重复使用最近5次（含5次）内已使用的口令。
- 对于采用静态口令认证技术的设备，应配置当用户连续认证失败次数超过6次（不含6次），锁定该用户使用的账号。

注意：不宜实施，管理帐号网络登陆锁定后影响维护工作。MISC的windows主机没有向外网开放接口。

帐户：

- 按照用户分配账号。根据系统的要求，设定不同的账户和账户组，管理员用户，数据库用户，审计用户，来宾用户等。
- 删除或锁定与设备运行、维护等与工作无关的账号。
- 对于管理员帐号，要求更改缺省帐户名称；禁用guest（来宾）帐号。

授权：

- 在本地安全设置中从远端系统强制关机只指派给Administrators组。
- 在本地安全设置中关闭系统仅指派给Administrators组。
- 在本地安全设置中取得文件或其它对象的所有权仅指派给Administrators。
- 在本地安全设置中配置指定授权用户允许本地登陆此计算机。
- 在组策略中只允许授权帐号从网络访问(包括网络共享等，但不包括终端服务)此计算机。

日志监控配置

日志监控，转发

配置：

- 设备应配置日志功能，对用户登录进行记录，记录内容包括用户登录使用的账号，登录是否成功，登录时间，以及远程登录时，用户使用的IP地址。
- 启用组策略中对Windows系统的审核策略更改，成功和失败都要审核。
- 启用组策略中对Windows系统的审核对象访问，成功和失败都要审核。
- 启用组策略中对Windows系统的审核目录服务访问，失败审核。
- 启用组策略中对Windows系统的审核特权使用，成功和失败都要审核。
- 启用组策略中对Windows系统的审核系统事件，成功和失败都要审核。
- 启用组策略中对Windows系统的审核帐户管理，成功和失败都要审核。
- 启用组策略中对Windows系统的审核过程追踪，失败审核。
- 设置应用日志文件大小至少为8192KB，设置当达到最大的日志尺寸时，按需要改写事件。
- 设置系统日志文件大小至少为8192KB，设置当达到最大的日志尺寸时，按需要改写事件。
- 设置安全日志文件大小至少为8192KB，设置当达到最大的日志尺寸时，按需要改写事件。

其他安全配置

列出系统服务的列表，检查有无可疑项
关闭Windows自动播放功能
补丁自动更新
屏幕保护
防病毒
……

IP协议安全配置：

对没有自带防火墙的Windows系统，启用Windows系统的IP安全机制(IPSec)或网络连接上的TCP/IP筛选，只开放业务所需要的TCP，UDP端口和IP协议。

启用Windows XP和Windows 2003 自带防火墙。根据业务需要限定允许访问网络的应用程序，和允许远程登陆该设备的IP地址范围。

启用SYN攻击保护；指定触发SYN洪水攻击保护所必须超过的TCP连接请求数阀值为5；指定处于 SYN_RCVD 状态的 TCP 连接数的阈值为500；指定处于至少已发送一次重传的 SYN_RCVD 状态中的 TCP 连接数的阈值为400。

其他配置：

- 设置带密码的屏幕保护，并将时间设定为5分钟。
- 对于远程登陆的帐号，设置不活动断连时间15分钟。
- 非域环境中，关闭Windows硬盘默认共享，例如C$，D$。
- 查看每个共享文件夹的共享权限，只允许授权的账户拥有权限共享此文件夹。
- 应安装最新的Service Pack补丁集。对服务器系统应先进行兼容性测试。
- 应安装最新的Hotfix补丁。对服务器系统应先进行兼容性测试。
- 安装防病毒软件，并及时更新。
- 对于Windows XP SP2及Windows 2003对Windows操作系统程序和服务启用系统自带DEP功能(数据执行保护)，防止在受保护内存位置运行有害代码。
- 列出所需要服务的列表(包括所需的系统服务)，不在此列表的服务需关闭。
- 列出系统启动时自动加载的进程和服务列表，不在此列表的需关闭。
- 如需启用SNMP服务，则修改默认的SNMP Community String设置。
- 如需启用IIS服务，则将IIS升级到最新补丁。
- 关闭Windows自动播放功能。

# 主机服务安全之日志审计

对服务器日常产生的日志进行审计

收集->存储->审计

日志的收集

Linux

```
rsyslog/syslog + audit
```

windows

```
nxlog + sysmon
```

日志的汇总和存储

- 海量数据存储
- 数据的快速检索

日志的审计

制定审计规则

# 主机服务安全之Linux 日志审计

日志作用可用于排障和追溯审计等

rsyslog/syslog 服务

rsyslog是类unix系统上使用的一个开源工具，用于实现系统日志的集中管理。

rsyslog 支持UDP\TCP\RELP协议传输
日志信息过滤功能
自定义化的模板格式输出

audit服务



linux内置的内核审计模块，记录系统中的各种动作和事件，比如系统调用，文件修改，执行的程序，系统登入登出和记录所有系统中所有的事件，为管理员提供系统审计。

linux的日志优先级

| debug   | 调试信息，日志通信最多                               |
| ------- | ---------------------------------------------------- |
| info    | 一般信息日志，最常用                                 |
| notice  | 最具有重要性的普通条件的信息                         |
| warning | 警告级别                                             |
| err     | 错误级别，阻止某个功能或者模块不能正常工作的信息     |
| crit    | 严重级别，阻止整个系统或者整个软件不能正常工作的信息 |
| alert   | 需要立刻修改的信息                                   |
| emerg   | 内核崩溃等重要信息                                   |

Linux 常见的日志类型

- auth   #用户认证时产生的日志，如 login 命令、su 命令。
- authpriv #与 auth 类似，但是只能被特定用户查看。
- console #针对系统控制台的消息。
- cron   #系统定期执行计划任务时产生的日志。
- daemon #某些守护进程产生的日志。
- ftp    #FTP服务。
- kern   #系统内核消息。
- local0.local7 #由自定义程序使用。
- lpr    #与打印机活动有关。
- mail   #邮件日志。
- mark   #产生时间戳。系统每隔一段时间向日志文件中输出当前时间，每行的格式类似于 May 26 11:17:09 rs2 -MARK --，可以由此推断系统发生故障的大概时间。
- news   #网络新闻传输协议(nntp)产生的消息。
- ntp    #网络时间协议(ntp)产生的消息。
- user   #用户进程。
- uucp   #UUCP子系统。



rsyslog

配置文件：/etc/rsyslog.conf

```
kern.*;auth.*;authpriv.* @server_ip:port
```

接收日志：

```
$ModLoad imudp

$UDPServerRun 514
```

audit服务

修改配置文件 /etc/audisp/plugins.d/syslog.conf

```
active = yes

args = LOG_LOCAL5 LOG_DEBUG
```

# 主机服务安全之Windows 日志审计

nxlog 服务

nxlog是windows系统下的一个日志收集转发的工具，可以处理来自许多不同来源的大量事件日志。nxlog可以配置模块化架构对日志的输入，输出，进行处理。并且可以支持多种存储格式的转发。

sysmon 服务

Sysmon是一款轻量级的系统监控工具，通过收集使用Windows事件集合或SIEM代理生成的事件，然后分析它们，您可以识别恶意或异常活动，并了解入侵者和恶意软件在您的网络上如何操作。

nxlog 配置文件：C:\Program Files (x86)\nxlog\conf

```
<Extension _syslog>

     Module      xm_syslog 收集事件日志，所有的事件日志默认都被收集 

</Extension>

<Input in> #配置日志源

     Module      im_msvistalog #winserver2008及以上 

#   Module      im_mseventlog winserver2003及以下 

</Input> 

<Output out> #配置日志转发

    Module      om_tcp #使用tcp模式转发 

    Host         192.168.200.29 #日志服务器的 IP 


    Port          514 #日志服务器接收端口 

    Exec         to_syslog_snare(); #输出到syslog服务 

</Output> 

<Route 1> 

     Path        in => out #源输入对应输出

</Route>
```

自定义需要保存的事件日志种类

```
<Input in> 配置input

Module      im_msvistalog 

#  For windows 2003 and earlier use the following: 

#  Module      im_mseventlog 

     ReadFromLast FALSE 

     SavePos     

     FALSE 

     Query       <QueryList>\ 

                        <Query Id="0">\ 

                            <Select Path="Security">*</Select>\ #配置为只发送Security Log 

                        </Query>\ 

                    </QueryList>
</Input>
```

重启 nxlog 服务：

cmd 输入services.msc 找到nxlog，重新启动

日志存储，检索

- 大数据框架
- Spark框架（Elasticsearch + Logstash + Kibana ELK框架）



audit规则配置官网说明文档：https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html/security_guide/sec-defining_audit_rules_and_controls

nxlog说明文档：https://nxlog.co/docs/nxlog-ce/nxlog-reference-manual.html#config_module_common