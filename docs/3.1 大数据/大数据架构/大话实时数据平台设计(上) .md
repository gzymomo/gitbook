# 大话实时数据平台设计(上) 

# 一、相关概念背景

## 1从现代数仓架构角度看实时数据平台

现代数仓由传统数仓发展而来，对比传统数仓，现代数仓既有与其相同之处，也有诸多发展点。首先我们看一下传统数仓（图1）和现代数仓（图2）的模块架构：

![图片](https://mmbiz.qpic.cn/mmbiz_png/tibrg3AoIJTuOYXF3pqL2yBObzQEBnCaxZr8D6mef3WtzOGoP0jvDC7oMYDWqOduYVAKmKjQbLWnpq3Tf8STyZg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

图1 传统数仓

![图片](https://mmbiz.qpic.cn/mmbiz_png/tibrg3AoIJTuOYXF3pqL2yBObzQEBnCaxoBfyY2VbpRFGRGlmKSicQxa2xMcIyRZS11eHeSHpWRXibFibHDsKerAUg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

图2 现代数仓

传统数仓大家都很熟悉，这里不做过多介绍，一般来说，传统数仓只能支持T＋1天时效延迟的数据处理，数据处理过程以ETL为主，最终产出以报表为主。

现代数仓建立在传统数仓之上，同时增加了更多样化数据源的导入存储，更多样化数据处理方式和时效（支持T＋0天时效），更多样化数据使用方式和更多样化数据终端服务。

现代数仓是个很大的话题，在此我们以概念模块的方式来展现其新的特性能力。

首先我们先看一下图3中Melissa Coates的整理总结：

![图片](https://mmbiz.qpic.cn/mmbiz_png/tibrg3AoIJTuOYXF3pqL2yBObzQEBnCaxzwotibRhgk1ia8Vu0lGMhVhr1ADHRt2tF0OVDq1BoNu2t5p8IP9xor2w/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

图3

在图3 Melissa Coates的总结中我们可以得出，现代数仓之所以“现代”，是因为它有多平台架构、数据虚拟化、数据的近实时分析、敏捷交付方式等等一系列特性。

在借鉴Melissa Coates关于现代数仓总结的基础上，加以自己的理解，我们也在此总结提取了现代数仓的几个重要能力，分别是：

- 数据实时化（实时同步和流式处理能力）
- 数据虚拟化（虚拟混算和统一服务能力）
- 数据平民化（可视化和自助配置能力）
- 数据协作化（多租户和分工协作能力）

### （1）数据实时化（实时同步和流式处理能力）

数据实时化，是指数据从产生（更新至业务数据库或日志）到最终消费（数据报表、仪表板、分析、挖掘、数据应用等），支持毫秒级／秒级／分钟级延迟（严格来说，秒级／分钟级属于准实时，这里统一称为实时）。这里涉及到如何将数据实时的从数据源中抽取出来；如何实时流转；为了提高时效性，降低端到端延迟，还需要有能力支持在流转过程中进行计算处理；如何实时落库；如何实时提供后续消费使用。实时同步是指多源到多目标的端到端同步，流式处理指在流上进行逻辑转换处理。

但是我们要知道，不是所有数据处理计算都可以在流上进行，而我们的目的，是尽可能的降低端到端数据延迟，这里就需要和其他数据流转处理方式配合进行，后面我们会进一步讨论。

### （2）数据虚拟化（虚拟混算和统一服务能力）

数据虚拟化，是指对于用户或用户程序而言，面对的是统一的交互方式和查询语言，而无需关注数据实际所在的物理库和方言及交互方式（异构系统／异构查询语言）的一种技术。用户的使用体验是面对一个单一数据库进行操作，但其实这是一个虚拟化的数据库，数据本身并不存放于虚拟数据库中。

虚拟混算指的是虚拟化技术可以支持异构系统数据透明混算的能力，统一服务指对于用户提供统一的服务接口和方式。



![图片](https://mmbiz.qpic.cn/mmbiz_png/tibrg3AoIJTuOYXF3pqL2yBObzQEBnCaxg6rmMxpDtTJ4G1VxDhRtzOSTRNDQwTofxB2A1iaxCl3VPCbb2Ayxswg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

图4 数据虚拟化

注：图1-4均选自“Designing a Modern Data Warehouse + Data Lake” - Melissa Coates, Solution Architect, BlueGranite

### （3）数据平民化（可视化和自助配置能力）

普通用户（无专业大数据技术背景的数据从业人员），可以通过可视化的用户界面，自助的通过配置和SQL方式使用数据完成自己的工作和需求，并无需关注底层技术层面问题（通过计算资源云化，数据虚拟化等技术）。以上是我们对数据平民化的解读。

对于Data Democratization的解读，还可以参见以下链接：

https://www.forbes.com/sites/bernardmarr/2017/07/24/what-is-data-democratization-a-super-simple-explanation-and-the-key-pros-and-cons

文中提到技术层面如何支持数据平民化，并给出了几个例子：

- Data virtualization software；
- Data federation software；
- Cloud storage；
- Self-service BI applications等。

其中数据虚拟化和数据联邦本质上是类似技术方案，并且提到了自助BI这个概念。

### （4）数据协作化（多租户和分工协作能力）

技术人员应该多了解业务，还是业务人员应该多了解技术？这一直是企业内争论不休的问题。而我们相信现代BI是一个可以深度协作的过程，技术人员和业务人员可以在同一个平台上，发挥各自所长，分工协作完成日常BI活动。这就对平台的多租户能力和分工协作能力提出了较高要求，一个好的现代数据平台是可以支持更好的数据协作化能力的。

我们希望可以设计出一个现代实时数据平台，满足以上提到的实时化、虚拟化、平民化、协作化等能力，成为现代数仓的一个非常重要且必不可少的组成部分。

## 2从典型数据处理角度看实时数据处理

典型的数据处理，可分为OLTP、OLAP、Streaming、Adhoc、Machine Learning等。这里给出OLTP和OLAP的定义和对比：



![图片](https://mmbiz.qpic.cn/mmbiz_png/tibrg3AoIJTuOYXF3pqL2yBObzQEBnCax3J1mfGemFKktec0bibEBeLlJiaCIkYFbAoDzzIat5Zvaz5Idr6fImutA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

图5

注：图5选自文章“Relational Databases are not Designed for Mixed Workloads”-Matt Allen

从某种角度来说，OLTP活动主要发生在业务交易库端，OLAP活动主要发生在数据分析库端。那么，数据是如何从OLTP库流转到OLAP库呢？如果这个数据流转时效性要求很高，传统的T＋1批量ETL方式就无法满足了。

我们将OLTP到OLAP的流转过程叫Data  Pipeline（数据处理管道），它是指数据的生产端到消费端之间的所有流转和处理环节，包括了数据抽取、数据同步、流上处理、数据存储、数据查询等。这里可能会发生很复杂的数据处理转换（如重复语义多源异构数据源到统一Star  Schema的转换，明细表到汇总表的转换，多实体表联合成宽表等）。如何支持实时性很高的Pipeline处理能力，就成了一个有挑战性的话题，我们将这个话题描述为“在线管道处理”（OLPP, Online Pipeline Processing）问题。

因此，本文所讨论的实时数据平台，希望可以从数据处理角度解决OLPP问题，成为OLTP到OLAP实时流转缺失的课题的解决方案。下面，我们会探讨从架构层面，如何设计这样一个实时数据平台。

# 二、架构设计方案

## 1定位和目标

实时数据平台（Real-time Data  Platform，以下简称RTDP），旨在提供数据端到端实时处理能力（毫秒级／秒级／分钟级延迟），可以对接多数据源进行实时数据抽取，可以为多数据应用场景提供实时数据消费。作为现代数仓的一部分，RTDP可以支持实时化、虚拟化、平民化、协作化等能力，让实时数据应用开发门槛更低、迭代更快、质量更好、运行更稳、运维更简、能力更强。

## 2整体设计架构

概念模块架构，是实时数据处理Pipeline的概念层的分层架构和能力梳理，本身是具备通用性和可参考性的，更像是需求模块。图6给出了RTDP的整体概念模块架构，具体每个模块含义都可自解释，这里不再详述。



![图片](https://mmbiz.qpic.cn/mmbiz_png/tibrg3AoIJTuOYXF3pqL2yBObzQEBnCaxGmGYmWvztquqwWUoCUPmC5CmrHreX5Qs3ZVLtJwC32sWViawye8ReyQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

图6 RTDP整体概念模块架构

下面我们会根据上图做进一步设计讨论，给出从技术层面的高阶设计思路。



![图片](https://mmbiz.qpic.cn/mmbiz_png/tibrg3AoIJTuOYXF3pqL2yBObzQEBnCaxUK8W7bx0VM4d9Utn7zp4xoy08Oic8VIBaBq0EUfnTrPa2ibFPV157Ypg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

图7 整体设计思想

由图7可以看出，我们针对概念模块架构的四个层面进行了统一化抽象：

- 统一数据采集平台
- 统一流式处理平台
- 统一计算服务平台
- 统一数据可视化平台

同时，也对存储层保持了开放的原则，意味着用户可以选择不同的存储层以满足具体项目的需要，而又不破坏整体架构设计，用户甚至可以在Pipeline中同时选择多个异构存储提供支持。下面分别对四个抽象层进行解读。

### （1）统一数据采集平台

统一数据采集平台，既可以支持不同数据源的全量抽取，也可以支持增强抽取。其中对于业务数据库的增量抽取会选择读取数据库日志，以减少对业务库的读取压力。平台还可以对抽取的数据进行统一处理，然后以统一格式发布到数据总线上。这里我们选择一种自定义的标准化统一消息格式UMS（Unified Message Schema）做为统一数据采集平台和统一流式处理平台之间的数据层面协议。

UMS自带Namespace信息和Schema信息，这是一种自定位自解释消息协议格式，这样做的好处是：

- 整个架构无需依赖外部元数据管理平台；
- 消息和物理媒介解耦（这里物理媒介指如Kafka的Topic, Spark Streaming的Stream等），因此可以通过物理媒介支持多消息流并行，和消息流的自由漂移。

平台也支持多租户体系，和配置化简单处理清洗能力。

### （2）统一流式处理平台

统一流式处理平台，会消费来自数据总线上的消息，可以支持UMS协议消息，也可以支持普通JSON格式消息。同时，平台还支持以下能力：

- 支持可视化／配置化／SQL化方式降低流式逻辑开发／部署／管理门槛
- 支持配置化方式幂等落入多个异构目标库以确保数据的最终一致性
- 支持多租户体系，做到项目级的计算资源／表资源／用户资源等隔离

### （3）统一计算服务平台

统一计算服务平台，是一种数据虚拟化／数据联邦的实现。平台对内支持多异构数据源的下推计算和拉取混算，也支持对外的统一服务接口（JDBC／REST）和统一查询语言（SQL）。由于平台可以统一收口服务，因此可以基于平台打造统一元数据管理／数据质量管理／数据安全审计／数据安全策略等模块。平台也支持多租户体系。

### （4）统一数据可视化平台

统一数据可视化平台，加上多租户和完善的用户体系／权限体系，可以支持跨部门数据从业人员的分工协作能力，让用户在可视化环境下，通过紧密合作的方式，更能发挥各自所长来完成数据平台最后十公里的应用。

以上是基于整体模块架构之上，进行了统一抽象设计，并开放存储选项以提高灵活性和需求适配性。这样的RTDP平台设计，体现了现代数仓的实时化／虚拟化／平民化／协作化等能力，并且覆盖了端到端的OLPP数据流转链路。

## 3具体问题和考量思路

下面我们会基于RTDP的整体架构设计，分别从不同维度讨论这个设计需要面对的问题考量和解决思路。

### （1）功能考量

功能考量主要讨论这样一个问题：实时Pipeline能否处理所有ETL复杂逻辑？

我们知道，对于Storm／Flink这样的流式计算引擎，是按每条处理的；对于Spark Streaming流式计算引擎，按每个mini-batch处理；而对于离线跑批任务来说，是按每天数据进行处理的。因此处理范围是数据的一个维度（范围维度）。

另外，流式处理面向的是增量数据，如果数据源来自关系型数据库，那么增量数据往往指的是增量变更数据（增删改，revision）；相对的批量处理面向的则是快照数据（snapshot）。因此展现形式是数据的另一个维度（变更维度）。

单条数据的变更维度，是可以投射收敛成单条快照的，因此变更维度可以收敛成范围维度。所以流式处理和批量处理的本质区别在于，面对的数据范围维度的不同，流式处理单位为“有限范围”，批量处理单位为“全表范围”。“全表范围”数据是可以支持各种SQL算子的，而“有限范围”数据只能支持部分SQL算子，具体支持情况如下：

- join：

  ✔ left join：支持。“限制范围”可以left join外部lookup表（通过下推，类似hashjoin效果）

  ✔ right join：不支持。每次从lookup拿回所有lookup表数据，这个计算是不可行的也是不合理的

  ✔ inter join：支持。可以转化为left join ＋filter，可以支持

  ✔ outer join：不支持。存在right join，因此不合理

- union：支持。可以应用在拉回局部范围数据做窗口聚合操作。

- agg：不支持。可以借助union做局部窗口聚合，但无法支持全表聚合操作。

- filter：支持。没有shuffle，非常适合。

- map：支持。没有shuffle，非常适合。

- project：支持。没有shuffle，非常适合。

Join往往需要shuffle操作，是最费计算资源和时间的操作，而流上join（left join）将join操作转化成hashjoin的队列操作，将批量处理join的集中数据计算资源和时间平摊在数据流转过程中，因此在流上做left join是最划算的计算方式。

复杂的ETL并不是单一算子，经常会是由多个算子组合而成，由上可以看出单纯的流式处理并不能很好的支持所有ETL复杂逻辑。那么如何在实时Pipeline中支持更多复杂的ETL算子，并且保持时效性？这就需要“有限范围”和“全表范围”处理的相互转换能力。

设想一下：流式处理平台可以支持流上适合的处理，然后实时落不同的异构库，计算服务平台可以定时批量混算多源异构库（时间设定可以是每隔几分钟或更短），并将每批计算结果发送到数据总线上继续流转，这样流式处理平台和计算服务平台就形成了计算闭环，各自做擅长的算子处理，数据在不同频率触发流转过程中进行各种算子转换，这样的架构模式理论上即可支持所有ETL复杂逻辑。



![图片](https://mmbiz.qpic.cn/mmbiz_png/tibrg3AoIJTuOYXF3pqL2yBObzQEBnCaxvMiboP7NlBhl6m1WIVAXmic2eJookXwEBic9BRcArQPpKUj10lOGRc0Sg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

图8 数据处理架构演化

图8给出了数据处理架构的演化，和OLPP的一种架构模式。其中wormhole和moonbox分别是我们开源的流式处理平台和计算服务平台，后面会具体介绍。

### （2）质量考量

上面的图也引出了两个主流实时数据处理架构：Lambda架构和Kappa架构，具体两个架构的介绍网上有很多资料，这里不再赘述。Lambda架构和Kappa架构各有其优劣势，但都支持数据的最终一致性，从某种程度上确保了数据质量，如何在Lambda架构和Kappa架构中取长补短，形成某种融合架构，这个话题会在新起文章中详细探讨。

当然数据质量也是个非常大的话题，只支持重跑和回灌并不能完全解决所有数据质量问题，只是从技术架构层面给出了补数据的工程方案。关于大数据数据质量问题，我们也会起一个新的话题讨论。

### （3）稳定考量

这个话题涉及但不限于以下几点，这里简单给出应对的思路：

- 高可用HA

  整个实时Pipeline链路都应该选取高可用组件，确保理论上整体高可用；在数据关键链路上支持数据备份和重演机制；在业务关键链路上支持双跑融合机制

- SLA保障

  在确保集群和实时Pipeline高可用的前提下，支持动态扩容和数据处理流程自动漂移

- 弹性反脆弱

  基于规则和算法的资源弹性伸缩；支持事件触发动作引擎的失效处理。

- 监控预警

  集群设施层面，物理管道层面，数据逻辑层面的多方面监控预警能力

- 自动运维

  能够捕捉并存档缺失数据和处理异常，并具备定期自动重试机制修复问题数据

- 上游元数据变更抗性

  上游业务库要求兼容性元数据变更；实时Pipeline处理显式字段。

### （4）成本考量

这个话题涉及但不限于以下几点，这里简单给出应对的思路：

- 人力成本

  通过支持数据应用平民化降低人才人力成本

- 资源成本

  通过支持动态资源利用降低静态资源占用造成的资源浪费

- 运维成本

  通过支持自动运维／高可用／弹性反脆弱等机制降低运维成本

- 试错成本

  通过支持敏捷开发／快速迭代降低试错成本

### （5）敏捷考量

敏捷大数据是一整套理论体系和方法学，在前文已有所描述，从数据使用角度来看，敏捷考量意味着：配置化、SQL化、平民化。

### （6）管理考量

数据管理也是一个非常大的话题，这里我们会重点关注两个方面：元数据管理和数据安全管理。如果在现代数仓多数据存储选型的环境下统一管理元数据和数据安全，是一个非常有挑战的话题，我们会在实时Pipeline上各个环节平台分别考虑这两个方面问题并给出内置支持，同时也可以支持对接外部统一的元数据管理平台和统一数据安全策略。

本文我们探讨了实时数据平台RTDP的相关概念背景和架构设计方案。在架构设计方案中，我们尤其着重讲了RTDP的定位和目标，整体设计架构，以及涉及到的具体问题和考量思路。有些话题很大，可以后续单独形成文章进行专题讨论，但整体上，我们给出了一整套RTDP的设计思路和规划。在下篇技术篇中，我们会将RTDP架构设计具体化落地化，给出推荐的技术选型和我们的开源平台方案，并会结合不同场景需求探讨RTDP的不同模式应用。

如想了解更多，您还可以到Github浏览更多平台信息：

- DBus地址：https://github.com/BriData/DBus
- Davinci地址：https://github.com/edp963/davinci
- Wormhole地址：https://github.com/edp963/wormhole
- Moonbox地址：https://github.com/edp963/moonbox