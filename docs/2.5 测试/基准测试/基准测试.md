## 一、基准测试简介

### 1、什么是基准测试

数据库的基准测试是对数据库的性能指标进行定量的、可复现的、可对比的测试。

**基准测试与压力测试**

基准测试可以理解为针对系统的一种压力测试。但基准测试不关心业务逻辑，更加简单、直接、易于测试，数据可以由工具生成，不要求真实；而压力测试一般考虑业务逻辑(如购物车业务)，要求真实的数据。



基准测试是唯一方便有效的、可以学习系统在给定的工作负载下会发生什么的方法。基准测试可以观察系统在不同压力下的行为，评估系统的容量，掌握哪些是重要的变化，或者观察系统如何处理不同的数据。

- 验证基于系统的一些假设，确认这些假设是否符合实际情况
- 重现系统中的某些异常行为，以解决这些异常
- 测试系统当前的运行情况。如果不清楚系统的当前性能，就无法确认某些优化的效果如何。也可以利用历史的基准测试结果来分析诊断一些无法预测的问题。
- 模拟比当前系统更高的负载，以找出系统随着压力增加而可能遇到的扩展性瓶颈。
- 规划未来的业务增长。基准测试可以评估在项目未来的负载下，需要什么样的硬件，需要多大容量的网络，以及其他相关资源。这有助于降低系统升级和重大变更的风险。
- 测试应用适应可变环境的能力。
- 测试不同的硬件、软件和操作系统配置
- 证明新采购的设备是否配置正确。

基准测试的一个主要问题在于其不是真实压力测试。基准测试施加给系统的压力相对于真实压力来说，比较简单。

我们只能进行大概的测试，来确定系统大致的余量有多少。基准测试要尽量简单直接，结果之间容易相互比较，成本低切易于执行。

#### **特质**

**①、可重复性**：可进行重复性的测试，这样做有利于比较每次的测试结果，得到性能结果的长期变化趋势，为系统调优和上线前的容量规划做参考。

**PS**：这种特质是为了满足基准测试的日常轮询需要。

**②、可观测性**：通过全方位的监控（包括测试开始到结束，执行机、服务器、数据库），及时了解和分析测试过程发生了什么。

**③、可展示性**：相关人员可以直观明了的了解测试结果（web界面、仪表盘、折线图树状图等形式）。

**④、真实性**：测试的结果反映了客户体验到的真实的情况（真实准确的业务场景+与生产一致的配置+合理正确的测试方法）。

**⑤、可执行性**：相关人员可以快速的进行测试验证修改调优（可定位可分析）。



#### **前置条件**

基准测试一定要在可控的条件下进行。

面对日益复杂的系统和不断增长的用户数，以及性能测试可能涉及到的多个业务系统，只有做到基准测试所涉及的业务场景、系统架构、测试环境等在可控状态下，

才能得到相对准确的结果，为容量规划、缺陷定位、系统调优提供参考和依据。

### 2、基准测试的作用

对于多数Web应用，整个系统的瓶颈在于数据库；原因很简单：Web应用中的其他因素，例如网络带宽、负载均衡节点、应用服务器（包括CPU、内存、硬盘灯、连接数等）、缓存，都很容易通过水平的扩展（俗称加机器）来实现性能的提高。而对于MySQL，由于数据一致性的要求，无法通过增加机器来分散向数据库写数据带来的压力；虽然可以通过前置缓存（Redis等）、读写分离、分库分表来减轻压力，但是与系统其它组件的水平扩展相比，受到了太多的限制。

而对数据库的基准测试的作用，就是分析在当前的配置下（包括硬件配置、OS、数据库设置等），数据库的性能表现，从而找出MySQL的性能阈值，并根据实际系统的要求调整配置。



#### **意义**

①、为容量规划确定系统和应用程序的极限；

②、为配置测试的参数和配置选项提供参考依据；

③、为验收测试确定系统是否具备自己所宣称的能力；

④、为性能基线的建立提供长期的数据统计来源以及比较基准；



#### **前提**

①、测试目的：明确测试的目的，测试什么？用什么测试方法、策略？

②、测试环境：被测系统的环境是什么，SIT还是UAT活着PAT？

③、测试限制：要执行测试有哪些限制因素，该如何解决？

④、风险因素：测试可能存在哪些风险，解决方案是什么？

⑤、结果分析：对测试结果如何分析？测试产生的数据如何分析、定位？



#### **原则**

①、测试策略：稳定且连续的工作负载，多次运行，看测试结果数据的正态分布趋势，尽量取平均值；

②、数据统计：真实环境下测试数据的平均值、峰值各是多少，取值的维度；

③、差异风险：明确存在哪些风险，风险对测试结果的影响，是否忽略；

④、特殊情况：有哪些特殊情况，是否有对应的解决方案（比如支付场景中的支付服务调用，是否采用挡板等）；

### 3、基准测试的指标

常见的数据库指标包括：

```
TPS/QPS：衡量吞吐量。（TPS：每秒事务处理量(TransactionPerSecond)、每秒查询率QPS是对一个特定的查询服务器在规定时间内所处理流量多少的衡量标准）
响应时间：包括平均响应时间、最小响应时间、最大响应时间、时间百分比等，其中时间百分比参考意义较大，如前95%的请求的最大响应时间。。
并发量：同时处理的查询请求的数量。
123
```

### 4、基准测试的分类

对MySQL的基准测试，有如下两种思路：

（1）针对整个系统的基准测试：通过http请求进行测试，如通过浏览器、APP或postman等测试工具。该方案的优点是能够更好的针对整个系统，测试结果更加准确；缺点是设计复杂实现困难。

（2）只针对MySQL的基准测试：优点和缺点与针对整个系统的测试恰好相反。

在针对MySQL进行基准测试时，一般使用专门的工具进行，例如mysqlslap、sysbench等。其中，sysbench比mysqlslap更通用、更强大，且更适合Innodb（因为模拟了许多Innodb的IO特性）。

### 5、基准测试的策略

1. 针对整个系统的整体测试（集成式）
2. 单独测试MySQL（单组件式）

针对整个系统做集成式测试，而不是单独测试MySQL的原因如下：

- 测试整个应用系统，包括Web服务器、应用代码、网络和数据库是非常有用的，因为用户关注的并不仅仅是MySQL本身的性能，而是应用整体的性能。
- MySQL并非总是应用的瓶颈，通过整体的测试可以揭示这一点。
- 只有对应用做整体测试，才能发现各个部分之间的缓存带来的影响。
- 整体应用的集成式测试更能揭示应用的真实表现，而单独组件的测试很难做到这一点。

针对于以下情况，可以只测试MySQL：

- 需要比较不同的schema或查询的性能
- 针对应用中某个具体问题的测试
- 为了避免漫长的基准测试，可以通过一个短期的基准测试，做到快速的“周期循环”，来检测出某些调整后的效果。

### 6、测试指标

*吞吐量* 单位时间内的事务处理数。（标准测试TPC-C） 这类基准测试主要针对OLTP的吞吐量，适用于多用户的交互式应用。常用的测试单位是每秒事务数（TPS），有些也采用每分钟事务数（TPM）

*响应时间或延迟* 用于测试任务所需的整体时间。根据具体应用，测试的时间单位可能是微秒、毫秒或者分钟。根据不同的时间单位可以计算出平均响应时间、最小响应时间、最大响应时间和所占百分比。 使用图表有助于理解测试结果。

*并发性* 并发性基准测试需要关注的是正在共组哦中的并发操作，或者是同时工作中的线程数或者连接数。当并发性增加时，需要测量吞吐量是否下降，响应时间是否变长。并发性测量完全不同于响应时间的吞吐量。它不像是一个结果，更像是设置基准测试的一种属性。

*可扩展性* 在系统的业务压力可能发生变化的情况下，测试可扩展性就非常必要了。可扩展性是指给系统增加一倍的工作，在理想情况下就能获得两倍的结果。或者说，给系统增加一倍的资源（比如两倍的CPU数），就可以获得两倍的吞吐量。当然，同时性能也必须在可以接受的范围内。（大多数系统是无法做到如此理想的线性扩展的。随着压力的变化，吞吐量和性能都可能越来越差）。

规划基准测试的第一步是提出问题并明确目标，然后决定是采用标准的基准测试还是设计专用的测试。
如果采用标准的基准测试，应该确认了选择合适的测试方案。设计专用的基准测试是很复杂的，往往需要一个迭代的过程。首先需要获得生产数据的数据集快照，并且该快照很容易还原，以便进行后续的测试。

针对数据运行查询，可以建立一个单元测试集是作为初步的测试，并运行多遍。但是这和真实的数据库环境还是有差别的。更好的办法是选择有个代表性的时间段，记录生产系统上的所有查询。如果时间段选得比较小，则可以选择多个时间段。这样有助于覆盖整个系统的活动状态。

可以在不同级别记录查询，可以记录Web服务器上的HTTP请求，也可以打开MySQL的查询日志。

即使不需要创建专用的基准测试，详细地写下测试规则也是必需的。测试可能要多次反复运行，因此需要精确地重现测试过程。测试规划应该记录测试数据、系统配置的步骤、如何测量和分析结果，以及预热的方案等。

应该建立将参数和结果文档化的规范，每一轮测试都必须进行详细记录。需要记住的是，经常要写一些脚本来分析测试结果，因此能够不用打开电子表格或者文本文件等额外操作，当然是更好的。

### 7、基准测试工具

已有的集成式测试工具如下：

- *ab* 是一个Apache HTTP 服务器基准测试工具，它可以测试HTTP服务器每秒最多可以处理多少请求。如果测试的是Web应用服务，这个结果可以转换成整个应用每秒可以满足多少个请求。
- *http_load* 概念上与ab相似，但比ab要更加灵活。可以通过一个输入文件提供多个URL，http_load在这些URL中随机选择进行测试。
- *JMeter* 可以加载其他应用并测试其性能。它虽然是设计用来测试Web应用的，但可以用于测试FTP服务器，或者通过JDBC进行数据库查询测试。

已有的单组件测试工具如下：

- *mysqlslap* 可以模拟服务器的负载，并输出计时信息。如果没有指定SQL语句，mysqlslap会自动生成查询schema的select语句。
- *MYSQL Benchmark Suyite* 可以用于在不同数据库服务器上进行比较测试。它是单线程的，主要用于测试服务器执行查询的速度。结果会显示哪种类型的操作在服务器上执行得更快。
- *Super Smack* 一款用于MySQL和PostgreSQL的基准测试工具，可以提供压力测试和负载生成。可以模拟多用户访问，可以加载测试数据到数据库，并支持使用随机数据填充测试表。
- *Database Test Suite* 一款类似某些工业标准测试的测试工具集。
- *Percona's TPCC-MySQL Tool* 类似于TPC-C的基准测试工具集，其中有部分是专门为MySQL测试开发的。
- *sysbench* 一款多线程系统压测工具。它可以根据影响数据库服务器性能的各种因素来评估系统的性能。

### 8、需要考虑的因素

交易配比：某些业务场景，一个流程包含多个事务，在模拟并发中，不同的事务各自的占比；

突发性的读写操作：某些特殊业务场景，会有短时的大流量冲击或者请求数量骤减，该如何模拟（**浪涌测试**）；

系统配置：不同环境的系统配置不同，测试结果如何换算、如何对比？

测试时长：测试执行过程中，运行多长时间，不同交易运行的时间分配等；

结果展示类型：平均值、峰值、百分比值如何展示，如何对比？

成功/失败占比：每次测试过程中，成功和失败的事务占比统计；

是否可重现：如测试过程中出现报错或某些异常情况，是否可以重现？

是否可对比：是否有其他测试工具或者测试结果进行对比（尽量多次执行测试，进行测试结果对比：**标准方差、正太分布**

### **重点**

**基准测试的工作重点是统计分析：**可以从以下几个维度去进行统计：

①、选择合适的测试工具，设定合理的测试方法以及需要确认的系统性能指标；

②、选择不同的测试工具，对测试结果进行对比，选择稳定且能反应系统真是性能表现的结果；

③、多次执行测试，收集大量的测试数据集和指标；

④、从不同维度解读分析数据，生成报告。