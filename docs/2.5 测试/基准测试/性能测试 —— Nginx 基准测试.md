# 1. æ¦‚è¿°

åŸºæœ¬æ‰€æœ‰çš„æœåŠ¡æ¶æ„ä¸­ï¼ŒNginx éƒ½æ˜¯ä¸å¯æˆ–ç¼ºçš„åŸºç¡€ç»„ä»¶ï¼š

- HTTP è´Ÿè½½å‡è¡¡ï¼Œå°†è¯·æ±‚è½¬å‘åˆ°åç«¯ API æœåŠ¡å™¨ã€‚
- å¥åº·æ£€æŸ¥ï¼Œå°†åç«¯æ— æ³•æœåŠ¡çš„èŠ‚ç‚¹ç§»é™¤ã€‚
- é…ç½® HTTPS ï¼Œå¢å¼ºå®‰å…¨æ€§ã€‚
- é™æ€æœåŠ¡å™¨ï¼Œéšç€å‰åç«¯åˆ†ç¦»ï¼Œå¾ˆå¤šå‰ç«¯ç›´æ¥ä¼šå°† Nginx ä½œä¸ºæœåŠ¡å™¨ã€‚
- åŸºäº Nginx + Lua ç»“åˆçš„è§£å†³æ–¹æ¡ˆ [OpenResty](https://openresty.org/cn/) ï¼Œå¯ä»¥æ„å»ºå‡ºç½‘å…³ç­‰æœåŠ¡ï¼Œä¾‹å¦‚è¯´ [Kong](https://konghq.com/kong/) ã€‚
- TCP æ”¯æŒï¼Œå¯ä»¥è´Ÿè½½å‡è¡¡éœ€è¦é•¿è¿æ¥çš„æœåŠ¡ï¼Œä¾‹å¦‚è¯´ Nettyã€Websocketã€MySQL ç­‰ç­‰ã€‚
- ...

åŸºæœ¬ä¸Šï¼Œæ‰€æœ‰åç«¯çš„æœåŠ¡çš„æ¥å…¥ï¼Œå…¥å£éƒ½æ˜¯ Nginx æˆ–ç»è¿‡ Nginx ï¼Œæ‰€ä»¥å®ƒçš„æ€§èƒ½å°±ä¼šå°¤å…¶é‡è¦ã€‚æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒNginx æ€§èƒ½éå¸¸å¼ºåŠ²ï¼Œé‚£ä¹ˆç©¶ç«Ÿæœ‰å¤šå¼ºå‘¢ï¼Ÿé‚£å°±è®©æˆ‘ä»¬æ¥è¿›è¡Œä¸€æ¬¡ Nginx çš„æ€§èƒ½åŸºå‡†æµ‹è¯•ã€‚

> FROM [ã€Šé«˜æ€§èƒ½ Web æœåŠ¡å™¨ Nginxã€‹](https://www.oschina.net/p/nginx)
>
> Nginx åœ¨å®˜æ–¹æµ‹è¯•çš„ç»“æœä¸­ï¼Œèƒ½å¤Ÿæ”¯æŒäº”ä¸‡ä¸ªå¹³è¡Œè¿æ¥ï¼Œè€Œåœ¨å®é™…çš„è¿ä½œä¸­ï¼Œå¯ä»¥æ”¯æŒäºŒä¸‡è‡³å››ä¸‡ä¸ªå¹³è¡Œé“¾æ¥ã€‚

åœ¨å¼€å§‹åŸºå‡†æµ‹è¯•ä¹‹å‰ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹ Nginx å¤§ä½“çš„æ€§èƒ½è§„æ ¼ï¼Œä»å„å¤§äº‘å‚å•†æä¾›çš„ Nginx äº‘æœåŠ¡ã€‚

> è‰¿è‰¿ï¼šä¸€èˆ¬äº‘æœåŠ¡æä¾›çš„éƒ½æ˜¯ **è´Ÿè½½å‡è¡¡** æœåŠ¡ï¼Œæ‰€ä»¥ä¸ä¸€å®šæ˜¯ Nginx æœåŠ¡ã€‚è¿™é‡Œçš„æ•´ç†ï¼Œæ›´å¤šæ˜¯ä¸ºäº†åšä¸€ä¸ªæ€§èƒ½è§„æ ¼ä¸Šçš„äº†è§£ã€‚ğŸ™‚

- é˜¿é‡Œäº‘ **è´Ÿè½½å‡è¡¡**ï¼šhttps://help.aliyun.com/document_detail/27657.html

- åä¸ºäº‘ **è´Ÿè½½å‡è¡¡**ï¼šæœªæä¾›æ€§èƒ½è§„æ ¼æ–‡æ¡£

- è…¾è®¯äº‘ **è´Ÿè½½å‡è¡¡**ï¼š https://cloud.tencent.com/document/product/214/5983

  > è²Œä¼¼åº•å±‚æ˜¯ Nginx æœåŠ¡ã€‚

- ç™¾åº¦äº‘ **è´Ÿè½½å‡è¡¡**ï¼šæœªæä¾›æ€§èƒ½è§„æ ¼æ–‡æ¡£

- UCloud **è´Ÿè½½å‡è¡¡**ï¼šhttps://docs.ucloud.cn/network/ulb/faq

- ç¾å›¢äº‘ **è´Ÿè½½å‡è¡¡**ï¼šæœªæä¾›æ€§èƒ½è§„æ ¼æ–‡æ¡£

ğŸ˜ˆ çœ‹æ¥ï¼Œæƒ³æ‰¾ä¸ª Nginx çš„æ€§èƒ½è§„æ ¼ä½œä¸ºå‚è€ƒï¼Œå¥½éš¾ã€‚

# 2. æ€§èƒ½æŒ‡æ ‡

é€šè¿‡æˆ‘ä»¬çœ‹å„å¤§å‚å•†æä¾›çš„æŒ‡æ ‡ï¼Œæˆ‘ä»¬ä¸éš¾å‘ç°ï¼Œä¸»è¦æ˜¯ **QPS** ã€‚

# 3. æµ‹è¯•å·¥å…·

å› ä¸ºæˆ‘ä»¬æµ‹è¯• Nginx ï¼Œä¸»è¦æµ‹è¯• HTTP æ¥å£çš„å¤„ç†èƒ½åŠ›ã€‚ç›¸å¯¹æ¥è¯´ï¼ŒHTTP æ¥å£çš„æµ‹è¯•å·¥å…·è¿˜æ˜¯æ¯”è¾ƒå¤šçš„ï¼š

- Wrk
- Apache Benchmark ï¼ˆabï¼‰
- Locust
- Jmeter

åœ¨ç ”ç©¶ Nginx çš„è¿‡ç¨‹ï¼Œçœ‹åˆ° [ã€Šæ€§èƒ½æµ‹è¯•å·¥å…· wrk,ab,locust,Jmeter å‹æµ‹ç»“æœæ¯”è¾ƒã€‹](https://testerhome.com/topics/17068) æ–‡ç« ï¼Œå†™çš„éå¸¸ä¸é”™ï¼Œæ‰€ä»¥æœ¬æ–‡ä¼šå†™çš„æ¯”è¾ƒç®€çŸ­ã€‚æ›´å¤šçš„æ˜¯ï¼Œä½œä¸ºè®°å½•è‡ªå·±æµ‹è¯• Nginx çš„è¿‡ç¨‹ã€‚å› ä¸ºåªå…³æ³¨ QPS çš„æ€§èƒ½æµ‹è¯•ï¼Œæ‰€ä»¥é€‰æ‹©äº† Wrk ä½œä¸ºæµ‹è¯•å·¥å…·ã€‚å¦å¤–ï¼Œåä¸ºäº‘è´Ÿè½½å‡è¡¡çš„æµ‹è¯•ï¼Œä¹Ÿæ˜¯é€‰æ‹© Wrk å˜»å˜»ã€‚

# 4. Wrk

> FROM [ã€Šwrk Githubã€‹](https://github.com/wg/wrk)
>
> wrk is a modern HTTP benchmarking tool capable of generating significant load when run on a single multi-core CPU. It combines a multithreaded design with scalable event notification systems such as epoll and kqueue.

> An optional LuaJIT script can perform HTTP request generation, response processing, and custom reporting. Details are available in SCRIPTING and several examples are located in [scripts/](https://github.com/wg/wrk/tree/master/scripts).

Wrk æ˜¯ä¸€ä¸ªæ¯”è¾ƒå…ˆè¿›çš„ HTTP å‹åŠ›æµ‹è¯•å·¥å…·ï¼Œå¹¶ä¸”æ”¯æŒå¤šæ ¸è¿è¡Œã€‚

## 4.1 æµ‹è¯•ç¯å¢ƒ

- å‹å· ï¼šecs.c5.xlarge

- ç³»ç»Ÿ ï¼šCentOS 7.6 64ä½

- CPU ï¼š4 æ ¸

- å†…å­˜ ï¼š8 GB

- ç£ç›˜ ï¼š40 GB ESSD äº‘ç›˜

- Nginx ï¼š1.9.9

  > ä¸ä¼šå®‰è£… Nginx çš„èƒ–å‹ï¼Œå¯ä»¥å‚è€ƒ [ã€ŠCentOS 7 æºç ç¼–è¯‘å®‰è£… Nginxã€‹](https://www.cnblogs.com/stulzq/p/9291223.html) æ–‡ç« ï¼Œè¿›è¡Œç¼–è¯‘å®‰è£…ã€‚
  >
  > åœ¨ http://nginx.org/download/ ä¸­ï¼Œå¯ä»¥ä¸‹è½½å„ä¸ªç‰ˆæœ¬çš„ Nginx ã€‚

## 4.2 å®‰è£…å·¥å…·

wrk çš„å®‰è£…ï¼Œæˆ‘ä»¬å°†é‡‡ç”¨ç¼–è¯‘å®‰è£…ï¼Œè€Œæºç çš„æ¥æºï¼Œæˆ‘ä»¬å°†ä» Github ä¸­è·å–ã€‚

**1ã€å®‰è£… git**

```
yum install git -y
```

**2ã€å…‹éš† wrk ä»£ç **

```
git clone https://github.com/wg/wrk.git
```

**3ã€å®‰è£… gcc**

```
yum -y install gcc
```

**4ã€ç¼–è¯‘å®‰è£… wrk**

```
cd wrk
make
```

æ—¶é—´ä¼šæ¯”è¾ƒå°±ä¹…ï¼Œè€å¿ƒç­‰å¾…ã€‚

## 4.3 ä½¿ç”¨æŒ‡å—

wrk çš„ä½¿ç”¨éå¸¸ç®€å•ï¼Œåªè¦äº†è§£å®ƒæ¯ä¸ªå‚æ•°çš„ä½œç”¨ï¼Œå°±å¯ä»¥éå¸¸æ–¹ä¾¿çš„æ‰§è¡Œä¸€æ¬¡æ€§èƒ½æµ‹è¯•ã€‚æˆ‘ä»¬æ¥ä¸€èµ·çœ‹çœ‹æœ‰å“ªäº›å‚æ•°ã€‚æ‰§è¡Œ `wrk` å‘½ä»¤ï¼Œè¿”å›å‚æ•°åˆ—è¡¨ï¼š



```
Usage: wrk <options> <url>
  Options:
    -c, --connections <N>  Connections to keep open
    -d, --duration    <T>  Duration of test
    -t, --threads     <N>  Number of threads to use

    -s, --script      <S>  Load Lua script file
    -H, --header      <H>  Add header to request
        --latency          Print latency statistics
        --timeout     <T>  Socket/request timeout
    -v, --version          Print version details

  Numeric arguments may include a SI unit (1k, 1M, 1G)
  Time arguments may include a time unit (2s, 2m, 2h)
```



- `-c` ï¼šéœ€è¦æ¨¡æ‹Ÿçš„è¿æ¥æ•°ã€‚

- `-t` ï¼šå¹¶å‘çš„çº¿ç¨‹æ•°ã€‚

  > è‰¿è‰¿ï¼šè¿™é‡Œè¦æ³¨æ„ä¸‹ï¼Œå› ä¸ºåŒæ—¶æœ‰ `-c` å’Œ `-t` ä¸¤ä¸ªå‚æ•°ï¼Œæ˜¯ä¸æ˜¯æœ‰ç‚¹è´¹è§£ï¼Ÿè¿™é‡Œè¡¨ç¤ºçš„æ˜¯ï¼Œä½¿ç”¨ `-t` ä¸ªçº¿ç¨‹ï¼Œæ¨¡æ‹Ÿ `-c` ä¸ªå¹¶å‘è¯·æ±‚ã€‚wrk ä½¿ç”¨**å¼‚æ­¥éé˜»å¡**çš„ io çš„æ–¹å¼ï¼Œå¹¶ä¸æ˜¯ç”¨çº¿ç¨‹å»æ¨¡æ‹Ÿå¹¶å‘è¿æ¥ï¼Œå› æ­¤ä¸éœ€è¦è®¾ç½®å¾ˆå¤šçš„çº¿ç¨‹ï¼Œä¸€èˆ¬æ ¹æ® CPU çš„æ ¸å¿ƒæ•°é‡è®¾ç½®å³å¯ã€‚

- `-d` ï¼šæµ‹è¯•çš„æµ‹è¯•æ—¶é•¿ã€‚

- `-s` ï¼šæŒ‡å®š Lua è„šæœ¬çš„è·¯å¾„ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸éœ€è¦è¿™ä¸ªå‚æ•°ã€‚

- `--header` ï¼šæŒ‡å®šè¯·æ±‚å¸¦çš„ Header å‚æ•°ã€‚

- `--latency` ï¼šæ˜¯å¦æ‰“å°è¯·æ±‚å»¶è¿Ÿç»Ÿè®¡ã€‚

- `--timeout` ï¼šè®¾ç½®è¯·æ±‚è¶…æ—¶æ—¶é—´ã€‚

- `-v` ï¼šæ˜¾ç¤º wrk ç‰ˆæœ¬ä¿¡æ¯ã€‚

## 4.4 å¿«é€Ÿæµ‹è¯•



```
$ ./wrk -t50 -c400 -d30s http://127.0.0.1
```



- `-t50` å‚æ•°ï¼Œè®¾ç½® 50 å¹¶å‘çº¿ç¨‹ã€‚
- `-c400` å‚æ•°ï¼Œè®¾ç½® 400 è¿æ¥ã€‚
- `-d30s` å‚æ•°ï¼Œè®¾ç½®æ‰§è¡Œ 30s çš„æ—¶é•¿çš„ HTTP è¯·æ±‚ã€‚
- `http://127.0.0.1` å‚æ•°ï¼Œè¯·æ±‚æœ¬åœ°çš„ Nginx æœåŠ¡ã€‚

æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š



```
Running 30s test @ http://127.0.0.1
  50 threads and 400 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    53.49ms  135.94ms   2.00s    87.53%
    Req/Sec     1.26k     0.97k    8.08k    80.95%
  1084727 requests in 30.10s, 0.86GB read
  Socket errors: connect 0, read 85, write 0, timeout 34
Requests/sec:  36038.64
Transfer/sec:     29.18MB
```



- åŸºæœ¬èƒ½è¾¾åˆ° 3W6+ çš„ QPS çš„æ€§èƒ½ï¼Œç¾æ»‹æ»‹ã€‚

## 4.5 æ€§èƒ½ä¼˜åŒ–

èƒ–å‹å¯ä»¥ä½¿ç”¨ Google æœç´¢ Nginx æ€§èƒ½ä¼˜åŒ–ç›¸å…³çš„æ–‡ç« ã€‚è‰¿è‰¿ç›®å‰çœ‹åˆ°è¿˜ä¸é”™çš„æ–‡ç« ï¼š

- [ã€ŠNginx é…ç½®å’Œæ€§èƒ½è°ƒä¼˜ã€‹](https://blog.csdn.net/lamp_yang_3533/article/details/80383039)
- [ã€ŠNginx æ€§èƒ½ä¼˜åŒ–ã€‹](https://zhuanlan.zhihu.com/p/27288422)

ç»è¿‡ä¼˜åŒ–åï¼Œæ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š



```
Running 30s test @ http://127.0.0.1
  50 threads and 400 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     4.44ms    3.96ms 206.30ms   82.96%
    Req/Sec     1.94k   568.42    11.59k    82.31%
  2857342 requests in 30.10s, 2.26GB read
Requests/sec:  94931.16
Transfer/sec:     76.86MB
```



- åŸºæœ¬èƒ½è¾¾åˆ° 9W4+ çš„ QPS çš„æ€§èƒ½ï¼Œèˆ’æœå•Š~

æ¯”è¾ƒå¤§çš„æå‡æ˜¯ï¼Œå› ä¸ºæœºå­æ˜¯ 4C ï¼Œæ‰€ä»¥è®² Nginx çš„ worker_processes ä» 1 æ”¹æˆ 4 ä¹‹åï¼Œæ€§èƒ½ä¸€ä¸‹å­ Double äº†ä¸€ä¸‹ã€‚

ç„¶åï¼Œåˆä¼˜åŒ–ä¸‹ worker_cpu_affinity å‚æ•°ï¼Œç»‘å®š Nginx è¿›ç¨‹åˆ°ä¸åŒçš„ CPU ä¸Šï¼Œåˆæå‡äº†æ¯”è¾ƒå¤§çš„æ€§èƒ½ã€‚