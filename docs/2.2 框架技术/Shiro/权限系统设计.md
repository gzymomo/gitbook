- [权限系统设计](https://juejin.cn/post/6941734947551969288)



## 一、基础概念

### 1、越权访问

权限系统设计的目的是为了将系统使用者对系统的操作约束在一个合法的范围内，系统的使用者不一定是人，也可能是另外一个系统，如果操作不在合法范围内，就会发生**越权访问**行为，**越权访问**会造成非常严重的安全问题，被OWASP列为Web应用十大安全隐患的第二名。**越权访问**主要分为**水平越权**和**垂直越权**两种。

- **垂直越权**

垂直越权是一种权限非法提升的行为，比如说现在有个系统，它的普通用户使用的页面是[xxx.com/user](http://xxx.com/user) , 管理员使用的页面是[xxx.com/manager](http://xxx.com/manager) ,但是后台系统并没有去做权限的控制，我们便可以在登陆之后带着普通用户的令牌直接跳到管理员的页面去做一些不可描述的事情，用一张图简单来描述如下：

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c06f5b17ffe1472d85395ae58df716a8~tplv-k3u1fbpfcp-watermark.image)

即用户通过某种非法手段使自己的可操作范围提升

- **水平越权**

水平越权主要是因为服务端没有判断数据的归属所造成的越权行为，比如说，现在我们登陆了一个系统，进入了查看用户id为1的详细信息的页面，这个页面的url是这样子的：[xxx.com/user/1](http://xxx.com/user/1) ,然后我使个坏，把最后面的1改成了2，这时候由于后端系统没有判断我是否可以查看id为2的用户，就把数据返回给了我。

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2492d54bdb2b49b0a105c08eb9873339~tplv-k3u1fbpfcp-watermark.image)

即基于数据访问设计的漏洞所造成的越权访问。

站在服务端设计的角度我们可以很容易看出来，**垂直越权**指的是访问了不该访问的API，而**水平越权**则是访问到了不该访问的数据，这一点很重要。

### 2、鉴权

**鉴权**指的是在进行一个操作的时候，需要**权限系统**先去判断用户是否具有进行这个操作的权限，在某些复杂场景之下还会包括对请求数据的归属权的校验。

## 二、经典设计模型

在讲模型之前，我们首先要明白权限管控的真正含义是：判断**请求者**在**某些条件**下是否对**请求数据**具备某个**操作（API）**的能力。

```
注意黑体的四个词，1、请求者，2、某些条件，3、请求数据，4、操作（API）
复制代码
```

我们一个一个来解释一下，**请求者**一般来说是用户，也有可能是某个系统，亦或者是一段代码；**某些条件**，有可能是环境条件，比如说某个API只允许10.122.131.1这个ip来访问，或者说只能在晚上访问，或者说只能在周内访问此类；**请求数据**即本次请求要求操作的数据，比如说查看id为1的用户的具体信息；**鉴权（api）** 即对这个数据做的事情，是查看还是还是修改，注意修改其实也包含了删除。

### 1、RBAC（Role Based Access Control）

汉语译为**基于角色的访问控制**，这应该是当今IT系统使用的最多的权限管控模型，用一个图来简单描述如下：

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/196f8119574a4579acd83b6d52950ee6~tplv-k3u1fbpfcp-watermark.image)

上图是一个简单的业务场景中订单操作的相关场景

**角色**即为 **操作（API）** 的聚合 ，**RBAC**通过给用户绑定某个角色，使用户具备了某些操作的能力，这是最简单的RBAC模型，学术上也称为RBAC0，与之对应的还有**RBAC1**、**RBAC2**、**RBAC3**，**RBAC1**是引入了**角色继承**的关系，角色继承很容易理解，即角色B继承了角色A，那么当用户绑定了角色B的时候，也就具备了角色A的操作能力；**RBAC2**是引入了**角色互斥**的关系，比如如果用户绑定了角色A就不能绑定角色B，这是因为考虑到现实世界中如果是运动员就不能是裁判这样的业务场景；**RBAC3**则是结合了**RBAC1**和**RBAC2**的能力，同时拥有角色互斥和角色继承的功能。

在有的权限系统的中，为了方便用户的使用，还衍生出了**权限组**或者是**用户组**的实体模型，**权限组**是一类API的聚合，比如用户操作权限组就可以包含对用户数据的增删查改操作，使用权限组的时候，角色不是和api去绑定，而是去和权限组绑定；**用户组**是将某一类用户分组，这个分组和角色去绑定，而不是用户和角色绑定，这样只要用户加入了这个组，就具备了某些操作权限，现实世界中这个组也有可能是公司部门等实体。

我们可以看出来，在**RBAC**中，不管实体怎么变，**角色（Role）** 的本质其实就是一系列**API操作**的聚合，**通过用户与角色的直接或者间接绑定，使用户具备了某些操作的能力，这也是RBAC的本质**。

### 2、ABAC（Attribute Based Access Control）

ABAC 翻译过来意思是**基于属性的权限访问控制** ，这个模型在如今的云系统中使用的比较多，比如AWS，阿里云，腾讯云，京东云等，它们都是用ABAC来管控IaaS以及PaaS的资源，曾经K8s也使用过这个模型来进行权限管控。

我们上面说过，RBAC的能力可以用这么一句话来描述：一个用户通过和角色绑定，具备了一些对数据操作的能力，往简单的说就是一个用户有了一些对数据操作的能力。但是，如果在复杂的权限管控场景中，RBAC显得有些力不从心，比如说：

- 用户在晚上不能访问这个系统，但是白天可以
- 用户只能在内网对订单具备修改权限，而在外网就只有查看权限
- 用户对2021-03-19日之前创建的订单有操作权限
- 用户只能在深圳进行查看订单，而去了国外就不可以
- 用户在公司内部可以访问所有数据，但是在外部就只能访问公开数据

我们很容易就发现，**RBAC**仅仅描述了**用户**可以做什么**操作**，但是操作的**条件**，以及操作的**数据**，模型本身是没有这些限制的，这也是由于其模型能力的不足所导致的，但这却恰恰是ABAC的长处，ABAC的思想是基于**用户**、以及将要访问的**数据的属性**、以及各种**环境因素**去动态计算用户是否有权限进行操作。我们先简单介绍一下NIST ABAC设计指引中的一些术语:

- **subject** 指的是系统的使用者，可以是用户(user),也可以是其他非服务的个体(non-person entity，NPE)
- **object** 泛指被访问的数据
- **operation/action** 指操作行为，一般对应系统中的API
- **policy** 访问策略，它规定了一个用户在什么条件下可以对哪些数据做什么，是ABAC系统核心实体之一
- **pdp** pdp是policy decision point，策略点，其实我理解这玩意就是一个policy的展示出来的形式而已
- **pep** pep是policy enforcement point,策略执行点，简单说就是根据policy来鉴权
- **acm** acm是access control mechanism,权限管控机制，一般来说就是权限系统本身
- **attribute** 它泛指各种属性，可以是subject的，也可以是object的
- **condition** 各种额外的限制条件

NIST的文章中，下图描述了上面术语之间的关系:

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5fe95216d4f74b0c947fec5304b9802b~tplv-k3u1fbpfcp-watermark.image)

很容易发现，ABAC仅仅受限于可以用来计算的属性的数量，这也很容易让很多人产生误解，误认为ABAC什么类型的权限都可以来管控，事实上，权限系统仅仅擅长于管控垂直越权，即使ABAC具备一定的管控水平越权的能力，也不要妄想可以用它来管控所有的水平越权。

```
这一点放在其他方面的系统设计中也是被证明的，那就是从来没有哪个方案亦或者是架构设计能成为无所不能的银弹。
复制代码
```

其他模型还有LBAC，IBAC，NGAC等，这里不再做介绍，读者可以自行了解

本篇仅仅做基础概念讲解，下一篇将会去和业界已存在的ABAC系统做对比，讲一讲京东北极星商业操作系统在ABAC方面的实践。

参考文章：

1、[ABAC - 复杂场景下访问控制解决之道](https://www.jianshu.com/p/e596f3b5d53e)

2、[亚马逊云AWS权限策略文档](https://docs.amazonaws.cn/IAM/latest/UserGuide/reference_policies_elements_action.html)

3、[阿里云RAM权限策略文档](https://help.aliyun.com/document_detail/93732.html?spm=a2c4g.11186623.6.595.342b4bbeTombHZ)

4、[NIST对ABAC设计的一些指导性思考](https://nvlpubs.nist.gov/nistpubs/specialpublications/NIST.SP.800-162.pdf)

5、[AWS高级工程师讲解ABAC](https://www.youtube.com/watch?v=Iq_hDc385t4&t=2378s)

6、[NIST对NGAC的一些指导性思考](https://tsapps.nist.gov/publication/get_pdf.cfm?pub_id=922332)

7、[NGAC的一个实现案例](https://github.com/PM-Master)

8、[xacml(IBM对于ABAC的实现)文档](https://www.axiomatics.com/blog/understanding-xacml-combining-algorithms/)