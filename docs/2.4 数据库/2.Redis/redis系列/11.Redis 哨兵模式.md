[Redis 哨兵模式](https://www.cnblogs.com/yjh1995/p/14164129.html)

## 哨兵模式

哨兵模式(Sentinel)机制**。如果主服务器挂了，我们可以将从服务器**升级为主服务器，等到旧的主服务器(挂掉的那个)重连上来，会将它(挂掉的主服务器)变成从服务器

- 一个或者多个哨兵Sentinel**不停地监控**Redis主从服务器是否正常工作
- 如果某个Redis实例有故障，那么哨兵负责**发送消息通知**管理员
- 如果主服务器挂掉了，会**自动**将从服务器提升为主服务器(包括配置都会修改)
- Sentinel可以作为**配置中心**，能够提供当前主服务器的信息

### 主观下线

哨兵(Sentinel)节点会每秒一次的频率向建立了命令连接的实例发送PING命令，如果在`down-after-milliseconds`毫秒内没有做出有效响应包括(PONG/LOADING/MASTERDOWN)以外的响应，哨兵就会将该实例在本结构体中的状态标记为`SRI_S_DOWN`主观下线

### 客观下线

当一个哨兵节点发现主节点处于主观下线状态时，会向其他的哨兵节点发出询问，该节点是不是已经主观下线了。如果超过配置参数`quorum`个节点认为是主观下线时，该哨兵节点就会将自己维护的结构体中该主节点标记为`SRI_O_DOWN`客观下线 询问命令`SENTINEL is-master-down-by-addr`

**搭建哨兵模式**

所谓的哨兵模式，其实并不复杂，我们还是在我们前面的基础上来搭建哨兵模式。假设现在我的master是6379，两个从机分别是6380和6381，两个从机都是从6379上复制数据。先按照上文的步骤，我们配置好一主二仆，然后在redis目录下打开sentinel.conf文件，做如下配置：

```
sentinel monitor mymaster 127.0.0.1 6379 1
```

其中mymaster是给要监控的主机取的名字，随意取，后面是主机地址，最后面的2表示有多少个sentinel认为主机挂掉了，就进行切换（我这里只有一个，因此设置为1）。好了，配置完成后，输入如下命令启动哨兵：

```
redis-sentinel sentinel.conf
```

然后启动我们的一主二仆架构，启动成功后，关闭master，观察哨兵窗口输出的日志，

6379挂掉之后，redis内部重新举行了选举，6380重新上位。此时，如果6379重启，也不再是扛把子了，只能屈身做一个slave了。

## 注意问题

由于所有的写操作都是先在Master上操作，然后同步更新到Slave上，所以从Master同步到Slave机器有一定的延迟，当系统很繁忙的时候，延迟问题会更加严重，Slave机器数量的增加也会使这个问题更加严重。