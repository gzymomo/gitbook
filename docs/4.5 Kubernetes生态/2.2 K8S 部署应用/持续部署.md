## 1. æ¦‚å¿µ

### 1.1. åŸºäºKubernetsç”Ÿæ€çš„é—­ç¯

Kubernetsé›†ç¾¤çš„ç›®æ ‡æ˜¯ä¸ºäº†æ„å»ºä¸€å¥—Paaså¹³å°ï¼š

- ä»£ç æäº¤ï¼šå¼€å‘å°†ä»£ç æäº¤åˆ°Gitä»“åº“
- æŒç»­é›†æˆï¼šé€šè¿‡æµæ°´çº¿å°†å¼€å‘æäº¤çš„ä»£ç å…‹éš†ã€ç¼–è¯‘ã€æ„å»ºé•œåƒå¹¶æ¨åˆ°dockeré•œåƒä»“åº“
- æŒç»­éƒ¨ç½²ï¼šé€šè¿‡æµæ°´çº¿é…ç½®Kubernetesä¸­Podæ§åˆ¶å™¨ã€serviceå’Œingressç­‰ï¼Œå°†dockeré•œåƒéƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
- ç”Ÿäº§å‘å¸ƒï¼šé€šè¿‡æµæ°´çº¿é…ç½®Kubernetesä¸­Podæ§åˆ¶å™¨ã€serviceå’Œingressç­‰ï¼Œå°†é€šè¿‡æµ‹è¯•çš„dockeré•œåƒéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

æ¶‰åŠåˆ°çš„åŠŸèƒ½ç»„ä»¶ï¼š

- æŒç»­é›†æˆç”¨Jenkinså®ç°
- æŒç»­éƒ¨ç½²ç”¨Spinnakerå®ç°
- æœåŠ¡é…ç½®ä¸­å¿ƒç”¨Apolloå®ç°
- ç›‘æ§ç”¨Prometheus+Grafanaå®ç°
- æ—¥å¿—æ”¶é›†ç”¨ELKå®ç°
- é€šè¿‡å¤–æŒ‚å­˜å‚¨æ–¹å¼å®ç°æ•°æ®æŒä¹…åŒ–ï¼Œç”šè‡³å¯ä»¥é€šè¿‡StoargeClassé…åˆPVå’ŒPVCæ¥å®ç°è‡ªåŠ¨åˆ†é…å’ŒæŒ‚ç›˜
- æ•°æ®åº“å±äºæœ‰çŠ¶æ€çš„æœåŠ¡ï¼Œä¸€èˆ¬ä¸ä¼šæ”¾å¤§Kubernetsé›†ç¾¤ä¸­

### 1.2. Spinnaker

Spinnaker([https://www.spinnaker.io](https://www.spinnaker.io/))æ˜¯ä¸€ä¸ªå¼€æºå¤šäº‘æŒç»­äº¤ä»˜çš„å¹³å°ï¼Œä¸»è¦æä¾›äº†ä¸¤ä¸ªåŠŸèƒ½ï¼š

#### 1.2.1. åº”ç”¨ç®¡ç†

Spinnakerä½¿ç”¨åº”ç”¨ç¨‹åºç®¡ç†åŠŸ(Application management)èƒ½æ¥æŸ¥çœ‹å’Œç®¡ç†æ‚¨çš„äº‘èµ„æºï¼Œå¸¸æ¶‰åŠåˆ°çš„äº‘èµ„æºæœ‰ Azureã€AWSã€Kubernetesç­‰ï¼Œä¸æ”¯æŒå›½å†…é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ã€‚

Applications, clusters, server groupsæ˜¯Spinnakerç”¨æ¥æè¿°æœåŠ¡çš„å…³é”®æ¦‚å¿µã€‚Load balancers and firewalls æè¿°äº†æ‚¨çš„æœåŠ¡å¦‚ä½•å‘ç”¨æˆ·å…¬å¼€ã€‚

#### 1.2.2. åº”ç”¨éƒ¨ç½²

åº”ç”¨éƒ¨ç½²ä¸­æ ¸å¿ƒåŠŸèƒ½æœ‰ä¸¤ä¸ªï¼Œæµæ°´çº¿å’Œéƒ¨ç½²ç­–ç•¥ã€‚æµæ°´çº¿å°†CIå’ŒCDè¿‡ç¨‹ä¸²è”èµ·æ¥ï¼Œæ¯ä¸ªé¡¹ç›®æ„å»ºä¸€ä¸ªæµæ°´çº¿ï¼Œé€šè¿‡ä¼ é€’å˜åŒ–çš„å‚æ•°(æœåŠ¡åã€ç‰ˆæœ¬å·ã€é•œåƒæ ‡ç­¾ç­‰)ï¼Œè°ƒç”¨Jenkinsä¸­æŒç»­é›†æˆæµæ°´çº¿å®Œæˆæ„å»ºï¼Œå†é€šè¿‡æå‰éƒ¨ç½²æ–¹å¼(å¦‚kubernetesä¸­deployment/service/ingress)æ–¹å¼æ¥å°†æ„å»ºå¥½çš„é•œåƒå‘å¸ƒåˆ°æŒ‡å®šçš„ç¯å¢ƒä¸­ã€‚éƒ¨ç½²ç­–ç•¥æ˜¯åœ¨é€šè¿‡æµ‹è¯•ç¯å¢ƒæµ‹è¯•ä¹‹åï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„å‡çº§ç­–ç•¥ï¼Œå¸¸ç”¨çš„æœ‰è“ç»¿å‘å¸ƒã€é‡‘ä¸é›€å‘å¸ƒã€æ»šåŠ¨å‘å¸ƒã€‚

![image](https://cdn.nlark.com/yuque/0/2020/png/378176/1581823770935-a174e069-38ca-4a9c-9501-ce7235e7b99b.png?x-oss-process=image%2Fresize%2Cw_1500)

![image](https://cdn.nlark.com/yuque/0/2020/png/378176/1581823743264-9c4bcf13-73bc-456e-8e56-e33e91435f7a.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_10%2Ctext_TGludXgt5rih5rih6bif%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10%2Fresize%2Cw_1500)

### 1.3. Spinnakerçš„å¸¸ç”¨ç»„ä»¶

#### 1.3.1. ç»„ä»¶

- Deck: åŸºäºæµè§ˆå™¨çš„UIç•Œé¢
- Gate: å³Apigatewayï¼ŒUIå’Œæ‰€æœ‰apiè°ƒç”¨ç¨‹åºéƒ½é€šè¿‡Gateä¸Spinnakerè¿›è¡Œé€šä¿¡
- Orca: ç¼–æ’å¼•æ“
- Clouddrive: æ“çºµäº‘ç¯å¢ƒèµ„æºçš„é©±åŠ¨
- Front50: ç”¨äºæŒä¹…ä¿å­˜åº”ç”¨ç¨‹åºï¼Œç®¡é“ï¼Œé¡¹ç›®å’Œé€šçŸ¥çš„å…ƒæ•°æ®ï¼Œå­˜æ”¾åœ¨æ¡¶ä¸­ã€‚æœ¬å®éªŒé‡‡ç”¨Minioå­˜å‚¨(ç±»ä¼¼s3)
- Rosoc: ä¸ºäº‘å‚å•†æä¾›VMé•œåƒæˆ–è€…é•œåƒæ¨¡æ¿ï¼ŒKubernetesé›†ç¾¤ä¸­ä¸æ¶‰åŠ
- Igor: æä¾›æµæ°´çº¿æ„å»º
- Echo: å®ƒæ”¯æŒå‘é€é€šçŸ¥ï¼ˆä¾‹å¦‚ï¼ŒSlackï¼Œç”µå­é‚®ä»¶ï¼ŒSMSï¼‰ï¼Œå¹¶å¤„ç†æ¥è‡ªGithubä¹‹ç±»çš„æœåŠ¡ä¸­ä¼ å…¥çš„Webhookã€‚
- Fiat: æä¾›ç”¨æˆ·è®¤è¯ï¼Œæœ¬å®éªŒæœªæ¶‰åŠï¼ŒåæœŸå¯ä»¥è€ƒè™‘ä½¿ç”¨
- Kayenta: æä¾›é‡‘ä¸é›€éƒ¨ç½²åˆ†æçš„ï¼Œæœ¬å®éªŒæœªæ¶‰åŠ
- Halyard: æä¾›spinnakeré›†ç¾¤éƒ¨ç½²ã€å‡çº§å’Œé…ç½®çš„ï¼Œæœ¬å®éªŒæœªæ¶‰åŠ

#### 1.3.2. æ¶æ„å›¾

![image.png](https://cdn.nlark.com/yuque/0/2020/png/378176/1581824188222-99c79d90-aa98-46fb-9f60-8db0142e3218.png)

![image.png](https://cdn.nlark.com/yuque/0/2020/png/378176/1581825199802-aba3e4eb-67c2-4b73-966e-9fad750d7ac8.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_10%2Ctext_TGludXgt5rih5rih6bif%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

## 2. éƒ¨ç½²Spinnaker

### 2.1. éƒ¨ç½²Minio

#### 2.1.1. å‡†å¤‡é•œåƒ

```
[root@hdss7-200 ~]# docker pull minio/minio:latest
[root@hdss7-200 ~]# docker image tag minio/minio:latest harbor.od.com/public/minio:latest
[root@hdss7-200 ~]# docker image push harbor.od.com/public/minio:latest
```

#### 2.1.2. å‡†å¤‡èµ„æºé…ç½®æ¸…å•

```
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    name: minio
  name: minio
  namespace: armory
spec:
  replicas: 1
  selector:
    matchLabels:
      name: minio
  template:
    metadata:
      labels:
        app: minio
        name: minio
    spec:
      containers:
      - name: minio
        image: harbor.od.com/public/minio:latest
        ports:
        - containerPort: 9000
          protocol: TCP
        args:
        - server
        - /data
        env:
        - name: MINIO_ACCESS_KEY
          value: duduniao
        - name: MINIO_SECRET_KEY
          value: duduniao12345
        readinessProbe:
          failureThreshold: 3
          httpGet:
            path: /minio/health/ready
            port: 9000
            scheme: HTTP
          initialDelaySeconds: 10
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 5
        volumeMounts:
        - mountPath: /data
          name: data
      volumes:
      - nfs:
          server: hdss7-200
          path: /data/nfs-volume/minio
        name: data
```



```
apiVersion: v1
kind: Service
metadata:
  name: minio
  namespace: armory
spec:
  ports:
  - port: 80
    protocol: TCP
    targetPort: 9000
  selector:
    app: minio
```



```
apiVersion: extensions/v1beta1
kind: Ingress
metadata: 
  name: minio
  namespace: armory
spec:
  rules:
  - host: minio.od.com
    http:
      paths:
      - path: /
        backend: 
          serviceName: minio
          servicePort: 80
```

#### 2.1.3. äº¤ä»˜minioåˆ°k8s

```
[root@hdss7-200 ~]# mkdir /data/nfs-volume/minio  # åˆ›å»ºå¾…å…±äº«çš„ç›®å½•
[root@hdss7-21 ~]# kubectl create namespace armory
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/devops/armory/minio/deployment.yaml
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/devops/armory/minio/service.yaml
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/devops/armory/minio/ingress.yaml

[root@hdss7-11 ~]# vim /var/named/od.com.zone 
......
minio              A    10.4.7.10
[root@hdss7-11 ~]# systemctl restart named
[root@hdss7-11 ~]# host minio.od.com
minio.od.com has address 10.4.7.10
```

![image.png](https://cdn.nlark.com/yuque/0/2020/png/378176/1581735505879-f1aa740d-6b9d-4fb0-bd6d-b8bab960bc4b.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_10%2Ctext_TGludXgt5rih5rih6bif%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

### 2.2. éƒ¨ç½²redis

Spinnakerä¸­çš„redisä»…ä»…æ˜¯èµ·åˆ°ç¼“å­˜ä½œç”¨ï¼Œå¯¹Spinnakerçš„ä½œç”¨ä¸æ˜¯å¾ˆå¤§ï¼Œå³ä½¿å®•æœºé‡å¯ä¹Ÿé—®é¢˜ä¸å¤§ï¼Œä¸”å¹¶å‘å°ã€‚åŸºäºå½“å‰æœ‰é™çš„èµ„æºæ¡ä»¶ä¸‹ï¼Œè€ƒè™‘ä½¿ç”¨å•ä¸ªå‰¯æœ¬éæŒä¹…åŒ–çš„æ–¹å¼éƒ¨ç½²redisã€‚å¦‚æœéœ€è¦æŒä¹…åŒ–ï¼Œåœ¨å¯åŠ¨å®¹å™¨æ—¶ï¼ŒæŒ‡å®šcommandå’Œargsï¼Œå¦‚æ”¹ä¸ºï¼š /usr/local/bin/redis-server /etc/myredis.conf 

#### 2.2.1. å‡†å¤‡é•œåƒ

```
# æ¨èä½¿ç”¨4.xç‰ˆæœ¬ï¼Œé«˜ç‰ˆæœ¬çš„åœ¨spinnakerä¸­æ˜¯å¦é€‚æš‚ä¸æ¸…æ¥š
[root@hdss7-200 ~]# docker image pull redis:4.0.14
[root@hdss7-200 ~]# docker image tag redis:4.0.14 harbor.od.com/public/redis:v4.0.14
[root@hdss7-200 ~]# docker image push harbor.od.com/public/redis:v4.0.14
```

#### 2.2.2. å‡†å¤‡èµ„æºé…ç½®æ¸…å•

```
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    name: redis
  name: redis
  namespace: armory
spec:
  replicas: 1
  selector:
    matchLabels:
      name: redis
  template:
    metadata:
      labels:
        app: redis
        name: redis
    spec:
      containers:
      - name: redis
        image: harbor.od.com/public/redis:v4.0.14
        ports:
        - containerPort: 6379
          protocol: TCP
```



```
apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: armory
spec:
  ports:
  - port: 6379
    protocol: TCP
    targetPort: 6379
  selector:
    app: redis
```

#### 2.2.3. åº”ç”¨èµ„æºé…ç½®æ¸…å•

```
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/devops/armory/redis/depolyment.yaml
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/devops/armory/redis/service.yaml

[root@hdss7-21 ~]# kubectl get pod -n armory -o wide
NAME                     READY   STATUS    RESTARTS   AGE     IP           NODE                NOMINATED NODE   READINESS GATES
minio-6cb7db494b-hjqvh   1/1     Running   0          33m     172.7.22.5   hdss7-22.host.com   <none>           <none>
redis-5886797648-mxjbm   1/1     Running   0          7m57s   172.7.22.6   hdss7-22.host.com   <none>           <none>
[root@hdss7-21 ~]# telnet 172.7.22.6 6379 
Trying 172.7.22.6...
Connected to 172.7.22.6.
Escape character is '^]'.
^]
telnet> quit
Connection closed.
[root@hdss7-21 ~]# kubectl get svc -n armory -o wide
NAME    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE     SELECTOR
minio   ClusterIP   192.168.139.95   <none>        80/TCP     33m     app=minio
redis   ClusterIP   192.168.70.230   <none>        6379/TCP   8m16s   app=redis
[root@hdss7-21 ~]# telnet 192.168.70.230 6379
Trying 192.168.70.230...
Connected to 192.168.70.230.
Escape character is '^]'.
^]
telnet> quit
```

### 2.3. éƒ¨ç½²Spinnaker-clouddrive

#### 2.3.1. å‡†å¤‡é•œåƒ

```
# å½“å‰ç‰ˆæœ¬çš„é•œåƒæ¯”è¾ƒè€ï¼Œå¯ä»¥è€ƒè™‘æ–°ç‰ˆæœ¬è¿›è¡Œå°è¯•
[root@hdss7-200 ~]# docker pull armory/spinnaker-clouddriver-slim:release-1.8.x-14c9664
[root@hdss7-200 ~]# docker image tag armory/spinnaker-clouddriver-slim:release-1.8.x-14c9664 harbor.od.com/public/spinnaker-clouddriver-slim:v1.8.x-14c9664
[root@hdss7-200 ~]# docker image push harbor.od.com/public/spinnaker-clouddriver-slim:v1.8.x-14c9664
```

#### 2.3.2. åˆ¶ä½œsecret

```
[root@hdss7-21 ~]# cat minio-login.secret  # minio è´¦å·å¯†ç ï¼ŒåæœŸä¼šæŒ‚è½½åˆ°spinnakrä¸­
[default]
aws_access_key_id=duduniao
aws_secret_access_key=duduniao12345
[root@hdss7-21 ~]# kubectl create secret generic credentials --from-file=credentials=minio-login.secret -n armory
```

#### 2.3.3. åˆ¶ä½œkube-configæ–‡ä»¶



```
# ç­¾å‘è¯ä¹¦ï¼Œæ³¨æ„CNå’Œç”¨æˆ·åä¸€è‡´
[root@hdss7-200 certs]# cat spinnaker-csr.json 
{
    "CN": "spinnake",
    "hosts": [
    "10.4.7.10"
    ],
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "names": [
        {
            "C": "CN",
            "ST": "beijing",
            "L": "beijing",
            "O": "od",
            "OU": "ops"
        }
    ]
}
[root@hdss7-200 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client spinnake-csr.json | cfssl-json -bare spinnake
[root@hdss7-200 certs]# ls spinnake* -l
-rw-r--r-- 1 root root 1037 Feb 15 13:58 spinnake.csr
-rw-r--r-- 1 root root  296 Feb 15 13:58 spinnake-csr.json
-rw------- 1 root root 1675 Feb 15 13:58 spinnake-key.pem
-rw-r--r-- 1 root root 1391 Feb 15 13:58 spinnake.pem
[root@hdss7-200 certs]# scp spinnake* ca.pem hdss7-21:~/spinnaker/
```



```
# kube-configæ–‡ä»¶ä¹Ÿæ˜¯ç”¨äºé€šè¿‡apiserveræ¥æ“ä½œk8sé›†ç¾¤åˆ›å»ºèµ„æºä½¿ç”¨ï¼Œä¸€èˆ¬ç»™äºˆcluster-adminæƒé™
[root@hdss7-21 spinnaker]# kubectl config set-cluster myk8s --certificate-authority=ca.pem --embed-certs=true --server=https://10.4.7.10:7443 --kubeconfig=config
[root@hdss7-21 spinnaker]# kubectl config set-credentials spinnake --client-certificate=spinnake.pem --client-key=spinnake-key.pem --embed-certs=true --kubeconfig=config
[root@hdss7-21 spinnaker]# kubectl config set-context myk8s-context --cluster=myk8s --user=spinnake --kubeconfig=config
[root@hdss7-21 spinnaker]# kubectl config use-context myk8s-context --kubeconfig=config
[root@hdss7-21 spinnaker]# kubectl create clusterrolebinding spinnake --clusterrole=cluster-admin --user=spinnake

# æµ‹è¯•kube-configæ˜¯å¦å¯ä»¥ç”¨ï¼Œæ³¨æ„ï¼šdashboradåªèƒ½ç”¨service accountç™»é™†
[root@hdss7-200 ~]# scp hdss7-21:~/spinnaker/config /tmp/
[root@hdss7-200 ~]# kubectl get pod -n armory --kubeconfig=/tmp/config
NAME                     READY   STATUS    RESTARTS   AGE
minio-6cb7db494b-hjqvh   1/1     Running   0          3h23m
redis-5886797648-mxjbm   1/1     Running   0          178m
[root@hdss7-200 ~]# rm -f /tmp/config
```



```
# åˆ›å»ºconfigmapé…ç½®ï¼Œspinnakerå°†kube-configæ–‡ä»¶æŒ‚è½½åˆ°å®¹å™¨ä¸­ä½¿ç”¨
[root@hdss7-21 spinnaker]# kubectl create configmap default-kubeconfig --from-file=default-kubeconfig=config -n armory
[root@hdss7-21 ~]# rm -fr spinnaker
```

#### 2.3.4. èµ„æºé…ç½®æ¸…å•

Spinnaker çš„é…ç½®æ¯”è¾ƒç¹çï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªdefault-config.yamlçš„configmapéå¸¸å¤æ‚ï¼Œä¸€èˆ¬ä¸éœ€è¦ä¿®æ”¹ï¼š

[ğŸ“default-config.yaml](https://www.yuque.com/attachments/yuque/0/2020/yaml/378176/1581750848952-968abccc-303c-4ebd-a9fa-7447018290e1.yaml)

```
# init-env.yaml
# åŒ…æ‹¬redisåœ°å€ã€å¯¹å¤–çš„APIæ¥å£åŸŸåç­‰
apiVersion: v1
kind: ConfigMap
metadata:
  name: init-env
  namespace: armory
data:
  API_HOST: http://spinnaker.od.com/api
  ARMORY_ID: c02f0781-92f5-4e80-86db-0ba8fe7b8544
  ARMORYSPINNAKER_CONF_STORE_BUCKET: armory-platform
  ARMORYSPINNAKER_CONF_STORE_PREFIX: front50
  ARMORYSPINNAKER_GCS_ENABLED: "false"
  ARMORYSPINNAKER_S3_ENABLED: "true"
  AUTH_ENABLED: "false"
  AWS_REGION: us-east-1
  BASE_IP: 127.0.0.1
  CLOUDDRIVER_OPTS: -Dspring.profiles.active=armory,configurator,local
  CONFIGURATOR_ENABLED: "false"
  DECK_HOST: http://spinnaker.od.com
  ECHO_OPTS: -Dspring.profiles.active=armory,configurator,local
  GATE_OPTS: -Dspring.profiles.active=armory,configurator,local
  IGOR_OPTS: -Dspring.profiles.active=armory,configurator,local
  PLATFORM_ARCHITECTURE: k8s
  REDIS_HOST: redis://redis:6379
  SERVER_ADDRESS: 0.0.0.0
  SPINNAKER_AWS_DEFAULT_REGION: us-east-1
  SPINNAKER_AWS_ENABLED: "false"
  SPINNAKER_CONFIG_DIR: /home/spinnaker/config
  SPINNAKER_GOOGLE_PROJECT_CREDENTIALS_PATH: ""
  SPINNAKER_HOME: /home/spinnaker
  SPRING_PROFILES_ACTIVE: armory,configurator,local
```



```
# custom-config.yaml
# è¯¥é…ç½®æ–‡ä»¶æŒ‡å®šè®¿é—®k8sã€harborã€minioã€Jenkinsçš„è®¿é—®æ–¹å¼
# å…¶ä¸­éƒ¨åˆ†åœ°å€å¯ä»¥æ ¹æ®æ˜¯å¦åœ¨k8så†…éƒ¨ï¼Œå’Œæ˜¯å¦åŒä¸€ä¸ªåç§°ç©ºé—´æ¥é€‰æ‹©æ˜¯å¦ä½¿ç”¨çŸ­åŸŸå
apiVersion: v1
kind: ConfigMap
metadata:
  name: custom-config
  namespace: armory
data:
  clouddriver-local.yml: |
    kubernetes:
      enabled: true
      accounts:
        - name: spinnake
          serviceAccount: false
          dockerRegistries:
            - accountName: harbor
              namespace: []
          namespaces:
            - dev
            - fat
            - pro
          kubeconfigFile: /opt/spinnaker/credentials/custom/default-kubeconfig
      primaryAccount: spinnake
    dockerRegistry:
      enabled: true
      accounts:
        - name: harbor
          requiredGroupMembership: []
          providerVersion: V1
          insecureRegistry: true
          address: http://harbor.od.com
          username: admin
          password: Harbor12345
      primaryAccount: harbor
    artifacts:
      s3:
        enabled: true
        accounts:
        - name: armory-config-s3-account
          apiEndpoint: http://minio
          apiRegion: us-east-1
      gcs:
        enabled: false
        accounts:
        - name: armory-config-gcs-account
  custom-config.json: ""
  echo-configurator.yml: |
    diagnostics:
      enabled: true
  front50-local.yml: |
    spinnaker:
      s3:
        endpoint: http://minio
  igor-local.yml: |
    jenkins:
      enabled: true
      masters:
        - name: jenkins-admin
          address: http://jenkins.infra
          username: admin
          password: admin123
      primaryAccount: jenkins-admin
  nginx.conf: |
    gzip on;
    gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript application/vnd.ms-fontobject application/x-font-ttf font/opentype image/svg+xml image/x-icon;

    server {
           listen 80;

           location / {
                proxy_pass http://armory-deck/;
           }

           location /api/ {
                proxy_pass http://armory-gate:8084/;
           }

           rewrite ^/login(.*)$ /api/login$1 last;
           rewrite ^/auth(.*)$ /api/auth$1 last;
    }
  spinnaker-local.yml: |
    services:
      igor:
        enabled: true
```



```
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: armory-clouddriver
  name: armory-clouddriver
  namespace: armory
spec:
  replicas: 1
  selector:
    matchLabels:
      app: armory-clouddriver
  template:
    metadata:
      annotations:
        artifact.spinnaker.io/location: '"armory"'
        artifact.spinnaker.io/name: '"armory-clouddriver"'
        artifact.spinnaker.io/type: '"kubernetes/deployment"'
        moniker.spinnaker.io/application: '"armory"'
        moniker.spinnaker.io/cluster: '"clouddriver"'
      labels:
        app: armory-clouddriver
    spec:
      containers:
      - name: armory-clouddriver
        image: harbor.od.com/public/spinnaker-clouddriver-slim:v1.8.x-14c9664
        command:
        - bash
        - -c
        args:
        # è„šæœ¬åœ¨default-config.yamlä¸­
        - bash /opt/spinnaker/config/default/fetch.sh && cd /home/spinnaker/config
          && /opt/clouddriver/bin/clouddriver
        ports:
        - containerPort: 7002
          protocol: TCP
        env:
        - name: JAVA_OPTS
          # ç”Ÿäº§ä¸­è°ƒå¤§åˆ°2048-4096M
          value: -Xmx1024M
        envFrom:
        - configMapRef:
            name: init-env
        livenessProbe:
          failureThreshold: 5
          httpGet:
            path: /health
            port: 7002
            scheme: HTTP
          initialDelaySeconds: 600
          periodSeconds: 3
          successThreshold: 1
          timeoutSeconds: 1
        readinessProbe:
          failureThreshold: 5
          httpGet:
            path: /health
            port: 7002
            scheme: HTTP
          initialDelaySeconds: 180
          periodSeconds: 3
          successThreshold: 5
          timeoutSeconds: 1
        securityContext: 
          runAsUser: 0
        volumeMounts:
        - mountPath: /etc/podinfo
          name: podinfo
        - mountPath: /home/spinnaker/.aws
          name: credentials
        - mountPath: /opt/spinnaker/credentials/custom
          name: default-kubeconfig
        - mountPath: /opt/spinnaker/config/default
          name: default-config
        - mountPath: /opt/spinnaker/config/custom
          name: custom-config
      volumes:
      - configMap:
          defaultMode: 420
          name: default-kubeconfig
        name: default-kubeconfig
      - configMap:
          defaultMode: 420
          name: custom-config
        name: custom-config
      - configMap:
          defaultMode: 420
          name: default-config
        name: default-config
      - name: credentials
        secret:
          defaultMode: 420
          secretName: credentials
      - downwardAPI:
          defaultMode: 420
          items:
          - fieldRef:
              apiVersion: v1
              fieldPath: metadata.labels
            path: labels
          - fieldRef:
              apiVersion: v1
              fieldPath: metadata.annotations
            path: annotations
        name: podinfo
```



```
apiVersion: v1
kind: Service
metadata:
  name: armory-clouddriver
  namespace: armory
spec:
  ports:
  - port: 7002
    protocol: TCP
    targetPort: 7002
  selector:
    app: armory-clouddriver
```

#### 2.3.5. åº”ç”¨èµ„æºé…ç½®æ¸…å•

```
[root@hdss7-21 spinnaker]# kubectl apply -f http://k8s-yaml.od.com/devops/armory/spinnake/init-env.yaml
[root@hdss7-21 spinnaker]# kubectl apply -f http://k8s-yaml.od.com/devops/armory/spinnake/custon-config.yaml
[root@hdss7-21 spinnaker]# kubectl apply -f http://k8s-yaml.od.com/devops/armory/spinnake/default-config.yaml
[root@hdss7-21 spinnaker]# kubectl apply -f http://k8s-yaml.od.com/devops/armory/spinnake/deployment.yaml
[root@hdss7-21 spinnaker]# kubectl apply -f http://k8s-yaml.od.com/devops/armory/spinnake/service.yaml
```



```
[root@hdss7-21 spinnaker]# kubectl get svc -n armory | grep armory-clouddriver
armory-clouddriver   ClusterIP   192.168.109.209   <none>        7002/TCP   11m
[root@hdss7-21 spinnaker]# kubectl get pod -n armory -o wide
NAME                                  READY   STATUS    RESTARTS   AGE     IP           NODE                NOMINATED NODE   READINESS GATES
armory-clouddriver-5f8b5f4cbb-2qfgf   1/1     Running   0          8m1s    172.7.21.5   hdss7-21.host.com   <none>           <none>

# é€šè¿‡curlæµ‹è¯•ï¼Œå‘ç°ä¸€ä¸ªç°è±¡ï¼šé€šè¿‡podçš„IPæˆ–è€…serviceçš„åŸŸåéƒ½å¯ä»¥è®¿é—®healthï¼Œä½†æ˜¯é€šè¿‡svcçš„IPå´ä¸è¡Œ
[root@hdss7-21 spinnaker]# curl 172.7.21.5:7002/health
{"status":"UP","kubernetes":{"status":"UP"},"redisHealth":{"status":"UP","maxIdle":100,"minIdle":25,"numActive":0,"numIdle":4,"numWaiters":0},"dockerRegistry":{"status":"UP"},"diskSpace":{"status":"UP","total":53659832320,"free":43917455360,"threshold":10485760}}[root@hdss7-21 spinnake]# 

[root@hdss7-21 spinnaker]# kubectl exec minio-6cb7db494b-hjqvh -n armory -- curl -s armory-clouddriver:7002/health
{"status":"UP","kubernetes":{"status":"UP"},"redisHealth":{"status":"UP","maxIdle":100,"minIdle":25,"numActive":0,"numIdle":4,"numWaiters":0},"dockerRegistry":{"status":"UP"},"diskSpace":{"status":"UP","total":53659832320,"free":43917455360,"threshold":10485760}}
```

### 2.4. éƒ¨ç½²front50

#### 2.4.1. å‡†å¤‡é•œåƒ

```
[root@hdss7-200 ~]# docker pull armory/spinnaker-front50-slim:release-1.8.x-93febf2
[root@hdss7-200 ~]# docker image tag armory/spinnaker-front50-slim:release-1.8.x-93febf2 harbor.od.com/public/spinnaker-front50-slim:v1.8.x-93febf2
[root@hdss7-200 ~]# docker image push harbor.od.com/public/spinnaker-front50-slim:v1.8.x-93febf2
```

#### 2.4.2. å‡†å¤‡èµ„æºé…ç½®æ¸…å•

```
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: armory-front50
  name: armory-front50
  namespace: armory
spec:
  replicas: 1
  selector:
    matchLabels:
      app: armory-front50
  template:
    metadata:
      annotations:
        artifact.spinnaker.io/location: '"armory"'
        artifact.spinnaker.io/name: '"armory-front50"'
        artifact.spinnaker.io/type: '"kubernetes/deployment"'
        moniker.spinnaker.io/application: '"armory"'
        moniker.spinnaker.io/cluster: '"front50"'
      labels:
        app: armory-front50
    spec:
      containers:
      - name: armory-front50
        image: harbor.od.com/public/spinnaker-front50-slim:v1.8.x-93febf2
        command:
        - bash
        - -c
        args:
        - bash /opt/spinnaker/config/default/fetch.sh && cd /home/spinnaker/config
          && /opt/front50/bin/front50
        ports:
        - containerPort: 8080
          protocol: TCP
        env:
        - name: JAVA_OPTS
          # ç”Ÿäº§ä¸­ç»™å¤§ä¸€äº›ï¼Œæœ¬å®éªŒä¸€å¼€å§‹ç»™äº†512Mï¼Œå¯åŠ¨åè¿è¡Œä¸€ä¼šå°±å®•äº†
          value: -javaagent:/opt/front50/lib/jamm-0.2.5.jar -Xmx1024M
        envFrom:
        - configMapRef:
            name: init-env
        livenessProbe:
          failureThreshold: 3
          httpGet:
            path: /health
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 600
          periodSeconds: 3
          successThreshold: 1
          timeoutSeconds: 1
        readinessProbe:
          failureThreshold: 3
          httpGet:
            path: /health
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 180
          periodSeconds: 5
          successThreshold: 8
          timeoutSeconds: 1
        volumeMounts:
        - mountPath: /etc/podinfo
          name: podinfo
        - mountPath: /home/spinnaker/.aws
          name: credentials
        - mountPath: /opt/spinnaker/config/default
          name: default-config
        - mountPath: /opt/spinnaker/config/custom
          name: custom-config
      volumes:
      - configMap:
          defaultMode: 420
          name: custom-config
        name: custom-config
      - configMap:
          defaultMode: 420
          name: default-config
        name: default-config
      - name: credentials
        secret:
          defaultMode: 420
          secretName: credentials
      - downwardAPI:
          defaultMode: 420
          items:
          - fieldRef:
              apiVersion: v1
              fieldPath: metadata.labels
            path: labels
          - fieldRef:
              apiVersion: v1
              fieldPath: metadata.annotations
            path: annotations
        name: podinfo
```



```
apiVersion: v1
kind: Service
metadata:
  name: armory-front50
  namespace: armory
spec:
  ports:
  - port: 8080
    protocol: TCP
    targetPort: 8080
  selector:
    app: armory-front50
```

#### 2.4.2. åº”ç”¨èµ„æºé…ç½®æ¸…å•

```
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/devops/armory/front50/deployment.yaml
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/devops/armory/front50/service.yaml
```



```
[root@hdss7-21 ~]# kubectl exec minio-6cb7db494b-hjqvh -n armory -- curl -s 'http://armory-front50:8080/health'
{"status":"UP"}
```



![image.png](https://cdn.nlark.com/yuque/0/2020/png/378176/1581754777565-8344736c-cddc-4b4a-b9c0-f5f337dbeb62.png)

### 2.5. éƒ¨ç½²Orca

#### 2.5.1. å‡†å¤‡é•œåƒ

```
[root@hdss7-200 ~]# docker pull armory/spinnaker-orca-slim:release-1.8.x-de4ab55
[root@hdss7-200 ~]# docker image tag armory/spinnaker-orca-slim:release-1.8.x-de4ab55 harbor.od.com/public/spinnaker-orca-slim:v1.8.x-de4ab55
[root@hdss7-200 ~]# docker image push harbor.od.com/public/spinnaker-orca-slim:v1.8.x-de4ab55
```

#### 2.5.2. å‡†å¤‡èµ„æºé…ç½®æ¸…å•

```
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: armory-orca
  name: armory-orca
  namespace: armory
spec:
  replicas: 1
  selector:
    matchLabels:
      app: armory-orca
  template:
    metadata:
      annotations:
        artifact.spinnaker.io/location: '"armory"'
        artifact.spinnaker.io/name: '"armory-orca"'
        artifact.spinnaker.io/type: '"kubernetes/deployment"'
        moniker.spinnaker.io/application: '"armory"'
        moniker.spinnaker.io/cluster: '"orca"'
      labels:
        app: armory-orca
    spec:
      containers:
      - name: armory-orca
        image: harbor.od.com/public/spinnaker-orca-slim:v1.8.x-de4ab55
        command:
        - bash
        - -c
        args:
        - bash /opt/spinnaker/config/default/fetch.sh && cd /home/spinnaker/config
          && /opt/orca/bin/orca
        ports:
        - containerPort: 8083
          protocol: TCP
        env:
        - name: JAVA_OPTS
          value: -Xmx512M
        envFrom:
        - configMapRef:
            name: init-env
        livenessProbe:
          failureThreshold: 5
          httpGet:
            path: /health
            port: 8083
            scheme: HTTP
          initialDelaySeconds: 600
          periodSeconds: 5
          successThreshold: 1
          timeoutSeconds: 1
        readinessProbe:
          failureThreshold: 3
          httpGet:
            path: /health
            port: 8083
            scheme: HTTP
          initialDelaySeconds: 180
          periodSeconds: 3
          successThreshold: 5
          timeoutSeconds: 1
        volumeMounts:
        - mountPath: /etc/podinfo
          name: podinfo
        - mountPath: /opt/spinnaker/config/default
          name: default-config
        - mountPath: /opt/spinnaker/config/custom
          name: custom-config
      volumes:
      - configMap:
          defaultMode: 420
          name: custom-config
        name: custom-config
      - configMap:
          defaultMode: 420
          name: default-config
        name: default-config
      - downwardAPI:
          defaultMode: 420
          items:
          - fieldRef:
              apiVersion: v1
              fieldPath: metadata.labels
            path: labels
          - fieldRef:
              apiVersion: v1
              fieldPath: metadata.annotations
            path: annotations
        name: podinfo
```



```
apiVersion: v1
kind: Service
metadata:
  name: armory-orca
  namespace: armory
spec:
  ports:
  - port: 8083
    protocol: TCP
    targetPort: 8083
  selector:
    app: armory-orca
```

#### 2.5.3. åº”ç”¨èµ„æºé…ç½®æ¸…å•

```
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/devops/armory/orca/deployment.yaml
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/devops/armory/orca/service.yaml
[root@hdss7-21 ~]# kubectl exec minio-6cb7db494b-hjqvh -n armory -- curl -s 'http://armory-orca:8083/health'
{"status":"UP"}
```

### 2.6. éƒ¨ç½²Echo

#### 2.6.1. å‡†å¤‡é•œåƒ

```
[root@hdss7-200 ~]# docker pull armory/echo-armory:c36d576-release-1.8.x-617c567
[root@hdss7-200 ~]# docker image tag armory/echo-armory:c36d576-release-1.8.x-617c567 harbor.od.com/public/echo-armory:v1.8.x-617c567
[root@hdss7-200 ~]# docker image push harbor.od.com/public/echo-armory:v1.8.x-617c567
```

#### 2.6.2. å‡†å¤‡èµ„æºé…ç½®æ¸…å•

```
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: armory-echo
  name: armory-echo
  namespace: armory
spec:
  replicas: 1
  selector:
    matchLabels:
      app: armory-echo
  template:
    metadata:
      annotations:
        artifact.spinnaker.io/location: '"armory"'
        artifact.spinnaker.io/name: '"armory-echo"'
        artifact.spinnaker.io/type: '"kubernetes/deployment"'
        moniker.spinnaker.io/application: '"armory"'
        moniker.spinnaker.io/cluster: '"echo"'
      labels:
        app: armory-echo
    spec:
      containers:
      - name: armory-echo
        image: harbor.od.com/public/echo-armory:v1.8.x-617c567
        command:
        - bash
        - -c
        args:
        - bash /opt/spinnaker/config/default/fetch.sh && cd /home/spinnaker/config
          && /opt/echo/bin/echo
        ports:
        - containerPort: 8089
          protocol: TCP
        env:
        - name: JAVA_OPTS
          value: -javaagent:/opt/echo/lib/jamm-0.2.5.jar -Xmx512M
        envFrom:
        - configMapRef:
            name: init-env
        livenessProbe:
          failureThreshold: 3
          httpGet:
            path: /health
            port: 8089
            scheme: HTTP
          initialDelaySeconds: 600
          periodSeconds: 3
          successThreshold: 1
          timeoutSeconds: 1
        readinessProbe:
          failureThreshold: 3
          httpGet:
            path: /health
            port: 8089
            scheme: HTTP
          initialDelaySeconds: 180
          periodSeconds: 3
          successThreshold: 5
          timeoutSeconds: 1
        volumeMounts:
        - mountPath: /etc/podinfo
          name: podinfo
        - mountPath: /opt/spinnaker/config/default
          name: default-config
        - mountPath: /opt/spinnaker/config/custom
          name: custom-config
      imagePullSecrets:
      - name: harbor
      volumes:
      - configMap:
          defaultMode: 420
          name: custom-config
        name: custom-config
      - configMap:
          defaultMode: 420
          name: default-config
        name: default-config
      - downwardAPI:
          defaultMode: 420
          items:
          - fieldRef:
              apiVersion: v1
              fieldPath: metadata.labels
            path: labels
          - fieldRef:
              apiVersion: v1
              fieldPath: metadata.annotations
            path: annotations
        name: podinfo
```



```
apiVersion: v1
kind: Service
metadata:
  name: armory-echo
  namespace: armory
spec:
  ports:
  - port: 8089
    protocol: TCP
    targetPort: 8089
  selector:
    app: armory-echo
```

#### 2.6.3. åº”ç”¨èµ„æºé…ç½®æ¸…å•

```
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/devops/armory/echo/deployment.yaml
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/devops/armory/echo/service.yaml

[root@hdss7-21 ~]# kubectl exec minio-6cb7db494b-hjqvh -n armory -- curl -s 'http://armory-echo:8089/health'
{"status":"UP"}
```

### 2.7. éƒ¨ç½²igor

#### 2.7.1. é•œåƒå‡†å¤‡

```
[root@hdss7-200 ~]# docker image pull armory/spinnaker-igor-slim:release-1.8-x-new-install-healthy-ae2b329
[root@hdss7-200 ~]# docker image tag armory/spinnaker-igor-slim:release-1.8-x-new-install-healthy-ae2b329 harbor.od.com/public/igor:v1.8-x-ae2b329
[root@hdss7-200 ~]# docker image push harbor.od.com/public/igor:v1.8-x-ae2b329
```

#### 2.7.2. å‡†å¤‡èµ„æºé…ç½®æ¸…å•

```
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: armory-igor
  name: armory-igor
  namespace: armory
spec:
  replicas: 1
  selector:
    matchLabels:
      app: armory-igor
  template:
    metadata:
      annotations:
        artifact.spinnaker.io/location: '"armory"'
        artifact.spinnaker.io/name: '"armory-igor"'
        artifact.spinnaker.io/type: '"kubernetes/deployment"'
        moniker.spinnaker.io/application: '"armory"'
        moniker.spinnaker.io/cluster: '"igor"'
      labels:
        app: armory-igor
    spec:
      containers:
      - name: armory-igor
        image: harbor.od.com/public/igor:v1.8-x-ae2b329
        command:
        - bash
        - -c
        args:
        - bash /opt/spinnaker/config/default/fetch.sh && cd /home/spinnaker/config
          && /opt/igor/bin/igor
        ports:
        - containerPort: 8088
          protocol: TCP
        env:
        - name: IGOR_PORT_MAPPING
          value: -8088:8088
        - name: JAVA_OPTS
          value: -Xmx512M
        envFrom:
        - configMapRef:
            name: init-env
        livenessProbe:
          failureThreshold: 3
          httpGet:
            path: /health
            port: 8088
            scheme: HTTP
          initialDelaySeconds: 600
          periodSeconds: 3
          successThreshold: 1
          timeoutSeconds: 1
        readinessProbe:
          failureThreshold: 3
          httpGet:
            path: /health
            port: 8088
            scheme: HTTP
          initialDelaySeconds: 180
          periodSeconds: 5
          successThreshold: 5
          timeoutSeconds: 1
        volumeMounts:
        - mountPath: /etc/podinfo
          name: podinfo
        - mountPath: /opt/spinnaker/config/default
          name: default-config
        - mountPath: /opt/spinnaker/config/custom
          name: custom-config
      securityContext:
        runAsUser: 0
      volumes:
      - configMap:
          defaultMode: 420
          name: custom-config
        name: custom-config
      - configMap:
          defaultMode: 420
          name: default-config
        name: default-config
      - downwardAPI:
          defaultMode: 420
          items:
          - fieldRef:
              apiVersion: v1
              fieldPath: metadata.labels
            path: labels
          - fieldRef:
              apiVersion: v1
              fieldPath: metadata.annotations
            path: annotations
        name: podinfo
```



```
apiVersion: v1
kind: Service
metadata:
  name: armory-igor
  namespace: armory
spec:
  ports:
  - port: 8088
    protocol: TCP
    targetPort: 8088
  selector:
    app: armory-igor
```

#### 2.7.3. åº”ç”¨èµ„æºé…ç½®æ¸…å•

```
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/devops/armory/igor/deployment.yaml
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/devops/armory/igor/service.yaml
[root@hdss7-21 ~]# kubectl exec minio-6cb7db494b-hjqvh -n armory -- curl -s 'http://armory-igor:8088/health'
{"status":"UP"}
```

### 2.8. éƒ¨ç½²gate

#### 2.8.1. å‡†å¤‡é•œåƒ

```
[root@hdss7-200 ~]# docker pull armory/gate-armory:dfafe73-release-1.8.x-5d505ca
[root@hdss7-200 ~]# docker image tag armory/gate-armory:dfafe73-release-1.8.x-5d505ca harbor.od.com/public/gate-armory:v1.8.x-5d505ca
[root@hdss7-200 ~]# docker image push harbor.od.com/public/gate-armory:v1.8.x-5d505ca
```

#### 2.8.2. å‡†å¤‡èµ„æºé…ç½®æ¸…å•

```
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: armory-gate
  name: armory-gate
  namespace: armory
spec:
  replicas: 1
  selector:
    matchLabels:
      app: armory-gate
  template:
    metadata:
      annotations:
        artifact.spinnaker.io/location: '"armory"'
        artifact.spinnaker.io/name: '"armory-gate"'
        artifact.spinnaker.io/type: '"kubernetes/deployment"'
        moniker.spinnaker.io/application: '"armory"'
        moniker.spinnaker.io/cluster: '"gate"'
      labels:
        app: armory-gate
    spec:
      containers:
      - name: armory-gate
        image: harbor.od.com/public/gate-armory:v1.8.x-5d505ca
        command:
        - bash
        - -c
        args:
        - bash /opt/spinnaker/config/default/fetch.sh gate && cd /home/spinnaker/config
          && /opt/gate/bin/gate
        ports:
        - containerPort: 8084
          name: gate-port
          protocol: TCP
        - containerPort: 8085
          name: gate-api-port
          protocol: TCP
        env:
        - name: GATE_PORT_MAPPING
          value: -8084:8084
        - name: GATE_API_PORT_MAPPING
          value: -8085:8085
        - name: JAVA_OPTS
          value: -Xmx512M
        envFrom:
        - configMapRef:
            name: init-env
        livenessProbe:
          exec:
            command:
            - /bin/bash
            - -c
            - wget -O - http://localhost:8084/health || wget -O - https://localhost:8084/health
          failureThreshold: 5
          initialDelaySeconds: 600
          periodSeconds: 5
          successThreshold: 1
          timeoutSeconds: 1
        readinessProbe:
          exec:
            command:
            - /bin/bash
            - -c
            - wget -O - http://localhost:8084/health?checkDownstreamServices=true&downstreamServices=true
              || wget -O - https://localhost:8084/health?checkDownstreamServices=true&downstreamServices=true
          failureThreshold: 3
          initialDelaySeconds: 180
          periodSeconds: 5
          successThreshold: 10
          timeoutSeconds: 1
        volumeMounts:
        - mountPath: /etc/podinfo
          name: podinfo
        - mountPath: /opt/spinnaker/config/default
          name: default-config
        - mountPath: /opt/spinnaker/config/custom
          name: custom-config
      volumes:
      - configMap:
          defaultMode: 420
          name: custom-config
        name: custom-config
      - configMap:
          defaultMode: 420
          name: default-config
        name: default-config
      - downwardAPI:
          defaultMode: 420
          items:
          - fieldRef:
              apiVersion: v1
              fieldPath: metadata.labels
            path: labels
          - fieldRef:
              apiVersion: v1
              fieldPath: metadata.annotations
            path: annotations
        name: podinfo
```



```
apiVersion: v1
kind: Service
metadata:
  name: armory-gate
  namespace: armory
spec:
  ports:
  - name: gate-port
    port: 8084
    protocol: TCP
    targetPort: 8084
  - name: gate-api-port
    port: 8085
    protocol: TCP
    targetPort: 8085
  selector:
    app: armory-gate
```

#### 2.8.3. åº”ç”¨èµ„æºé…æ¸…å•

```
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/devops/armory/gate/deployment.yaml
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/devops/armory/gate/service.yaml

[root@hdss7-21 ~]# kubectl exec minio-6cb7db494b-hjqvh -n armory -- curl -s 'http://armory-gate:8084/health?checkDownstreamServices=true&downstreamServices=true'
{"status":"UP"}
```

### 2.9. éƒ¨ç½²deck

#### 2.9.1. å‡†å¤‡é•œåƒ

```
[root@hdss7-200 ~]# docker image pull armory/deck-armory:d4bf0cf-release-1.8.x-0a33f94
[root@hdss7-200 ~]# docker image tag armory/deck-armory:d4bf0cf-release-1.8.x-0a33f94 harbor.od.com/public/deck-armory:v1.8.x-0a33f94
[root@hdss7-200 ~]# docker image push harbor.od.com/public/deck-armory:v1.8.x-0a33f94
```

#### 2.9.2. å‡†å¤‡èµ„æºé…ç½®æ¸…å•

```
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: armory-deck
  name: armory-deck
  namespace: armory
spec:
  replicas: 1
  selector:
    matchLabels:
      app: armory-deck
  template:
    metadata:
      annotations:
        artifact.spinnaker.io/location: '"armory"'
        artifact.spinnaker.io/name: '"armory-deck"'
        artifact.spinnaker.io/type: '"kubernetes/deployment"'
        moniker.spinnaker.io/application: '"armory"'
        moniker.spinnaker.io/cluster: '"deck"'
      labels:
        app: armory-deck
    spec:
      containers:
      - name: armory-deck
        image: harbor.od.com/public/deck-armory:v1.8.x-0a33f94
        command:
        - bash
        - -c
        args:
        - bash /opt/spinnaker/config/default/fetch.sh && /entrypoint.sh
        ports:
        - containerPort: 9000
          protocol: TCP
        envFrom:
        - configMapRef:
            name: init-env
        livenessProbe:
          failureThreshold: 3
          httpGet:
            path: /
            port: 9000
            scheme: HTTP
          initialDelaySeconds: 180
          periodSeconds: 3
          successThreshold: 1
          timeoutSeconds: 1
        readinessProbe:
          failureThreshold: 5
          httpGet:
            path: /
            port: 9000
            scheme: HTTP
          initialDelaySeconds: 30
          periodSeconds: 3
          successThreshold: 5
          timeoutSeconds: 1
        volumeMounts:
        - mountPath: /etc/podinfo
          name: podinfo
        - mountPath: /opt/spinnaker/config/default
          name: default-config
        - mountPath: /opt/spinnaker/config/custom
          name: custom-config
      volumes:
      - configMap:
          defaultMode: 420
          name: custom-config
        name: custom-config
      - configMap:
          defaultMode: 420
          name: default-config
        name: default-config
      - downwardAPI:
          defaultMode: 420
          items:
          - fieldRef:
              apiVersion: v1
              fieldPath: metadata.labels
            path: labels
          - fieldRef:
              apiVersion: v1
              fieldPath: metadata.annotations
            path: annotations
        name: podinfo
```



```
apiVersion: v1
kind: Service
metadata:
  name: armory-deck
  namespace: armory
spec:
  ports:
  - port: 80
    protocol: TCP
    targetPort: 9000
  selector:
    app: armory-deck
```

#### 2.9.3. åº”ç”¨èµ„æºé…ç½®æ¸…å•

```
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/devops/armory/deck/deployment.yaml
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/devops/armory/deck/service.yaml
[root@hdss7-21 ~]# kubectl exec minio-6cb7db494b-hjqvh -n armory -- curl -Is 'http://armory-deck'
HTTP/1.1 200 OK
Server: nginx/1.4.6 (Ubuntu)
Date: Sat, 15 Feb 2020 10:07:24 GMT
Content-Type: text/html
Content-Length: 22031
Last-Modified: Tue, 17 Jul 2018 17:42:20 GMT
Connection: keep-alive
ETag: "5b4e2a7c-560f"
Accept-Ranges: bytes
```

### 2.10. éƒ¨ç½²Nginx

#### 2.10.1. å‡†å¤‡é•œåƒ

```
[root@hdss7-200 ~]# docker image pull nginx:1.12.2
[root@hdss7-200 ~]# docker image tag nginx:1.12.2 harbor.od.com/public/nginx:v1.12.2
[root@hdss7-200 ~]# docker image push harbor.od.com/public/nginx:v1.12.2
```

#### 2.10.2. å‡†å¤‡èµ„æºé…ç½®æ¸…å•

```
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: armory-nginx
  name: armory-nginx
  namespace: armory
spec:
  replicas: 1
  selector:
    matchLabels:
      app: armory-nginx
  template:
    metadata:
      annotations:
        artifact.spinnaker.io/location: '"armory"'
        artifact.spinnaker.io/name: '"armory-nginx"'
        artifact.spinnaker.io/type: '"kubernetes/deployment"'
        moniker.spinnaker.io/application: '"armory"'
        moniker.spinnaker.io/cluster: '"nginx"'
      labels:
        app: armory-nginx
    spec:
      containers:
      - name: armory-nginx
        image: harbor.od.com/public/nginx:v1.12.2
        command:
        - bash
        - -c
        args:
        - bash /opt/spinnaker/config/default/fetch.sh nginx && nginx -g 'daemon off;'
        ports:
        - containerPort: 80
          name: http
          protocol: TCP
        - containerPort: 443
          name: https
          protocol: TCP
        - containerPort: 8085
          name: api
          protocol: TCP
        livenessProbe:
          failureThreshold: 3
          httpGet:
            path: /
            port: 80
            scheme: HTTP
          initialDelaySeconds: 180
          periodSeconds: 3
          successThreshold: 1
          timeoutSeconds: 1
        readinessProbe:
          failureThreshold: 3
          httpGet:
            path: /
            port: 80
            scheme: HTTP
          initialDelaySeconds: 30
          periodSeconds: 3
          successThreshold: 5
          timeoutSeconds: 1
        volumeMounts:
        - mountPath: /opt/spinnaker/config/default
          name: default-config
        - mountPath: /etc/nginx/conf.d
          name: custom-config
      volumes:
      - configMap:
          defaultMode: 420
          name: custom-config
        name: custom-config
      - configMap:
          defaultMode: 420
          name: default-config
        name: default-config
```



```
apiVersion: v1
kind: Service
metadata:
  name: armory-nginx
  namespace: armory
spec:
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: 80
  - name: https
    port: 443
    protocol: TCP
    targetPort: 443
  - name: api
    port: 8085
    protocol: TCP
    targetPort: 8085
  selector:
    app: armory-nginx
```



```
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  labels:
    app: spinnaker
    web: spinnaker.od.com
  name: armory-nginx
  namespace: armory
spec:
  rules:
  - host: spinnaker.od.com
    http:
      paths:
      - backend:
          serviceName: armory-nginx
          servicePort: 80
```

#### 2.10.3. åº”ç”¨èµ„æºé…ç½®æ¸…å•

```
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/devops/armory/nginx/deployment.yaml
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/devops/armory/nginx/service.yaml
[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/devops/armory/nginx/ingress.yaml
```



![image.png](https://cdn.nlark.com/yuque/0/2020/png/378176/1581761844123-ee97f3c7-9374-4ea2-99d7-82bc160b4272.png?x-oss-process=image%2Fresize%2Cw_1500)



## 3. Spinnakerçš„ä½¿ç”¨

### 3.1. Spinnakeråˆ›å»ºåº”ç”¨é›†

ä¸ºäº†æ–¹ä¾¿ï¼Œå¯åŠ¨FATç¯å¢ƒä¸­Apolloï¼Œå¹¶åˆ é™¤FATç¯å¢ƒä¸­çš„ dubbo-demo æä¾›è€…å’Œæ¶ˆè´¹è€…æœåŠ¡çš„èµ„æºé…ç½®æ¸…å•ï¼Œå°è¯•é€šè¿‡Spinnakerå®ç°ä»æ„å»ºåˆ°å‘å¸ƒçš„å®Œæ•´æµç¨‹ã€‚

#### 3.1.1. åˆ›å»ºåº”ç”¨é›†

![image.png](https://cdn.nlark.com/yuque/0/2020/png/378176/1581855110732-ad8b41b8-3749-4d9e-91de-00062d55fe2b.png?x-oss-process=image%2Fresize%2Cw_1500)

![image.png](https://cdn.nlark.com/yuque/0/2020/png/378176/1581860824553-ab775c59-980a-44bb-95b5-d65bcca3b5c8.png)

#### 3.1.2. åˆ›å»ºservice

![image.png](https://cdn.nlark.com/yuque/0/2020/png/378176/1581861406953-c5a9c770-a831-4ed9-95cf-9425dcf02dd1.png?x-oss-process=image%2Fresize%2Cw_1500)

![image.png](https://cdn.nlark.com/yuque/0/2020/png/378176/1581866126446-0ff8c467-73ef-4301-9927-7bef5d4b429e.png)

#### 3.1.3. åˆ›å»ºingress

![image.png](https://cdn.nlark.com/yuque/0/2020/png/378176/1581861843759-8edd8a6d-eedc-4aa5-b3ed-aa124084847b.png)

#### 3.1.4. åˆ›å»ºPipeline

![image.png](https://cdn.nlark.com/yuque/0/2020/png/378176/1581861964375-5263dc8e-44fa-481d-a05e-1ef68e4fd29f.png)

![image.png](https://cdn.nlark.com/yuque/0/2020/png/378176/1581862005091-64e24fa8-d280-4bcd-a2c4-685872a54d09.png)

![image.png](https://cdn.nlark.com/yuque/0/2020/png/378176/1581862105840-05e6c1e6-4052-44fe-af87-5b967d726f8f.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_10%2Ctext_TGludXgt5rih5rih6bif%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

```
# å¢åŠ ä»¥ä¸‹å››ä¸ªå‚æ•°ï¼Œæœ¬æ¬¡ç¼–è¯‘å’Œå‘å¸ƒ dubbo-demo-serviceï¼Œå› æ­¤é»˜è®¤çš„é¡¹ç›®åç§°å’Œé•œåƒåç§°æ˜¯åŸºæœ¬ç¡®å®šçš„
1.  name: app_name
    required: true
    default: dubbo-demo-service
    description: é¡¹ç›®åœ¨Gitä»“åº“åç§° 
    
2.  name: git_ver
    required: true
    description: é¡¹ç›®çš„ç‰ˆæœ¬æˆ–è€…commit IDæˆ–è€…åˆ†æ”¯ 
    
3.  image_name
    required: true
    default: app/dubbo-demo-service
    description: é•œåƒåç§°ï¼Œä»“åº“/image
    
4.  name: add_tag
    required: true
    description: æ ‡ç­¾çš„ä¸€éƒ¨åˆ†ï¼Œè¿½åŠ åœ¨git_veråé¢ï¼Œä½¿ç”¨YYYYmmdd_HHMM
```

#### 3.1.5. åˆ›å»ºJenkinsæ„å»ºæ­¥éª¤

å¦‚æœåœ¨æµ‹è¯•ç¯å¢ƒä¸­ï¼ŒJenkinsä¸€èˆ¬æ˜¯æµæ°´çº¿çš„ä¸€éƒ¨åˆ†ï¼Œè€Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä¸€èˆ¬è·³è¿‡Jenkinsè¿™ä¸ªæ­¥éª¤ã€‚

![image.png](https://cdn.nlark.com/yuque/0/2020/png/378176/1581862615321-00600bb1-4b05-4699-932d-de7e19cb2460.png)

![image.png](https://cdn.nlark.com/yuque/0/2020/png/378176/1581862824928-f6f2a88d-1e50-4868-b56e-fd77d46c69ef.png)

![image.png](https://cdn.nlark.com/yuque/0/2020/png/378176/1581863620567-92c66d06-8e3f-4a35-a574-d5d2610ab6e9.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_10%2Ctext_TGludXgt5rih5rih6bif%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10%2Fresize%2Cw_1500)



```
# å¯¹jsonä¸­ä»¥ä¸‹éƒ¨åˆ†å†…å®¹è¿›è¡Œè°ƒæ•´æœªå˜é‡æ ¼å¼
"imageId": "harbor.od.com/${parameters.image_name}:${parameters.git_ver}_${parameters.add_tag}",
"registry": "harbor.od.com",
"repository": "${parameters.image_name}",
"tag": "${parameters.git_ver}_${parameters.add_tag}"
```

![image.png](https://cdn.nlark.com/yuque/0/2020/png/378176/1581863952935-50cdf44a-2f47-4f7f-a450-9b76df925ddc.png)

#### 3.1.6. æ‰§è¡Œæµæ°´çº¿

![image.png](https://cdn.nlark.com/yuque/0/2020/png/378176/1581864097932-9fb98d32-eef5-41da-9079-4ac2461aaca5.png)

![image.png](https://cdn.nlark.com/yuque/0/2020/png/378176/1581864228932-10022174-130d-4004-9e21-d04b1ded4338.png)

![image.png](https://cdn.nlark.com/yuque/0/2020/png/378176/1581864577698-ac15fdcb-2de9-4e79-a60f-3007958fab61.png)

#### 3.1.7. å„ä¸ªèµ„æºåç§°

![image.png](https://cdn.nlark.com/yuque/0/2020/png/378176/1581866155149-8612c426-74dc-48d4-88b4-ca757e5de057.png)

```
[root@hdss7-22 ~]# kubectl get all -n fat | grep devops|grep -v '^$'
pod/fatdevops--dubbo-demo-service-v001-v97fh   1/1     Running   0          14m
pod/fatdevops--dubbo-demo-web-v000-rz758       1/1     Running   0          4m31s
service/fatdevops--demo-web    ClusterIP   192.168.148.45   <none>        80/TCP    75m
deployment.apps/fatdevops--dubbo-demo-service   1/1     1            1           28m
deployment.apps/fatdevops--dubbo-demo-web       1/1     1            1           4m31s
replicaset.apps/fatdevops--dubbo-demo-service-v000   0         0         0       28m
replicaset.apps/fatdevops--dubbo-demo-service-v001   1         1         1       14m
replicaset.apps/fatdevops--dubbo-demo-web-v000       1         1         1       4m32
```



### 3.2. é—ç•™é—®é¢˜

- Spinnakerçš„è´¦å·è®¤è¯ç³»ç»Ÿå¦‚ä½•å®ç°ï¼Ÿ
- å½“å‰ç°åº¦å‘å¸ƒã€é‡‘ä¸é›€å‘å¸ƒã€è“ç»¿å‘å¸ƒå¦‚ä½•å®ç°ï¼Ÿ