[kubernetes é«˜å¯ç”¨éƒ¨ç½²å·¥å…·ï¼šsealos](https://fuckcloudnative.io/posts/sealos/)



sealos é¡¹ç›®åœ°å€ï¼šhttps://github.com/fanux/sealos

æœ¬é¡¹ç›®åå« sealosï¼Œæ—¨åœ¨åšä¸€ä¸ªç®€å•å¹²å‡€è½»é‡çº§ç¨³å®šçš„ kubernetes å®‰è£…å·¥å…·ï¼Œèƒ½å¾ˆå¥½çš„æ”¯æŒé«˜å¯ç”¨å®‰è£…ã€‚ å…¶å®æŠŠä¸€ä¸ªä¸œè¥¿åšçš„åŠŸèƒ½å¼ºå¤§å¹¶ä¸éš¾ï¼Œä½†æ˜¯åšåˆ°æç®€ä¸”çµæ´»å¯æ‰©å±•å°±æ¯”è¾ƒéš¾ã€‚ æ‰€ä»¥åœ¨å®ç°æ—¶å°±å¿…é¡»è¦éµå¾ªè¿™äº›åŸåˆ™ã€‚

sealosæ—¨åœ¨åšä¸€ä¸ªç®€å•å¹²å‡€è½»é‡çº§ç¨³å®šçš„kuberneteså®‰è£…å·¥å…·ï¼Œèƒ½å¾ˆå¥½çš„æ”¯æŒé«˜å¯ç”¨å®‰è£…ã€‚ 

# ä¸€ã€ è®¾è®¡åŸåˆ™

## sealos ç‰¹æ€§ä¸ä¼˜åŠ¿ï¼š

- æ”¯æŒç¦»çº¿å®‰è£…ï¼Œå·¥å…·ä¸èµ„æºåŒ…ï¼ˆäºŒè¿›åˆ¶ç¨‹åº é…ç½®æ–‡ä»¶ é•œåƒ yamlæ–‡ä»¶ç­‰ï¼‰åˆ†ç¦»,è¿™æ ·ä¸åŒç‰ˆæœ¬æ›¿æ¢ä¸åŒç¦»çº¿åŒ…å³å¯
- è¯ä¹¦å»¶æœŸ
- ä½¿ç”¨ç®€å•
- æ”¯æŒè‡ªå®šä¹‰é…ç½®
- å†…æ ¸è´Ÿè½½ï¼Œæå…¶ç¨³å®šï¼Œå› ä¸ºç®€å•æ‰€ä»¥æ’æŸ¥é—®é¢˜ä¹Ÿæå…¶ç®€å•

### ä¸ºä»€ä¹ˆä¸ç”¨ ansibleï¼Ÿ

1.0 ç‰ˆæœ¬ç¡®å®æ˜¯ç”¨ `ansible` å®ç°ï¼Œä½†æ˜¯ç”¨æˆ·è¿˜æ˜¯éœ€è¦å…ˆè£… ansileï¼Œè£… ansible åˆéœ€è¦è£… `python` å’Œä¸€äº›ä¾èµ–ç­‰ï¼Œä¸ºäº†ä¸è®©ç”¨æˆ·é‚£ä¹ˆéº»çƒ¦æŠŠ ansible æ”¾åˆ°äº†å®¹å™¨é‡Œä¾›ç”¨æˆ·ä½¿ç”¨ã€‚å¦‚æœä¸æƒ³é…ç½®å…å¯†é’¥ä½¿ç”¨ç”¨æˆ·åå¯†ç æ—¶åˆéœ€è¦ `ssh-pass` ç­‰ï¼Œæ€»ä¹‹ä¸èƒ½è®©æˆ‘æ»¡æ„ï¼Œä¸æ˜¯æˆ‘æƒ³çš„æç®€ã€‚

æ‰€ä»¥æˆ‘æƒ³å°±æ¥ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶å·¥å…·ï¼Œæ²¡æœ‰ä»»ä½•ä¾èµ–ï¼Œæ–‡ä»¶åˆ†å‘ä¸è¿œç¨‹å‘½ä»¤éƒ½é€šè¿‡è°ƒç”¨ sdk å®ç°æ‰€ä»¥ä¸ä¾èµ–å…¶å®ƒä»»ä½•ä¸œè¥¿ï¼Œæ€»ç®—è®©æˆ‘è¿™ä¸ªæœ‰æ´ç™–çš„äººæ»¡æ„äº†ã€‚

### ä¸ºä»€ä¹ˆä¸ç”¨ keepalived haproxyï¼Ÿ

`haproxy` ç”¨ static pod è·‘æ²¡æœ‰å¤ªå¤§é—®é¢˜ï¼Œè¿˜ç®—å¥½ç®¡ç†ï¼Œ`keepalived` ç°åœ¨å¤§éƒ¨åˆ†å¼€æº ansible è„šæœ¬éƒ½ç”¨ yum æˆ–è€… apt ç­‰è£…ï¼Œè¿™æ ·éå¸¸çš„ä¸å¯æ§ï¼Œæœ‰å¦‚ä¸‹åŠ£åŠ¿ï¼š

- æºä¸ä¸€è‡´å¯èƒ½å¯¼è‡´ç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œç‰ˆæœ¬ä¸ä¸€ç›´è¿é…ç½®æ–‡ä»¶éƒ½ä¸ä¸€æ ·ï¼Œæˆ‘æ›¾ç»æ£€æµ‹è„šæœ¬ä¸ç”Ÿæ•ˆä¸€ç›´æ‰¾ä¸åˆ°åŸå› ï¼Œåæ¥æ‰çŸ¥é“æ˜¯ç‰ˆæœ¬åŸå› ã€‚
- ç³»ç»ŸåŸå› å®‰è£…ä¸ä¸Šï¼Œä¾èµ–åº“é—®é¢˜æŸäº›ç¯å¢ƒå°±ç›´æ¥è£…ä¸ä¸Šäº†ã€‚
- çœ‹äº†ç½‘ä¸Šå¾ˆå¤šå®‰è£…è„šæœ¬ï¼Œå¾ˆå¤šæ£€æµ‹è„šæœ¬ä¸æƒé‡è°ƒèŠ‚æ–¹å¼éƒ½ä¸å¯¹ï¼Œç›´æ¥å»æ£€æµ‹ haproxy è¿›ç¨‹åœ¨ä¸åœ¨ï¼Œå…¶å®æ˜¯åº”è¯¥å»æ£€æµ‹ apiserver æ˜¯ä¸æ˜¯ healthz çš„ï¼Œå¦‚æœ apiserver æŒ‚äº†ï¼Œå³ä½¿ haproxy è¿›ç¨‹å­˜åœ¨ï¼Œé›†ç¾¤ä¹Ÿä¼šä¸æ­£å¸¸äº†ï¼Œå°±æ˜¯ä¼ªé«˜å¯ç”¨äº†ã€‚
- ç®¡ç†ä¸æ–¹ä¾¿ï¼Œé€šè¿‡ prometheus å¯¹é›†ç¾¤è¿›è¡Œç›‘æ§ï¼Œæ˜¯èƒ½ç›´æ¥ç›‘æ§åˆ° static pod çš„ä½†æ˜¯ç”¨ systemd è·‘åˆéœ€è¦å•ç‹¬è®¾ç½®ç›‘æ§ï¼Œä¸”é‡å¯å•¥çš„è¿˜éœ€è¦å•ç‹¬æ‹‰èµ·ã€‚ä¸å¦‚ kubelet ç»Ÿä¸€ç®¡ç†æ¥çš„å¹²å‡€ç®€æ´ã€‚
- æˆ‘ä»¬è¿˜å‡ºç°è¿‡ keepalived æŠŠ CPU å æ»¡çš„æƒ…å†µã€‚

æ‰€ä»¥ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘æŠŠ keepalived è·‘åœ¨äº†å®¹å™¨ä¸­(ç¤¾åŒºæä¾›çš„é•œåƒåŸºæœ¬æ˜¯ä¸å¯ç”¨çš„) æ”¹é€ ä¸­é—´ä¹Ÿæ˜¯å‘ç”Ÿè¿‡å¾ˆå¤šé—®é¢˜ï¼Œæœ€ç»ˆå¥½åœ¨è§£å†³äº†ã€‚

æ€»è€Œè¨€ä¹‹ï¼Œç´¯è§‰ä¸çˆ±ï¼Œæ‰€ä»¥åœ¨æƒ³èƒ½ä¸èƒ½ç”©å¼€ haproxy å’Œ keepalived åšå‡ºæ›´ç®€å•æ›´å¯é çš„æ–¹æ¡ˆå‡ºæ¥ï¼Œè¿˜çœŸæ‰¾åˆ°äº†ã€‚ã€‚ã€‚

### æœ¬åœ°è´Ÿè½½ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ envoy æˆ–è€… nginxï¼Ÿ

æˆ‘ä»¬é€šè¿‡æœ¬åœ°è´Ÿè½½è§£å†³é«˜å¯ç”¨é—®é¢˜ã€‚

**æœ¬åœ°è´Ÿè½½**ï¼šåœ¨æ¯ä¸ª node èŠ‚ç‚¹ä¸Šéƒ½å¯åŠ¨ä¸€ä¸ªè´Ÿè½½å‡è¡¡ï¼Œä¸Šæ¸¸å°±æ˜¯ä¸‰ä¸ª masterã€‚

å¦‚æœä½¿ç”¨ `envoy` ä¹‹ç±»çš„è´Ÿè½½å‡è¡¡å™¨ï¼Œåˆ™éœ€è¦åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½è·‘ä¸€ä¸ªè¿›ç¨‹ï¼Œæ¶ˆè€—çš„èµ„æºæ›´å¤šï¼Œè¿™æ˜¯æˆ‘ä¸å¸Œæœ›çš„ã€‚ipvs å®é™…ä¹Ÿå¤šè·‘äº†ä¸€ä¸ªè¿›ç¨‹ `lvscare`ï¼Œä½†æ˜¯ `lvscare` åªæ˜¯è´Ÿè´£ç®¡ç† ipvs è§„åˆ™ï¼Œå’Œ `kube-proxy` ç±»ä¼¼ï¼ŒçœŸæ­£çš„æµé‡è¿˜æ˜¯ä»å¾ˆç¨³å®šçš„å†…æ ¸èµ°çš„ï¼Œä¸éœ€è¦å†æŠŠåŒ…ä¸¢åˆ°ç”¨æˆ·æ€ä¸­å»å¤„ç†ã€‚

åœ¨æ¶æ„å®ç°ä¸Šæœ‰ä¸ªé—®é¢˜ä¼šè®©ä½¿ç”¨ `envoy` ç­‰å˜å¾—éå¸¸å°´å°¬ï¼Œå°±æ˜¯ `join` æ—¶å¦‚æœè´Ÿè½½å‡è¡¡æ²¡æœ‰å»ºç«‹é‚£æ˜¯ä¼šå¡ä½çš„ï¼Œ`kubelet` å°±ä¸ä¼šèµ·æ¥ï¼Œæ‰€ä»¥ä¸ºæ­¤ä½ éœ€è¦å…ˆå¯åŠ¨ envoyï¼Œæ„å‘³ç€ä½ åˆä¸èƒ½ç”¨ static pod å»ç®¡ç†å®ƒï¼ŒåŒä¸Šé¢ keepalived å®¿ä¸»æœºéƒ¨ç½²ä¸€æ ·çš„é—®é¢˜ï¼Œç”¨ static pod å°±ä¼šç›¸äº’ä¾èµ–ï¼Œé€»è¾‘æ­»é”ï¼Œé¸¡è¯´è¦å…ˆæœ‰è›‹ï¼Œè›‹è¯´è¦å…ˆæœ‰é¸¡ï¼Œæœ€åè°éƒ½æ²¡æœ‰ã€‚

ä½¿ç”¨ `ipvs` å°±ä¸ä¸€æ ·ï¼Œæˆ‘å¯ä»¥åœ¨ join ä¹‹å‰å…ˆæŠŠ ipvs è§„åˆ™å»ºç«‹å¥½ï¼Œå†å» join å°±å¯ä»¥äº†ï¼Œç„¶åå¯¹è§„åˆ™è¿›è¡Œå®ˆæŠ¤å³å¯ã€‚ä¸€æ—¦ apiserver ä¸å¯è®¿é—®äº†ï¼Œä¼šè‡ªåŠ¨æ¸…ç†æ‰æ‰€æœ‰ node ä¸Šå¯¹åº”çš„ ipvs è§„åˆ™ï¼Œ ç­‰åˆ° master æ¢å¤æ­£å¸¸æ—¶æ·»åŠ å›æ¥ã€‚

### ä¸ºä»€ä¹ˆè¦å®šåˆ¶ kubeadm?

é¦–å…ˆæ˜¯ç”±äº `kubeadm` æŠŠè¯ä¹¦è¿‡æœŸæ—¶é—´å†™æ­»äº†ï¼Œæ‰€ä»¥éœ€è¦å®šåˆ¶æŠŠå®ƒæ”¹æˆ `99` å¹´ï¼Œè™½ç„¶å¤§éƒ¨åˆ†äººå¯ä»¥è‡ªå·±å»ç­¾ä¸ªæ–°è¯ä¹¦ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯ä¸æƒ³å†ä¾èµ–ä¸ªåˆ«çš„å·¥å…·ï¼Œå°±ç›´æ¥æ”¹æºç äº†ã€‚

å…¶æ¬¡å°±æ˜¯åšæœ¬åœ°è´Ÿè½½æ—¶ä¿®æ”¹ `kubeadm` ä»£ç æ˜¯æœ€æ–¹ä¾¿çš„ï¼Œå› ä¸ºåœ¨ join æ—¶æˆ‘ä»¬éœ€è¦åšä¸¤ä¸ªäº‹ï¼Œç¬¬ä¸€æ˜¯ join ä¹‹å‰å…ˆåˆ›å»ºå¥½ ipvs è§„åˆ™ï¼Œç¬¬äºŒæ˜¯åˆ›å»º static podã€‚å¦‚æœè¿™å—ä¸å»å®šåˆ¶ kubeadm å°±æŠŠæŠ¥é™æ€ pod ç›®å½•å·²å­˜åœ¨çš„é”™è¯¯ï¼Œå¿½ç•¥è¿™ä¸ªé”™è¯¯å¾ˆä¸ä¼˜é›…ã€‚ è€Œä¸” kubeadm ä¸­å·²ç»æä¾›äº†ä¸€äº›å¾ˆå¥½ç”¨çš„ `sdk` ä¾›æˆ‘ä»¬å»å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚

ä¸”è¿™æ ·åšä¹‹åæœ€æ ¸å¿ƒçš„åŠŸèƒ½éƒ½é›†æˆåˆ° kubeadm ä¸­äº†ï¼Œ`sealos` å°±å•å•å˜æˆåˆ†å‘å’Œæ‰§è¡Œä¸Šå±‚å‘½ä»¤çš„è½»é‡çº§å·¥å…·äº†ï¼Œå¢åŠ èŠ‚ç‚¹æ—¶æˆ‘ä»¬ä¹Ÿå°±å¯ä»¥ç›´æ¥ç”¨ kubeadm äº†ã€‚



# äºŒã€å¿«é€Ÿå¼€å§‹å®‰è£…éƒ¨ç½²

> åªéœ€è¦å‡†å¤‡å¥½æœåŠ¡å™¨ï¼Œåœ¨ä»»æ„ä¸€å°æœåŠ¡å™¨ä¸Šæ‰§è¡Œä¸‹é¢å‘½ä»¤å³å¯

```
# ä¸‹è½½å¹¶å®‰è£…sealos, sealosæ˜¯ä¸ªgolangçš„äºŒè¿›åˆ¶å·¥å…·ï¼Œç›´æ¥ä¸‹è½½æ‹·è´åˆ°binç›®å½•å³å¯, releaseé¡µé¢ä¹Ÿå¯ä¸‹è½½
$ wget -c https://sealyun.oss-cn-beijing.aliyuncs.com/latest/sealos && \
    chmod +x sealos && mv sealos /usr/bin 

# ä¸‹è½½ç¦»çº¿èµ„æºåŒ…
$ wget -c https://sealyun.oss-cn-beijing.aliyuncs.com/562b5c0ae4e48d17c5ab6d49422842c5-v1.20.0/kube1.20.0.tar.gz

# å®‰è£…ä¸€ä¸ªä¸‰masterçš„kubernetesé›†ç¾¤
$ sealos init --passwd '123456' \
	--master 192.168.0.2  --master 192.168.0.3  --master 192.168.0.4  \
	--node 192.168.0.5 \
	--pkg-url /root/kube1.20.0.tar.gz \
	--version v1.20.0
```

> å‚æ•°å«ä¹‰

| å‚æ•°å  | å«ä¹‰                                                         | ç¤ºä¾‹                    |
| ------- | ------------------------------------------------------------ | ----------------------- |
| passwd  | æœåŠ¡å™¨å¯†ç                                                    | 123456                  |
| master  | k8s masterèŠ‚ç‚¹IPåœ°å€                                         | 192.168.0.2             |
| node    | k8s nodeèŠ‚ç‚¹IPåœ°å€                                           | 192.168.0.3             |
| pkg-url | ç¦»çº¿èµ„æºåŒ…åœ°å€ï¼Œæ”¯æŒä¸‹è½½åˆ°æœ¬åœ°ï¼Œæˆ–è€…ä¸€ä¸ªè¿œç¨‹åœ°å€             | /root/kube1.20.0.tar.gz |
| version | [èµ„æºåŒ…](https://www.sealyun.com/goodsDetail?type=cloud_kernel&name=kubernetes)å¯¹åº”çš„ç‰ˆæœ¬ | v1.20.0                 |

> å¢åŠ master

```
ğŸ³ â†’ sealos join --master 192.168.0.6 --master 192.168.0.7
ğŸ³ â†’ sealos join --master 192.168.0.6-192.168.0.9  # æˆ–è€…å¤šä¸ªè¿ç»­IP
```

> å¢åŠ node

```
ğŸ³ â†’ sealos join --node 192.168.0.6 --node 192.168.0.7
ğŸ³ â†’ sealos join --node 192.168.0.6-192.168.0.9  # æˆ–è€…å¤šä¸ªè¿ç»­IP
```

> åˆ é™¤æŒ‡å®šmasterèŠ‚ç‚¹

```
ğŸ³ â†’ sealos clean --master 192.168.0.6 --master 192.168.0.7
ğŸ³ â†’ sealos clean --master 192.168.0.6-192.168.0.9  # æˆ–è€…å¤šä¸ªè¿ç»­IP
```

> åˆ é™¤æŒ‡å®šnodeèŠ‚ç‚¹

```
ğŸ³ â†’ sealos clean --node 192.168.0.6 --node 192.168.0.7
ğŸ³ â†’ sealos clean --node 192.168.0.6-192.168.0.9  # æˆ–è€…å¤šä¸ªè¿ç»­IP
```

> æ¸…ç†é›†ç¾¤

```
ğŸ³ â†’ sealos clean --all
```