ç›¸å…³å†…å®¹å‚è€ƒé“¾æ¥ï¼š

- [**FastDFS** åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ](https://www.oschina.net/p/fastdfs)
- [åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»ŸFastDFSç®€ä»‹ã€æ­å»ºã€ä¸SpringBootæ•´åˆå®ç°å›¾ç‰‡ä¸Šä¼ ](https://www.cnblogs.com/Tom-shushu/p/14470857.html)
- åšå®¢å›­ï¼šé™ˆå½¦æ–Œï¼š[ä»å…¥é—¨åˆ°ç²¾é€š(åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿæ¶æ„)-FastDFSï¼ŒFastDFS-Nginxæ•´åˆï¼Œåˆå¹¶å­˜å‚¨ï¼Œå­˜å‚¨ç¼©ç•¥å›¾ï¼Œå›¾ç‰‡å‹ç¼©ï¼ŒJavaå®¢æˆ·ç«¯](https://www.cnblogs.com/chenyanbin/p/12782615.html)



# ä¸€ã€FastDFSä»‹ç»

FastDFSæ˜¯ä¸€ä¸ªå¼€æºçš„åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼Œå¥¹å¯¹æ–‡ä»¶è¿›è¡Œç®¡ç†ï¼ŒåŠŸèƒ½åŒ…æ‹¬ï¼šæ–‡ä»¶å­˜å‚¨ã€æ–‡ä»¶åŒæ­¥ã€æ–‡ä»¶è®¿é—®ï¼ˆæ–‡ä»¶ä¸Šä¼ ã€æ–‡ä»¶ä¸‹è½½ï¼‰ç­‰ï¼Œè§£å†³äº†å¤§å®¹é‡å­˜å‚¨å’Œè´Ÿè½½å‡è¡¡çš„é—®é¢˜ã€‚ç‰¹åˆ«é€‚åˆä»¥æ–‡ä»¶ä¸ºè½½ä½“çš„åœ¨çº¿æœåŠ¡ï¼Œå¦‚ç›¸å†Œç½‘ç«™ã€è§†é¢‘ç½‘ç«™ç­‰ç­‰ã€‚

FastDFSæœåŠ¡ç«¯æœ‰ä¸¤ä¸ªè§’è‰²ï¼šè·Ÿè¸ªå™¨ï¼ˆtrackerï¼‰å’Œå­˜å‚¨èŠ‚ç‚¹ï¼ˆstorageï¼‰ã€‚è·Ÿè¸ªå™¨ä¸»è¦åšè°ƒåº¦å·¥ä½œï¼Œåœ¨è®¿é—®ä¸Šèµ·è´Ÿè½½å‡è¡¡çš„ä½œç”¨ã€‚

å­˜å‚¨èŠ‚ç‚¹å­˜å‚¨æ–‡ä»¶ï¼Œå®Œæˆæ–‡ä»¶ç®¡ç†çš„æ‰€æœ‰åŠŸèƒ½ï¼šå­˜å‚¨ã€åŒæ­¥å’Œæä¾›å­˜å–æ¥å£ï¼ŒFastDFSåŒæ—¶å¯¹æ–‡ä»¶çš„meta dataè¿›è¡Œç®¡ç†ã€‚æ‰€è°“æ–‡ä»¶çš„meta dataå°±æ˜¯æ–‡ä»¶çš„ç›¸å…³å±æ€§ï¼Œä»¥é”®å€¼å¯¹ï¼ˆkey value pairï¼‰æ–¹å¼è¡¨ç¤ºï¼Œå¦‚ï¼šwidth=1024ï¼Œå…¶ä¸­çš„keyä¸ºwidthï¼Œvalueä¸º1024ã€‚æ–‡ä»¶meta dataæ˜¯æ–‡ä»¶å±æ€§åˆ—è¡¨ï¼Œå¯ä»¥åŒ…å«å¤šä¸ªé”®å€¼å¯¹ã€‚



1. FastDFSæ˜¯ä¸€ä¸ªCç¼–å†™çš„å¼€æºçš„**é«˜æ€§èƒ½åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ**(Distributed File Systemï¼Œç®€ç§°DFS)
2. å®ƒç”±æ·˜å®å¼€å‘å¹³å°éƒ¨èµ„æ·±æ¶æ„å¸ˆä½™åº†å¼€å‘,è®ºå›ï¼šhttp://bbs.chinaunix.net/forum-240-1.html
3. å®ƒå¯¹**æ–‡ä»¶è¿›è¡Œç®¡ç†**ï¼ŒåŠŸèƒ½åŒ…æ‹¬ï¼š**æ–‡ä»¶å­˜å‚¨ã€æ–‡ä»¶åŒæ­¥ã€æ–‡ä»¶è®¿é—®(æ–‡ä»¶ä¸Šä¼ ã€æ–‡ä»¶ä¸‹è½½)**ç­‰ï¼Œè§£å†³äº†å¤§å®¹é‡å­˜å‚¨å’Œè´Ÿè½½å‡è¡¡çš„é—®é¢˜
4. ç‰¹åˆ«é€‚åˆä»¥æ–‡ä»¶ä¸ºè½½ä½“çš„åœ¨çº¿æœåŠ¡ï¼Œå¦‚**ç›¸å†Œç½‘ç«™ã€è§†é¢‘ç½‘ç«™ã€ç”µå•†**ç­‰ç­‰ã€‚ç‰¹åˆ«é€‚åˆä»¥**ä¸­å°æ–‡ä»¶**(å»ºè®®èŒƒå›´ï¼š4KB<file_size<500mb)ä¸ºè½½ä½“çš„åœ¨çº¿æœåŠ¡
5. FastDFSä¸ºäº’è”ç½‘é‡èº«å®šåˆ¶ï¼Œå……åˆ†è€ƒè™‘äº†**å†—ä½™å¤‡ä»½ã€è´Ÿè½½å‡è¡¡ã€çº¿æ€§æ‰©å®¹**ç­‰æœºåˆ¶ï¼Œå¹¶æ³¨é‡**é«˜å¯ç”¨ã€é«˜æ€§èƒ½**ç­‰æŒ‡æ ‡ï¼Œä½¿ç”¨**FastDFSå¾ˆå®¹æ˜“æ­å»ºä¸€å¥—é«˜æ€§èƒ½çš„æ–‡ä»¶æœåŠ¡å™¨é›†ç¾¤æä¾›æ–‡ä»¶ä¸Šä¼ ã€ä¸‹è½½**ç­‰æœåŠ¡
6. githubï¼šhttps://github.com/happyfish100/fastdfs



# äºŒã€æµç¨‹å›¾

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200426233442772-883437414.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200426233442772-883437414.png)

# FastDFSæ¶æ„åŸç†åˆ†æ(é‡ç‚¹)

## æ¶æ„åˆ†æ

ã€€ã€€FastDFSç³»ç»Ÿæœ‰ä¸‰ä¸ªè§’è‰²ï¼šè·Ÿè¸ªæœåŠ¡å™¨(Tracker Server)ã€å­˜å‚¨æœåŠ¡å™¨(Storage Server)å’Œå®¢æˆ·ç«¯(Client)ã€‚

### Tracker Serverï¼šè·Ÿè¸ªæœåŠ¡å™¨

- ä¸»è¦åšè°ƒåº¦å·¥ä½œï¼Œå¹¶å¯¹Storage Serverèµ·åˆ°è´Ÿè½½å‡è¡¡çš„ä½œç”¨
- è´Ÿè´£ç®¡ç†æ‰€æœ‰çš„Storage Serverå’Œgroupï¼Œæ¯ä¸ªstorageåœ¨å¯åŠ¨åè¿æ¥Trackerï¼Œå‘ŠçŸ¥è‡ªå·±æ‰€å±groupç­‰ä¿¡æ¯ï¼Œå¹¶ä¿å­˜å‘¨æœŸæ€§å¿ƒè·³ã€‚
- Tracker Serverå¯ä»¥æœ‰å¤šå°ï¼Œ**Tracker Serverä¹‹é—´æ˜¯ç›¸äº’å¹³ç­‰å…³ç³»åŒæ—¶æä¾›æœåŠ¡ï¼ŒTracker Serverä¸å­˜åœ¨å•ç‚¹æ•…éšœã€‚å®¢æˆ·ç«¯è¯·æ±‚Tracker Serveré‡‡ç”¨è½®è¯¢æ–¹å¼ï¼Œå¦‚æœè¯·æ±‚çš„Trackeræ— æ³•æä¾›æœåŠ¡åˆ™æ¢å¦ä¸€ä¸ªTracker**ã€‚

### Storage Serverï¼šå­˜å‚¨æœåŠ¡å™¨

- ä¸»è¦æä¾›å®¹é‡å’Œå¤‡ä»½æœåŠ¡
- ä»¥groupä¸ºå•ä½ï¼Œä¸åŒgroupä¹‹é—´äº’ç›¸ç‹¬ç«‹ï¼Œæ¯ä¸ªgroupå†…å¯ä»¥æœ‰å¤šå°storage serverï¼Œæ•°æ®äº’ä¸ºå¤‡ä»½ã€‚
- é‡‡ç”¨åˆ†ç»„å­˜å‚¨æ–¹å¼çš„å¥½å¤„æ˜¯çµæ´»ï¼Œå¯æ§æ€§å¼ºï¼Œæ¯”å¦‚ä¸Šä¼ æ–‡ä»¶æ—¶ï¼Œå¯ä»¥ç”±å®¢æˆ·ç«¯ç›´æ¥æŒ‡å®šä¸Šä¼ åˆ°çš„ç»„ä¹Ÿå¯ä»¥ç”±Trackerè¿›è¡Œè°ƒåº¦é€‰æ‹©ã€‚
- ä¸€ä¸ªåˆ†ç»„çš„å­˜å‚¨æœåŠ¡å™¨çš„è®¿é—®å‹åŠ›è¾ƒå¤§æ—¶ï¼Œå¯ä»¥åœ¨è¯¥ç»„å¢åŠ å­˜å‚¨æœåŠ¡å™¨æ¥æ‰©å……æœåŠ¡èƒ½åŠ›ï¼ˆçºµå‘æ‰©å®¹ï¼‰ã€‚å½“ç³»ç»Ÿå®¹é‡ä¸è¶³æ—¶ï¼Œå¯ä»¥å¢åŠ ç»„æ¥æ‰©å……å­˜å‚¨å®¹é‡(æ¨ªå‘æ‰©å®¹)ã€‚

### Clientï¼šå®¢æˆ·ç«¯

- ä¸Šä¼ ä¸‹è½½æ•°æ®çš„æœåŠ¡å™¨ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è‡ªå·±çš„é¡¹ç›®æ‰€éƒ¨ç½²åœ¨çš„æœåŠ¡å™¨

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200428110626749-1463358091.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200428110626749-1463358091.png)

## å­˜å‚¨ç­–ç•¥

ã€€ã€€ä¸ºäº†æ”¯æŒå¤§å®¹é‡ï¼Œå­˜å‚¨èŠ‚ç‚¹(æœåŠ¡å™¨)é‡‡ç”¨**åˆ†å·**(**æˆ–åˆ†ç»„**)**çš„ç»„ç»‡æ–¹å¼**ã€‚å­˜å‚¨ç³»ç»Ÿç”±ä¸€ä¸ªæˆ–å¤šä¸ªå·ç»„æˆï¼Œ**å·ä¸å·ä¹‹é—´çš„æ–‡ä»¶æ˜¯ç›¸äº’ç‹¬ç«‹çš„**ï¼Œæ‰€æœ‰å·çš„æ–‡ä»¶å®¹é‡ç´¯åŠ å°±æ˜¯æ•´ä¸ªå­˜å‚¨ç³»ç»Ÿä¸­çš„æ–‡ä»¶å®¹é‡ã€‚ä¸€ä¸ªå·å¯ä»¥ç”±ä¸€å°æˆ–å¤šå°å­˜å‚¨æœåŠ¡å™¨ç»„æˆï¼Œ**ä¸€ä¸ªå·ä¸‹çš„å­˜å‚¨æœåŠ¡å™¨ä¸­çš„æ–‡ä»¶éƒ½æ˜¯ç›¸åŒçš„**ï¼Œ**å·ä¸­çš„å¤šå°å­˜å‚¨æœåŠ¡å™¨**èµ·åˆ°äº†**å†—ä½™å¤‡ä»½å’Œè´Ÿè½½å‡è¡¡**çš„ä½œç”¨ã€‚

ã€€ã€€**åœ¨å·ä¸­å¢åŠ æœåŠ¡å™¨æ—¶ï¼ŒåŒæ­¥å·²æœ‰çš„æ–‡ä»¶ç”±ç³»ç»Ÿè‡ªåŠ¨å®Œæˆï¼ŒåŒæ­¥å®Œæˆåï¼Œç³»ç»Ÿè‡ªåŠ¨å°†æ–°å¢æœåŠ¡å™¨åˆ‡æ¢åˆ°çº¿ä¸Šæä¾›æœåŠ¡**ã€‚å½“å­˜å‚¨ç©ºé—´ä¸è¶³æˆ–å³å°†è€—å°½æ—¶ï¼Œå¯ä»¥åŠ¨æ€åŠ è½½å·ï¼Œåªéœ€è¦å¢åŠ ä¸€å°æˆ–å¤šå°æœåŠ¡å™¨ï¼Œå¹¶å°†å®ƒä»¬é…ç½®ä¸ºä¸€ä¸ªæ–°çš„å·ï¼Œè¿™æ ·å°±æ‰©å¤§äº†å­˜å‚¨ç³»ç»Ÿçš„å®¹é‡ã€‚

## StorageçŠ¶æ€æ”¶é›†

ã€€ã€€Storage Serverä¼šé€šè¿‡é…ç½®è¿æ¥é›†ç¾¤ä¸­æ‰€æœ‰çš„Tracker Serverï¼Œå®šæ—¶å‘ä»–ä»¬æŠ¥å‘Šè‡ªå·±çš„çŠ¶æ€ï¼ŒåŒ…æ‹¬**ç£ç›˜å‰©ä½™ç©ºé—´ã€æ–‡ä»¶ä¸Šä¼ ä¸‹è½½æ¬¡æ•°ç­‰ç»Ÿè®¡ä¿¡æ¯**ã€‚

Storage Serveræœ‰7ä¸ªçŠ¶æ€ï¼Œå¦‚ä¸‹

1. FDFS_STORAGE_STATUS_INIT ->åˆå§‹åŒ–ï¼Œå°šæœªå¾—åˆ°åŒæ­¥å·²æœ‰æ•°æ®çš„æºæœåŠ¡å™¨
2. FDFS_STORAGE_STATUS_WAIT_SYNC ->ç­‰å¾…åŒæ­¥ï¼Œå·²å¾—åˆ°åŒæ­¥å·²æœ‰æ•°æ®çš„æºæœåŠ¡å™¨
3. FDFS_STORAGE_STATUS_SYNCING ->åŒæ­¥ä¸­
4. FDFS_STORAGE_STATUS_DELETED ->å·²åˆ é™¤ï¼Œè¯¥æœåŠ¡å™¨ä»æœ¬ç»„ä¸­æ‘˜é™¤
5. FDFS_STORAGE_STATUS_OFFLINE ->ç¦»çº¿
6. FDFS_STORAGE_STATUS_ONLINE ->åœ¨çº¿ï¼Œå°šä¸èƒ½æä¾›æœåŠ¡
7. FDFS_STORAGE_STATUS_ACTIVE ->åœ¨çº¿ï¼Œå¯ä»¥æä¾›æœåŠ¡

## æ–‡ä»¶ä¸Šä¼ æµç¨‹åˆ†æ

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200428114652322-1515854722.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200428114652322-1515854722.png)

### æµç¨‹è¯´æ˜

**1ã€****Tracker Serveræ”¶é›†Storage Serverçš„çŠ¶æ€ä¿¡æ¯**

ã€€ã€€1.1ã€Storage Serverå®šæ—¶å‘å·²çŸ¥çš„tracker server(å¯ä»¥æ˜¯å¤šä¸ª)å‘é€ç£ç›˜å‰©ä½™ç©ºé—´ã€æ–‡ä»¶åŒæ­¥çŠ¶æ€ã€æ–‡ä»¶ä¸Šä¼ ä¸‹è½½æ¬¡æ•°ç­‰ç»Ÿè®¡ä¿¡æ¯

ã€€ã€€1.2ã€Storage Serverä¼šè¿æ¥æ•´ä¸ªé›†ç¾¤ä¸­æ‰€æœ‰çš„Tracker Serverï¼Œå‘å®ƒä»¬æŠ¥å‘Šè‡ªå·±çš„çŠ¶æ€

**2ã€****é€‰æ‹©Tracker server**

ã€€ã€€2.1ã€å½“é›†ç¾¤ä¸­ä¸æ­¢ä¸€ä¸ªTracker Serveræ—¶ï¼Œç”±äºTrackerä¹‹é—´æ˜¯å®Œå…¨å¯¹ç­‰çš„å…³ç³»ï¼Œå®¢æˆ·ç«¯åœ¨uploadæ–‡ä»¶æ—¶å¯ä»¥ä»»æ„é€‰æ‹©ä¸€ä¸ªTracker 

**3ã€****é€‰æ‹©å­˜å‚¨çš„group**

ã€€ã€€å½“Trackeræ¥æ”¶åˆ°upload fileçš„è¯·æ±‚æ—¶ï¼Œä¼šä¸ºè¯¥æ–‡ä»¶åˆ†é…ä¸€ä¸ªå¯å­˜å‚¨è¯¥æ–‡ä»¶çš„groupï¼Œæ”¯æŒå¦‚ä¸‹è§„åˆ™

ã€€ã€€ã€€ã€€3.1ã€Round robinï¼Œæ‰€æœ‰çš„groupé—´è½®è¯¢(**é»˜è®¤**)

ã€€ã€€ã€€ã€€3.2ã€Specified groupï¼ŒæŒ‡å®šæŸä¸€ä¸ªç¡®å®šçš„group

ã€€ã€€ã€€ã€€3.3ã€Load balanceï¼Œå‰©ä½™å­˜å‚¨ç©ºé—´å¤šçš„ï¼Œgroupä¼˜å…ˆ

**4ã€é€‰æ‹©Storage Server**

ã€€ã€€å½“é€‰å®šgroupåï¼ŒTrackerä¼šåœ¨groupå†…é€‰æ‹©ä¸€ä¸ªStorage Serverç»™å®¢æˆ·ç«¯ï¼Œæ”¯æŒå¦‚ä¸‹é€‰æ‹©Storageçš„è§„åˆ™

ã€€ã€€4.1ã€Round robinï¼Œåœ¨groupå†…çš„æ‰€æœ‰Storageé—´è½®è¯¢(**é»˜è®¤**)

ã€€ã€€4.2ã€First server ordered by ipï¼ŒæŒ‰ipæ’åº

ã€€ã€€4.3ã€First server ordered by priorityï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åº(ä¼˜å…ˆçº§åœ¨Storageä¸Šé…ç½®)

**5ã€é€‰æ‹©Storage path**

ã€€ã€€å½“åˆ†é…å¥½Storage serveråï¼Œå®¢æˆ·ç«¯å°†å‘Storageå‘é€å†™æ–‡ä»¶è¯·æ±‚ï¼ŒStorageå°†ä¼šä¸ºæ–‡ä»¶åˆ†é…ä¸€ä¸ªæ•°æ®å­˜å‚¨ç›®å½•ï¼Œæ”¯æŒå¦‚ä¸‹è§„åˆ™(**åœ¨Storageé…ç½®æ–‡ä»¶ä¸­å¯ä»¥é€šè¿‡store_path\*å‚æ•°æ¥è®¾ç½®ï¼Œè¯¥å‚æ•°å¯ä»¥è®¾ç½®å¤šä¸ªï¼Œé€šè¿‡\*æ¥åŒºåˆ«**)

ã€€ã€€5.1ã€Round robinï¼Œå¤šä¸ªå­˜å‚¨ç›®å½•é—´è½®è¯¢

ã€€ã€€5.2ã€å‰©ä½™å­˜å‚¨ç©ºé—´æœ€å¤šçš„ä¼˜å…ˆ

**6ã€ç”Ÿæˆfileid**

ã€€ã€€é€‰å®šå­˜å‚¨ç›®å½•ä¹‹åï¼ŒStorageä¼šä¸ºæ–‡ä»¶ç”Ÿä¸€ä¸ªfileidï¼Œç”±æºStorage server ipã€æ–‡ä»¶åˆ›å»ºæ—¶é—´ã€æ–‡ä»¶å¤§å°ã€æ–‡ä»¶crc32å’Œä¸€ä¸ªéšæœºæ•°æ‹¼æ¥è€Œæˆï¼Œç„¶åå°†è¿™ä¸ªäºŒè¿›åˆ¶ä¸²è¿›è¡Œbase64ç¼–ç ï¼Œè½¬æ¢ä¸ºå¯æ‰“å°çš„å­—ç¬¦ä¸²ã€‚

**7ã€é€‰æ‹©ä¸¤çº§ç›®å½•**

ã€€ã€€å½“é€‰å®šå­˜å‚¨ç›®å½•ä¹‹åï¼ŒStorageä¼šä¸ºæ–‡ä»¶åˆ†é…ä¸€ä¸ªfileidï¼Œæ¯ä¸ªå­˜å‚¨ç›®å½•ä¸‹æœ‰ä¸¤çº§256*256çš„å­ç›®å½•ï¼ŒStorageä¼šæŒ‰æ–‡ä»¶fileidè¿›è¡Œä¸¤æ¬¡hashï¼Œè·¯ç”±åˆ°å…¶ä¸­ä¸€ä¸ªå­ç›®å½•ï¼Œç„¶åå°†æ–‡ä»¶ä»¥fileidä¸ºæ–‡ä»¶åå­˜å‚¨åˆ°è¯¥å­ç›®å½•ä¸‹ã€‚

**8ã€ç”Ÿæˆæ–‡ä»¶å**

ã€€ã€€å½“æ–‡ä»¶å­˜å‚¨åˆ°æŸä¸ªå­ç›®å½•åï¼Œæ—¢è®¤ä¸ºè¯¥æ–‡ä»¶å­˜å‚¨æˆåŠŸï¼Œæ¥ä¸‹æ¥ä¼šä¸ºè¯¥æ–‡ä»¶ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶åï¼Œæ–‡ä»¶åç”±groupã€å­˜å‚¨ç›®å½•ã€ä¸¤çº§å­ç›®å½•ã€fileidã€æ–‡ä»¶åç¼€å(ç”±å®¢æˆ·ç«¯æŒ‡å®šï¼Œä¸»è¦ç”¨äºåŒºåˆ†æ–‡ä»¶ç±»å‹)æ‹¼æ¥è€Œæˆã€‚

## æ–‡ä»¶åŒæ­¥åˆ†æ

ã€€ã€€å†™æ–‡ä»¶æ—¶ï¼Œå®¢æˆ·ç«¯å°†æ–‡ä»¶å†™è‡³groupå†…ä¸€ä¸ªStorage Serveræ—¢è®¤ä¸ºå†™æ–‡ä»¶æˆåŠŸï¼ŒStorage Serverå†™å®Œæ–‡ä»¶åï¼Œä¼šç”±åå°çº¿ç¨‹å°†æ–‡ä»¶åŒæ­¥è‡³groupå†…å…¶ä»–çš„Storage Serverã€‚

### åŒæ­¥è§„åˆ™æ€»ç»“å¦‚ä¸‹

1. åªåœ¨æœ¬ç»„å†…çš„Storage Serverä¹‹é—´è¿›è¡ŒåŒæ­¥
2. æºå¤´æ•°æ®æ‰éœ€è¦åŒæ­¥ï¼Œå¤‡ä»½æ•°æ®ä¸éœ€è¦å†æ¬¡åŒæ­¥ï¼Œå¦åˆ™å°±æ„æˆé—­ç¯äº†
3. ä¸Šè¿°ç¬¬äºŒæ¡è§„åˆ™æœ‰ä¸ªä¾‹å¤–ï¼Œå°±æ˜¯æ–°å¢ä¸€å°Storage Serveræ—¶ï¼Œç”±å·²æœ‰çš„ä¸€å°Storage Serverå°†å·²æœ‰çš„æ‰€æœ‰æ•°æ®(åŒ…æ‹¬æºå¤´æ•°æ®å’Œå¤‡ä»½æ•°æ®)åŒæ­¥ç»™è¯¥æ–°å¢æœåŠ¡å™¨

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200429090532031-322528301.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200429090532031-322528301.png)

ã€€ã€€æ¯ä¸ªStorageå†™æ–‡ä»¶åï¼ŒåŒæ—¶ä¼šå†™ä¸€ä»½binlogï¼Œbinlogé‡Œä¸åŒ…å«æ–‡ä»¶æ•°æ®ï¼ŒåªåŒ…å«æ–‡ä»¶åç­‰å…ƒä¿¡æ¯ï¼Œè¿™ä»½binlogç”¨äºåå°åŒæ­¥ï¼ŒStorageä¼šè®°å½•å‘groupå†…å…¶ä»–StorageåŒæ­¥çš„è¿›åº¦ï¼Œä»¥ä¾¿é‡å¯åèƒ½æ¥ä¸Šæ¬¡çš„è¿›åº¦ç»§ç»­åŒæ­¥ï¼›è¿›åº¦ä»¥æ—¶é—´æˆ³çš„æ–¹å¼è¿›è¡Œè®°å½•ï¼Œæ‰€ä»¥æœ€å¥½èƒ½ä¿è¯é›†ç¾¤å†…æ‰€æœ‰Serverçš„æ—¶é’Ÿä¿æŒåŒæ­¥ã€‚

## æ–‡ä»¶ä¸‹è½½æµç¨‹åˆ†æ

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200429092419097-1304224556.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200429092419097-1304224556.png)

ã€€ã€€å®¢æˆ·ç«¯upload fileæˆåŠŸåï¼Œä¼šæ‹¿åˆ°ä¸€ä¸ªStorageç”Ÿæˆçš„æ–‡ä»¶åï¼Œæ¥ä¸‹æ¥å®¢æˆ·ç«¯æ ¹æ®è¿™ä¸ªæ–‡ä»¶åå³å¯è®¿é—®åˆ°è¯¥æ–‡ä»¶ã€‚

### æµç¨‹è¯´æ˜

**1ã€Tracker Serveræ”¶é›†Storage Serverçš„çŠ¶æ€ä¿¡æ¯
**

ã€€ã€€1.1ã€Storage Serverå®šæ—¶å‘å·²çŸ¥çš„Tracker Server(å¯ä»¥æ˜¯å¤šä¸ª)å‘é€ç£ç›˜å‰©ä½™ç©ºé—´ã€æ–‡ä»¶åŒæ­¥çŠ¶æ€ã€æ–‡ä»¶ä¸Šä¼ ä¸‹è½½æ¬¡æ•°ç­‰ç»Ÿè®¡ä¿¡æ¯ã€‚

ã€€ã€€1.2ã€Storage Serverä¼šè¿æ¥æ•´ä¸ªé›†ç¾¤ä¸­æ‰€æœ‰çš„Tracker Serverï¼Œå‘ä»–ä»¬æŠ¥å‘Šè‡ªå·±çš„çŠ¶æ€ã€‚

**2ã€é€‰æ‹©Tracker Server**

ã€€ã€€2.1ã€è·Ÿupload fileä¸€æ ·ï¼Œåœ¨download fileæ—¶å®¢æˆ·ç«¯å¯ä»¥é€‰æ‹©ä»»æ„Tracker Server 

**3ã€é€‰æ‹©å¯ç”¨çš„Storage Server**

 ã€€3.1ã€clientå‘é€downloadè¯·æ±‚ç»™æŸä¸ªTrackerï¼Œå¿…é¡»å¸¦ä¸Šæ–‡ä»¶åä¿¡æ¯ï¼ŒTrackerä»æ–‡ä»¶åä¸­è§£æå‡ºæ–‡ä»¶çš„groupã€è·¯å¾„ä¿¡æ¯ã€æ–‡ä»¶å¤§å°ã€åˆ›å»ºæ—¶é—´ã€æºStorage Server ipç­‰ä¿¡æ¯ï¼Œç„¶åä¸ºè¯¥è¯·æ±‚é€‰æ‹©ä¸€ä¸ªStorageç”¨æ¥æœåŠ¡è¯»è¯·æ±‚ã€‚

ã€€ã€€3.2ã€ç”±äºgroupå†…çš„æ–‡ä»¶åŒæ­¥æ˜¯åœ¨åå°å¼‚æ­¥è¿›è¡Œçš„ï¼Œæ‰€ä»¥æœ‰å¯èƒ½å‡ºç°åœ¨è¯»çš„æ—¶å€™ï¼Œæ–‡ä»¶è¿˜æ²¡æœ‰åŒæ­¥åˆ°æŸäº›Storage Serverä¸Šï¼Œä¸ºäº†å°½é‡é¿å…è®¿é—®åˆ°è¿™æ ·çš„Storageï¼ŒTrackeræŒ‰ç…§å¦‚ä¸‹è§„åˆ™é€‰æ‹©groupå†…å¯è¯»çš„Storage

ã€€ã€€ã€€ã€€3.2.1ã€è¯¥æ–‡ä»¶ä¸Šä¼ åˆ°çš„æºå¤´Storage - æºå¤´Storageåªè¦å­˜æ´»ç€ï¼Œè‚¯å®šåŒ…å«è¿™ä¸ªæ–‡ä»¶ï¼Œæºå¤´çš„åœ°å€è¢«ç¼–ç åœ¨æ–‡ä»¶åä¸­ã€‚

ã€€ã€€ã€€ã€€3.2.2ã€æ–‡ä»¶åˆ›å»ºæ—¶é—´æˆ³ == Storageè¢«åŒæ­¥åˆ°æ—¶é—´æˆ³ ä¸”(å½“å‰æ—¶é—´ - æ–‡ä»¶åˆ›å»ºæ—¶é—´æˆ³) > æ–‡ä»¶åŒæ­¥æœ€å¤§æ—¶é—´ - æ–‡ä»¶åˆ›å»ºåï¼Œè®¤ä¸ºç»è¿‡æœ€å¤§åŒæ­¥æ—¶é—´åï¼Œè‚¯å®šå·²ç»åŒæ­¥åˆ°å…¶ä»–Storageäº†ã€‚

ã€€ã€€ã€€ã€€3.2.3ã€æ–‡ä»¶åˆ›å»ºæ—¶é—´æˆ³ < Storageè¢«åŒæ­¥åˆ°çš„æ—¶é—´æˆ³ã€‚ - åŒæ­¥æ—¶é—´æˆ³ä¹‹å‰çš„æ–‡ä»¶ç¡®å®šå·²ç»åŒæ­¥

ã€€ã€€ã€€ã€€3.2.4ã€(å½“å‰æ—¶é—´ - æ–‡ä»¶åˆ›å»ºæ—¶é—´æˆ³) > åŒæ­¥å»¶è¿Ÿé˜ˆå€¼ã€‚ ç»è¿‡åŒæ­¥å»¶è¿Ÿé˜ˆå€¼æ—¶é—´ï¼Œè®¤ä¸ºæ–‡ä»¶è‚¯å®šå·²ç»åŒæ­¥äº†

# FastDFSå®‰è£…

## éœ€æ±‚

1. Tracker Serverï¼š
2. Storage Serverï¼š

ã€€ã€€æ³¨ï¼šTrackerå’ŒStorageå®‰è£…ï¼Œå®‰è£…è¿‡ç¨‹éƒ½ä¸€æ ·ï¼Œé…ç½®æ–‡ä»¶æœ‰å·®å¼‚

## å®‰è£…gccç¯å¢ƒ

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200429152307144-1697350913.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200429152307144-1697350913.png)

```
yum install -y gcc-c++ gcc
```

## å®‰è£…libevent(é«˜ç‰ˆæœ¬å¯å¿½ç•¥ï¼Œä¿é™©èµ·è§å®‰è£…)

FastDFSä¾èµ–libeventåº“

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200429154948848-162212675.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200429154948848-162212675.png)

```
yum install -y libevent
```

## å®‰è£…libfastcommon

ä¸‹è½½åœ°å€ï¼š

```
https://github.com/happyfish100/libfastcommon/releases
```

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200429155752637-1544159427.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200429155752637-1544159427.png)

è¡¥å……

```
ä¹Ÿå¯ä»¥ç”¨wgetæ–¹å¼è”ç½‘ä¸‹è½½ï¼Œè¿™é‡Œæˆ‘æ˜¯æå‰ä¸‹è½½åˆ°æœ¬åœ°å®¢æˆ·ç«¯ï¼Œå°†åŒ…æ‹–è¿›linuxä¸­

è‹¥wgetå‘½ä»¤ä¸èƒ½ä½¿ç”¨ï¼Œè¯·æ‰§è¡Œï¼šyum install -y wget

wgetæ–¹å¼ï¼š
wget https://github.com/happyfish100/libfastcommon/archive/V1.0.43.tar.gz
```

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200429160617324-172067107.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200429160617324-172067107.png)

### åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œç”¨äºå­˜æ”¾å®‰è£…åŒ…

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200429160913490-1605934218.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200429160913490-1605934218.png)

å°†ä¸‹è½½åçš„åŒ…æ”¾åˆ°è¯¥ç›®å½•ä¸‹

### è§£å‹ç¼©

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200429161246758-2109242004.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200429161246758-2109242004.png)

### ç¼–è¯‘å¹¶å®‰è£…

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200429161451716-1502979173.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200429161451716-1502979173.png)

### æ‹·è´libfastcommon.soæ–‡ä»¶è‡³/usr/libç›®å½•(é«˜ç‰ˆæœ¬å¯å¿½ç•¥æ­¤æ­¥)

```
cp /usr/lib64/libfastcommon.so /usr/lib/
```

## å®‰è£…FastDFS

### ä¸‹è½½åœ°å€

```
https://github.com/happyfish100/fastdfs/releases
```

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200429155616118-266286521.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200429155616118-266286521.png)

### è§£å‹ç¼©

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200429165649129-1306955321.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200429165649129-1306955321.png)

### ç¼–è¯‘ä¸å®‰è£…

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200429165859241-1571704543.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200429165859241-1571704543.png)

### æ‹·è´FastDFSç›®å½•ä¸‹çš„æ–‡ä»¶åˆ°/etc/fdfsç›®å½•ä¸‹

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200429170319859-1300587686.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200429170319859-1300587686.png)

```
cp /cyb/soft/fastdfs-6.06/conf/* /etc/fdfs
```

------

=========================åˆ†å‰²çº¿======================================================

-----------------Trackerå’ŒStorageå…±åŒå®‰è£…æ­¥éª¤ç»“æŸï¼ï¼ï¼----------------------------

------------------Trackerå’ŒStorageåªæ˜¯é…ç½®ä¸åŒï¼ï¼ï¼ï¼-----------------------------

=========================åˆ†å‰²çº¿======================================================

------

## Tracker Server é…ç½®(è™šæ‹Ÿæœºå:CentOS 6-FastDFS-01)[#](https://www.cnblogs.com/chenyanbin/p/12782615.html#tracker-server-é…ç½®(è™šæ‹Ÿæœºå:centos-6-fastdfs-01))

### ä¿®æ”¹/etc/fdfs/tracker.conf

```
vim /etc/fdfs/tracker.conf
```

### ä¿®æ”¹å†…å®¹

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430100038018-236122834.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430100038018-236122834.png)

### åˆ›å»ºç›®å½•(è‹¥ç›®å½•å·²å­˜åœ¨ï¼Œå¯å¿½ç•¥)

```
 mkdir /cyb/server/fastdfs/tracker -p
```

## Storage Serveré…ç½®(è™šæ‹Ÿæœºåï¼šCentOS 6-FastDFS-02)

### ä¿®æ”¹/etc/fdfs/storage.conf

```
vim /etc/fdfs/storage.conf
```

ä¿®æ”¹å†…å®¹æ¨¡æ¿

```
# æŒ‡å®šstorageçš„ç»„å
group_name=group1
base_path=/cyb/server/fastdfs/storage

# å¦‚æœæœ‰å¤šä¸ªæŒ‚è½½ç£ç›˜åˆ™å®šä¹‰å¤šä¸ªstore_path
store_path0=/cyb/server/fastdfs/storage
# store_path1=.......
# store_path2=.......
# store_path3=.......

# é…ç½®trackeræœåŠ¡å™¨ipå’Œç«¯å£
tracker_server=192.168.1.1:22122
# è‹¥æœæœ‰å¤šä¸ªåˆ™é…ç½®å¤šä¸ªtracker
# tracker_server=xxx.xxx.xxx.xxx:xxxx
# tracker_server=xxx.xxx.xxx.xxx:xxxx
# tracker_server=xxx.xxx.xxx.xxx:xxxx
```

ä¿®æ”¹ï¼šgroup_name

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430102332281-736891592.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430102332281-736891592.png)

ä¿®æ”¹ï¼šbase_path

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430102520662-2016156516.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430102520662-2016156516.png)

ä¿®æ”¹ï¼šstore_path*

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430103112769-768908221.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430103112769-768908221.png)

ã€€ã€€**è¡¥å……ï¼šä¸ºä»€ä¹ˆè¦è®¾ç½®å¤šä¸ªstore_path\*å‘¢ï¼Ÿlinuxå¦‚æœç£ç›˜ä¸å¤Ÿç”¨çš„è¯ï¼Œç”¨æˆ·å¯ä»¥åŠ ç¡¬ç›˜ï¼Œç„¶åè®¾ç½®å¤šä¸ªstore_path\***

ä¿®æ”¹ï¼štracker_server

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430103918885-1176769680.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430103918885-1176769680.png)

### åˆ›å»ºç›®å½•(è‹¥ç›®å½•å·²å­˜åœ¨ï¼Œå¯å¿½ç•¥)

```
mkdir /cyb/server/fastdfs/storage -p
```

## é‡å¤Storage Serveré…ç½®æ­¥éª¤(è™šæ‹Ÿæœºåï¼šCentOS 6-FastDFS-03)

### ç”¨é€”

ã€€ã€€è¯¥æ­¥éª¤ç”¨äºæ¼”ç¤ºè´Ÿè½½å‡è¡¡ï¼Œå†—ä½™å¤‡ä»½

## å¯åŠ¨

### Trackerå¯åŠ¨å‘½ä»¤

```
/usr/bin/fdfs_trackerd /etc/fdfs/tracker.conf
```

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430113149911-1690094363.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430113149911-1690094363.png)

### Storageå¯åŠ¨å‘½ä»¤

```
 /usr/bin/fdfs_storaged /etc/fdfs/storage.conf
```

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430113254338-1511457839.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430113254338-1511457839.png)

### Trackerå¼€å¯è‡ªå¯åŠ¨

```
ç¼–è¾‘æ–‡ä»¶ï¼š
vim /etc/rc.d/rc.local

å°†ä»¥ä¸‹å†…å®¹æ·»åŠ åˆ°è¯¥æ–‡ä»¶ä¸­ï¼š
/usr/bin/fdfs_trackerd /etc/fdfs/tracker.conf
```

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430115429488-1115657855.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430115429488-1115657855.png)

### Storageå¼€å¯è‡ªå¯åŠ¨

```
ç¼–è¾‘æ–‡ä»¶ï¼š
vim /etc/rc.d/rc.local

å°†ä»¥ä¸‹å†…å®¹æ·»åŠ åˆ°è¯¥æ–‡ä»¶ä¸­ï¼š
/usr/bin/fdfs_storaged /etc/fdfs/storage.conf
```

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430115627610-1091350698.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430115627610-1091350698.png)

### é‡å¯

```
sudo /usr/bin/fdfs_trackerd /etc/fdfs/tracker.conf restart
sudo /usr/bin/fdfs_storaged /etc/fdfs/storage.conf restart
```

## è¡¥å……(é‡è¦)

æŸ¥çœ‹Storageæ—¥å¿—

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430113904641-2023428892.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430113904641-2023428892.png)

### **å…³é—­é˜²ç«å¢™ï¼ï¼ï¼**

```
1ã€å…³é—­å‘½ä»¤ï¼š service iptables stop
2ã€æ°¸ä¹…å…³é—­é˜²ç«å¢™ï¼šchkconfig iptables off
3ã€ä¸¤ä¸ªå‘½ä»¤åŒæ—¶è¿è¡Œå†…ï¼Œè¿è¡Œå®Œæˆå®¹åæŸ¥çœ‹é˜²ç«å¢™å…³é—­çŠ¶æ€
service iptables status
```

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430114148389-1071098313.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430114148389-1071098313.png)

## ä¸Šä¼ å›¾ç‰‡æµ‹è¯•

FastDFSå®‰è£…æˆåŠŸåå¯é€šè¿‡ã€fdfs_testã€‘å‘½ä»¤æµ‹è¯•ä¸Šä¼ ã€ä¸‹è½½ç­‰æ“ä½œ(**ä¸‰å°ä¸­çš„ä»»æ„ä¸€å°æµ‹è¯•å³å¯**)

### ä¿®æ”¹client.conf

```
 vim /etc/fdfs/client.conf
```

### ä¿®æ”¹å†…å®¹å¦‚ä¸‹

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430132528891-1023336245.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430132528891-1023336245.png)

### åˆ›å»ºç›®å½•

```
mkdir /cyb/server/fastdfs/client -p
```

### ä¸Šä¼ åˆ°FastDFSä¸­

```
æ ¼å¼ï¼š
/usr/bin/fdfs_test /etc/fdfs/client.conf upload æ–‡ä»¶è·¯å¾„

/usr/bin/fdfs_test /etc/fdfs/client.conf upload /home/1.txt
```

### ä¸Šä¼ æˆåŠŸ

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430140515460-1393688573.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430140515460-1393688573.png)

ã€€ã€€**æ­¤æ—¶è¿™ä¸ªåœ°å€æ˜¯è®¿é—®ä¸åˆ°çš„ï¼Œéœ€è¦ä¸Nginxæ•´åˆä½¿ç”¨ï¼Œæ–¹å¯è®¿é—®è¯¥æ–‡ä»¶ï¼**

### éªŒè¯ä¸¤å°æœºå™¨éƒ½ä¸Šä¼ æˆåŠŸ

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430141406596-2095383822.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430141406596-2095383822.png)

## Tracker.confé…ç½®æ–‡ä»¶

### é…ç½®å‚æ•°è¯´æ˜

```
ï¼ƒæ­¤é…ç½®æ–‡ä»¶æ˜¯å¦å·²ç¦ç”¨
ï¼ƒfalseä¸ºå¯ç”¨
ï¼ƒä¸ºæ®‹ç–¾äººå£«é€‚ç”¨
ç¦ç”¨=å‡

ï¼ƒç»‘å®šè¯¥ä¸»æœºçš„åœ°å€
ï¼ƒç©ºç”¨äºç»‘å®šæ­¤ä¸»æœºçš„æ‰€æœ‰åœ°å€
bind_addr =

ï¼ƒè·Ÿè¸ªå™¨æœåŠ¡å™¨ç«¯å£
ç«¯å£= 22122

ï¼ƒè¿æ¥è¶…æ—¶ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰
ï¼ƒé»˜è®¤å€¼ä¸º30ç§’
connect_timeout = 10

ï¼ƒç½‘ç»œè¶…æ—¶ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰
ï¼ƒé»˜è®¤å€¼ä¸º30ç§’
network_timeout = 60

ï¼ƒå­˜å‚¨æ•°æ®å’Œæ—¥å¿—æ–‡ä»¶çš„åŸºæœ¬è·¯å¾„
base_path = / home / yuqing / fastdfs

ï¼ƒæ­¤æœåŠ¡å™¨æ”¯æŒçš„æœ€å¤§å¹¶å‘è¿æ¥æ•°
ï¼ƒæ‚¨åº”è¯¥å°†æ­¤å‚æ•°è®¾ç½®å¾—æ›´å¤§ä¸€äº›ï¼Œä¾‹å¦‚ã€‚102400
max_connections = 1024

ï¼ƒæ¥å—çº¿ç¨‹æ•°
ï¼ƒé»˜è®¤å€¼ä¸º1
ï¼ƒè‡ªV4.07èµ·
accept_threads = 1

ï¼ƒå·¥ä½œçº¿ç¨‹æ•°ï¼Œåº”<= max_connections
ï¼ƒé»˜è®¤å€¼ä¸º4
è‡ªV2.00èµ·
work_threads = 4

ï¼ƒæœ€å°æŠ›å…‰é‡
ï¼ƒé»˜è®¤å€¼8KB
min_buff_size = 8KB

ï¼ƒæœ€å¤§å¢ç›Š
ï¼ƒé»˜è®¤å€¼128KB
max_buff_size = 128KB

ï¼ƒé€‰æ‹©ä¸Šä¼ æ–‡ä»¶ç»„çš„æ–¹æ³•
ï¼ƒ0ï¼šå¾ªç¯èµ›
ï¼ƒ1ï¼šæŒ‡å®šç»„
ï¼ƒ2ï¼šè´Ÿè½½å‡è¡¡ï¼Œé€‰æ‹©æœ€å¤§å¯ç”¨ç©ºé—´ç»„æ¥ä¸Šä¼ æ–‡ä»¶
store_lookup = 2

ï¼ƒä¸Šä¼ æ–‡ä»¶çš„ç»„
ï¼ƒå½“store_lookupè®¾ç½®ä¸º1æ—¶ï¼Œå¿…é¡»å°†store_groupè®¾ç½®ä¸ºç»„å
store_group = group2

ï¼ƒè¦ä¸Šä¼ æ–‡ä»¶çš„å­˜å‚¨æœåŠ¡å™¨
ï¼ƒ0ï¼šå¾ªç¯ï¼ˆé»˜è®¤ï¼‰
ï¼ƒ1ï¼šç¬¬ä¸€ä¸ªæœåŠ¡å™¨æŒ‰IPåœ°å€æ’åº
ï¼ƒ2ï¼šæŒ‰ä¼˜å…ˆçº§æ’åˆ—çš„ç¬¬ä¸€ä¸ªæœåŠ¡å™¨é¡ºåºï¼ˆæœ€å°ï¼‰
ï¼ƒæ³¨æ„ï¼šå¦‚æœuse_trunk_fileè®¾ç½®ä¸ºtrueï¼Œåˆ™å¿…é¡»å°†store_serverè®¾ç½®ä¸º1æˆ–2
store_server = 0

ï¼ƒå­˜å‚¨æœåŠ¡å™¨ä¸Šè½½æ–‡ä»¶çš„è·¯å¾„ï¼ˆè¡¨ç¤ºç£ç›˜æˆ–æŒ‚è½½ç‚¹ï¼‰
ï¼ƒ0ï¼šå¾ªç¯èµ›
ï¼ƒ2ï¼šè´Ÿè½½å‡è¡¡ï¼Œé€‰æ‹©æœ€å¤§å¯ç”¨ç©ºé—´è·¯å¾„ä¸Šä¼ æ–‡ä»¶
store_path = 0

ï¼ƒè¦ä¸‹è½½æ–‡ä»¶çš„å­˜å‚¨æœåŠ¡å™¨
ï¼ƒ0ï¼šå¾ªç¯ï¼ˆé»˜è®¤ï¼‰
ï¼ƒ1ï¼šå½“å‰æ–‡ä»¶ä¸Šä¼ åˆ°çš„æºå­˜å‚¨æœåŠ¡å™¨
download_server = 0

ï¼ƒä¸ºç³»ç»Ÿæˆ–å…¶ä»–åº”ç”¨ç¨‹åºä¿ç•™çš„å­˜å‚¨ç©ºé—´ã€‚
ï¼ƒå¦‚æœä»¥ä¸‹ä»»ä½•å­˜å‚¨æœåŠ¡å™¨çš„å¯ç”¨ï¼ˆå¯ç”¨ï¼‰ç©ºé—´ 
ï¼ƒä¸€ä¸ªç»„<= reserved_storage_spaceï¼Œ 
ï¼ƒæ²¡æœ‰æ–‡ä»¶å¯ä»¥ä¸Šä¼ åˆ°è¯¥ç»„ã€‚
ï¼ƒå­—èŠ‚å•ä½å¯ä»¥æ˜¯ä»¥ä¸‹ä¹‹ä¸€ï¼š
### Gæˆ–gè¡¨ç¤ºåƒå…†å­—èŠ‚ï¼ˆGBï¼‰
### Mæˆ–mè¡¨ç¤ºå…†å­—èŠ‚ï¼ˆMBï¼‰
### Kæˆ–kè¡¨ç¤ºåƒå­—èŠ‚ï¼ˆKBï¼‰
###æ— å­—èŠ‚å•ä½ï¼ˆBï¼‰
### XX.XXï¼…ä½œä¸ºæ¯”ä¾‹ï¼Œä¾‹å¦‚reserved_storage_space = 10ï¼…
reserved_storage_space = 20ï¼…

#standardæ—¥å¿—çº§åˆ«ä¸ºsyslogï¼Œä¸åŒºåˆ†å¤§å°å†™ï¼Œå€¼åˆ—è¡¨ï¼š
###ç´§æ€¥åº”æ€¥
###è­¦æŠ¥
###æš´å‡»
###é”™è¯¯
###è­¦å‘Šè­¦å‘Š
ï¼ƒï¼ƒï¼ƒ æ³¨æ„
###ä¿¡æ¯
###è°ƒè¯•
log_level =ä¿¡æ¯

#unixç»„åä»¥è¿è¡Œæ­¤ç¨‹åºï¼Œ 
ï¼ƒæœªè®¾ç½®ï¼ˆç©ºï¼‰è¡¨ç¤ºç”±å½“å‰ç”¨æˆ·ç»„è¿è¡Œ
run_by_group =

#unixç”¨æˆ·åä»¥è¿è¡Œæ­¤ç¨‹åºï¼Œ
ï¼ƒæœªè®¾ç½®ï¼ˆç©ºï¼‰è¡¨ç¤ºç”±å½“å‰ç”¨æˆ·è¿è¡Œ
run_by_user =

ï¼ƒallow_hostså¯ä»¥å¤šæ¬¡å‡ºç°ï¼Œhostå¯ä»¥æ˜¯ä¸»æœºåæˆ–IPåœ°å€ï¼Œ
ï¼ƒâ€œ *â€ï¼ˆä»…ä¸€ä¸ªæ˜Ÿå·ï¼‰è¡¨ç¤ºåŒ¹é…æ‰€æœ‰IPåœ°å€
ï¼ƒæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åƒ192.168.5.64/26è¿™æ ·çš„CIDR IP
ï¼ƒå¹¶ä½¿ç”¨ä»¥ä¸‹èŒƒå›´ï¼š10.0.1ã€‚[0-254]å’Œä¸»æœº[01-08,20-25] .domain.com
ï¼ƒ ä¾‹å¦‚ï¼š
ï¼ƒallow_hosts = 10.0.1ã€‚[1-15,20]
ï¼ƒallow_hosts = host [01-08,20-25] .domain.com
ï¼ƒallow_hosts = 192.168.5.64 / 26
allow_hosts = *

ï¼ƒæ¯éš”å‡ ç§’å°†æ—¥å¿—buffåŒæ­¥åˆ°ç£ç›˜
ï¼ƒé»˜è®¤å€¼ä¸º10ç§’
sync_log_buff_interval = 10

ï¼ƒæ£€æŸ¥å­˜å‚¨æœåŠ¡å™¨çš„æ´»åŠ¨é—´éš”ç§’æ•°
check_active_interval = 120

ï¼ƒçº¿ç¨‹å †æ ˆå¤§å°ï¼Œåº”> = 64KB
ï¼ƒé»˜è®¤å€¼ä¸º256KB
thread_stack_size = 256KB

ï¼ƒè‡ªåŠ¨è°ƒæ•´å­˜å‚¨æœåŠ¡å™¨çš„IPåœ°å€
ï¼ƒé»˜è®¤å€¼ä¸ºtrue
storage_ip_changed_auto_adjust = true

ï¼ƒå­˜å‚¨åŒæ­¥æ–‡ä»¶çš„æœ€å¤§å»¶è¿Ÿç§’æ•°
ï¼ƒé»˜è®¤å€¼ä¸º86400ç§’ï¼ˆä¸€å¤©ï¼‰
è‡ªV2.00èµ·
storage_sync_file_max_delay = 86400

ï¼ƒå­˜å‚¨æ–‡ä»¶åŒæ­¥çš„æœ€é•¿æ—¶é—´
ï¼ƒé»˜è®¤å€¼ä¸º300ç§’
è‡ªV2.00èµ·
storage_sync_file_max_time = 300

ï¼ƒå¦‚æœä½¿ç”¨ä¸­ç»§æ–‡ä»¶å­˜å‚¨å‡ ä¸ªå°æ–‡ä»¶
ï¼ƒé»˜è®¤å€¼ä¸ºfalse
ï¼ƒè‡ªV3.00èµ·
use_trunk_file =å¦ 

ï¼ƒæœ€å°æ’æ§½å¤§å°ï¼Œåº”<= 4KB
ï¼ƒé»˜è®¤å€¼ä¸º256å­—èŠ‚
ï¼ƒè‡ªV3.00èµ·
slot_min_size = 256

ï¼ƒæœ€å¤§æ’æ§½å¤§å°ï¼Œåº”> slot_min_size
ï¼ƒå½“ä¸Šä¼ æ–‡ä»¶çš„å¤§å°å°äºç­‰äºæ­¤å€¼æ—¶ï¼Œå°†å…¶å­˜å‚¨åˆ°ä¸­ç»§æ–‡ä»¶
ï¼ƒé»˜è®¤å€¼ä¸º16MB
ï¼ƒè‡ªV3.00èµ·
slot_max_size = 16MB

ï¼ƒä¸­ç»§æ–‡ä»¶å¤§å°ï¼Œåº”> = 4MB
ï¼ƒé»˜è®¤å€¼ä¸º64MB
ï¼ƒè‡ªV3.00èµ·
trunk_file_size = 64MB

ï¼ƒå¦‚æœé¢„å…ˆåˆ›å»ºä¸­ç»§æ–‡ä»¶
ï¼ƒé»˜è®¤å€¼ä¸ºfalse
ï¼ƒä»V3.06å¼€å§‹
trunk_create_file_advance =å¦

ï¼ƒåˆ›å»ºä¸­ç»§æ–‡ä»¶çš„æ—¶åŸº
ï¼ƒæ—¶é—´æ ¼å¼ï¼šHHï¼šMM
ï¼ƒé»˜è®¤å€¼ä¸º02:00
ï¼ƒä»V3.06å¼€å§‹
trunk_create_file_time_base = 02:00

ï¼ƒåˆ›å»ºTrunkæ–‡ä»¶çš„æ—¶é—´é—´éš”ï¼Œå•ä½ï¼šç§’
ï¼ƒé»˜è®¤å€¼ä¸º38400ï¼ˆä¸€å¤©ï¼‰
ï¼ƒä»V3.06å¼€å§‹
trunk_create_file_interval = 86400

ï¼ƒåˆ›å»ºä¸­ç»§æ–‡ä»¶çš„é˜ˆå€¼
ï¼ƒå½“ç©ºé—²ä¸­ç»§æ–‡ä»¶å¤§å°å°äºé˜ˆå€¼æ—¶ï¼Œå°†åˆ›å»º 
ï¼ƒä¸­ç»§æ–‡ä»¶
ï¼ƒé»˜è®¤å€¼ä¸º0
ï¼ƒä»V3.06å¼€å§‹
trunk_create_file_space_threshold = 20G

ï¼ƒåŠ è½½è¡Œæç®±ç©ºé—²ç©ºé—´æ—¶æ˜¯å¦æ£€æŸ¥è¡Œæç®±ç©ºé—´å ç”¨
ï¼ƒå ç”¨çš„ç©ºé—´å°†è¢«å¿½ç•¥
ï¼ƒé»˜è®¤å€¼ä¸ºfalse
ï¼ƒè‡ªV3.09èµ·
ï¼ƒæ³¨æ„ï¼šå°†æ­¤å‚æ•°è®¾ç½®ä¸ºtrueä¼šå‡æ…¢è¡Œæç®±ç©ºé—´çš„åŠ è½½ 
ï¼ƒå¯åŠ¨æ—¶ã€‚æ‚¨åº”åœ¨å¿…è¦æ—¶å°†æ­¤å‚æ•°è®¾ç½®ä¸ºtrueã€‚
trunk_init_check_occupying =å¦

ï¼ƒå¦‚æœå¿½ç•¥storage_trunk.datï¼Œåˆ™ä»ä¸­ç»§binlogé‡æ–°åŠ è½½
ï¼ƒé»˜è®¤å€¼ä¸ºfalse
ï¼ƒè‡ªV3.10èµ·
ï¼ƒå¦‚æœç‰ˆæœ¬ä½äºV3.10ï¼Œåˆ™ä¸€æ¬¡è®¾ç½®ä¸ºtrueè¿›è¡Œç‰ˆæœ¬å‡çº§
trunk_init_reload_from_binlog =å¦

ï¼ƒå‹ç¼©ä¸­ç»§binlogæ–‡ä»¶çš„æœ€å°é—´éš”
ï¼ƒå•ä½ï¼šç§’
ï¼ƒé»˜è®¤å€¼ä¸º0ï¼Œ0è¡¨ç¤ºæ°¸ä¸å‹ç¼©
ï¼ƒåœ¨ä¸»å¹²åˆå§‹åŒ–å’Œä¸»å¹²é”€æ¯æ—¶ï¼ŒFastDFSå‹ç¼©ä¸»å¹²binlog
ï¼ƒé‡æ–°å‘½ä»¤å°†æ­¤å‚æ•°è®¾ç½®ä¸º86400ï¼ˆä¸€å¤©ï¼‰
ï¼ƒè‡ªV5.01èµ·
trunk_compress_binlog_min_interval = 0

ï¼ƒå¦‚æœä½¿ç”¨å­˜å‚¨IDä»£æ›¿IPåœ°å€
ï¼ƒé»˜è®¤å€¼ä¸ºfalse
ï¼ƒè‡ªV4.00èµ·
use_storage_id =å‡

ï¼ƒæŒ‡å®šå­˜å‚¨IDçš„æ–‡ä»¶åï¼Œå¯ä»¥ä½¿ç”¨ç›¸å¯¹æˆ–ç»å¯¹è·¯å¾„
ï¼ƒè‡ªV4.00èµ·
storage_ids_filename = storage_ids.conf

ï¼ƒæ–‡ä»¶åä¸­å­˜å‚¨æœåŠ¡å™¨çš„idç±»å‹ï¼Œå€¼æ˜¯ï¼š
## ipï¼šå­˜å‚¨æœåŠ¡å™¨çš„IPåœ°å€
## idï¼šå­˜å‚¨æœåŠ¡å™¨çš„æœåŠ¡å™¨ID
ï¼ƒä»…å½“use_storage_idè®¾ç½®ä¸ºtrueæ—¶ï¼Œæ­¤å‚æ•°æ‰æœ‰æ•ˆ
ï¼ƒé»˜è®¤å€¼ä¸ºip
ä»V4.03å¼€å§‹
id_type_in_filename = id

ï¼ƒå¦‚æœå­˜å‚¨ä»å±æ–‡ä»¶ä½¿ç”¨ç¬¦å·é“¾æ¥
ï¼ƒé»˜è®¤å€¼ä¸ºfalse
ï¼ƒè‡ªV4.01èµ·
store_slave_file_use_link = false

ï¼ƒå¦‚æœæ¯å¤©æ—‹è½¬é”™è¯¯æ—¥å¿—
ï¼ƒé»˜è®¤å€¼ä¸ºfalse
ä»V4.02å¼€å§‹
rotation_error_log =å¦

ï¼ƒæ—‹è½¬é”™è¯¯æ—¥å¿—çš„æ—¶åŸºï¼Œæ—¶é—´æ ¼å¼ï¼šå°æ—¶ï¼šåˆ†é’Ÿ
ï¼ƒå°æ—¶ä»0åˆ°23ï¼Œåˆ†é’Ÿä»0åˆ°59
ï¼ƒé»˜è®¤å€¼ä¸º00:00
ä»V4.02å¼€å§‹
error_log_rotate_time = 00ï¼š00

ï¼ƒå½“æ—¥å¿—æ–‡ä»¶è¶…è¿‡æ­¤å¤§å°æ—¶æ—‹è½¬é”™è¯¯æ—¥å¿—
ï¼ƒ0è¡¨ç¤ºæ°¸ä¸æŒ‰æ—¥å¿—æ–‡ä»¶å¤§å°æ—‹è½¬æ—¥å¿—æ–‡ä»¶
ï¼ƒé»˜è®¤å€¼ä¸º0
ä»V4.02å¼€å§‹
rotation_error_log_size = 0

ï¼ƒä¿ç•™æ—¥å¿—æ–‡ä»¶çš„å¤©æ•°
ï¼ƒ0è¡¨ç¤ºä¸åˆ é™¤æ—§çš„æ—¥å¿—æ–‡ä»¶
ï¼ƒé»˜è®¤å€¼ä¸º0
log_file_keep_days = 0

ï¼ƒå¦‚æœä½¿ç”¨è¿æ¥æ± 
ï¼ƒé»˜è®¤å€¼ä¸ºfalse
ï¼ƒè‡ªV4.05èµ·
use_connection_pool =å¦

ï¼ƒç©ºé—²æ—¶é—´è¶…è¿‡æ­¤æ—¶é—´çš„è¿æ¥å°†è¢«å…³é—­
ï¼ƒå•ä½ï¼šç§’
ï¼ƒé»˜è®¤å€¼ä¸º3600
ï¼ƒè‡ªV4.05èµ·
connection_pool_max_idle_time = 3600

ï¼ƒè¯¥è·Ÿè¸ªå™¨æœåŠ¡å™¨ä¸Šçš„HTTPç«¯å£
http.server_port = 8080

ï¼ƒæ£€æŸ¥å­˜å‚¨HTTPæœåŠ¡å™¨çš„æ´»åŠ¨é—´éš”ç§’æ•°
ï¼ƒ<= 0è¡¨ç¤ºæ°¸ä¸æ£€æŸ¥
ï¼ƒé»˜è®¤å€¼ä¸º30
http.check_alive_interval = 30

ï¼ƒæ£€æŸ¥å­˜å‚¨HTTPæœåŠ¡å™¨çš„æ´»åŠ¨ç±»å‹ï¼Œå€¼æ˜¯ï¼š
ï¼ƒtcpï¼šä»…ä½¿ç”¨HTTPç«¯å£è¿æ¥åˆ°storgeæœåŠ¡å™¨ï¼Œ 
ï¼ƒä¸è¦æ±‚è·å¾—å›åº”
ï¼ƒhttpï¼šå­˜å‚¨æ£€æŸ¥æœ‰æ•ˆç½‘å€å¿…é¡»è¿”å›httpçŠ¶æ€200
ï¼ƒé»˜è®¤å€¼ä¸ºtcp
http.check_alive_type = tcp

ï¼ƒæ£€æŸ¥å­˜å‚¨HTTPæœåŠ¡å™¨æ˜¯å¦å­˜åœ¨uri / url
ï¼ƒæ³¨æ„ï¼šå­˜å‚¨åµŒå…¥HTTPæœåŠ¡å™¨æ”¯æŒuriï¼š/status.html
http.check_alive_uri = / status.html
```

# å®‰è£…Nginx(Apache)

## å®‰è£…äº‹é¡¹

ã€€ã€€**Nginx**éœ€è¦**å®‰è£…**åœ¨**æ¯ä¸€å°****StorageæœåŠ¡å™¨ä¸Š**ï¼Œ**TrackeræœåŠ¡å™¨**ä¸Š**ä¸**éœ€è¦**å®‰è£…**ï¼ï¼ï¼ï¼Nginxä¸æ˜ç™½çš„ç«¥é‹ï¼Œå¯ä»¥çœ‹æˆ‘å¦ä¸€ç¯‡åšå®¢ï¼š[ä»å…¥é—¨åˆ°ç²¾é€š-Nginxï¼Œå›¾æ–‡å¹¶èŒ‚ã€è´Ÿè½½å‡è¡¡ã€åŠ¨é™åˆ†ç¦»ã€è™šæ‹Ÿä¸»æœº é™„æ¡ˆä¾‹æºç ](https://www.cnblogs.com/chenyanbin/p/12521296.html)

## ä¸‹è½½æ–‡ä»¶

[ç‚¹æˆ‘ç›´è¾¾](http://nginx.org/en/download.html) 

### è¡¥å……

```
ä¸Šä¼ æ–‡ä»¶å¯ä»¥ç”¨ï¼š
1ã€yum install -y lrzsz

2ã€rz
```

## å®‰è£…ä¾èµ–åº“

```
1ã€yum install -y gcc-c++ gcc   (Cè¯­è¨€ä¾èµ–åº“ï¼Œè‹¥å®‰è£…è¿‡ï¼Œå¯ä¸å®‰è£…)

pcre-develï¼špcreï¼ŒPerl Compatible Regular Expressionsï¼ŒPerlè„šæœ¬è¯­è¨€å…¼å®¹æ­£åˆ™è¡¨è¾¾å¼ï¼Œä¸ºNginxæä¾›æ­£åˆ™è¡¨è¾¾å¼åº“ã€‚
openssl-develï¼šä¸ºNginxæä¾›SSL(å®‰å…¨å¥—æ¥å­—å±‚ï¼‰å¯†ç åº“ï¼ŒåŒ…å«ä¸»è¦çš„å¯†ç ç®—æ³•ï¼Œå¸¸ç”¨çš„å¯†é’¥å’Œè¯ä¹¦å°è£…ç®¡ç†åŠŸèƒ½åŠSSLåè®®ï¼Œå¹¶æä¾›ä¸°å¯Œçš„åº”ç”¨ç¨‹åºä¾›æµ‹è¯•æˆ–å…¶ä»–ç›®çš„ä½¿ç”¨ã€‚
2ã€yum -y install pcre-devel openssl-devel
```

## è§£å‹ç¼©

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430151218303-870972615.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430151218303-870972615.png)

## æ‰§è¡Œconfigureé…ç½®

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430154401216-288781660.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430154401216-288781660.png)

## ç¼–è¯‘ä¸å®‰è£…

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430154610368-433994741.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430154610368-433994741.png)

## ä¿®æ”¹nginx.conf

```
vim /cyb/server/nginx/conf/nginx.conf
```

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430160313654-1940127721.png)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430160313654-1940127721.png)

**æ³¨ï¼šæˆ‘çš„nginx.confé‡Œé¢å†…å®¹æ¯”è¾ƒå°‘ï¼Œæ˜¯å› ä¸ºæˆ‘æŠŠæ²¡ç”¨åˆ°çš„ä¸œè¥¿åˆ æ‰äº†ï¼~**

## å»ºç«‹è½¯é“¾æ¥

```
ln -n  /cyb/server/nginx/sbin/nginx  /usr/local/sbin
```

æ³¨ï¼šå»ºç«‹å®Œè½¯é“¾æ¥ä¹‹åï¼Œå°±å¯ä»¥åœ¨ä»»æ„ä½ç½®æ‰§è¡Œ

## å¯åŠ¨nginx

æ³¨ï¼šå¯åŠ¨å‰ï¼Œå¯ä»¥å…ˆæ‰§è¡Œä¸‹ï¼šnginx -tqï¼Œçœ‹ä¼šä¸ä¼šæŠ¥é”™ï¼Œæ²¡æŠ¥é”™ï¼Œè¯´æ˜nginx.confé…ç½®æ–‡ä»¶ï¼Œé…ç½®çš„å‚æ•°æ˜¯æ­£ç¡®çš„

```
nginx
```

### æµ‹è¯•

[![img](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430162328435-1455615759.gif)](https://img2020.cnblogs.com/blog/1504448/202004/1504448-20200430162328435-1455615759.gif)

ã€€ã€€åˆ°ç›®å‰ä¸ºæ­¢ï¼Œnginxå·²ç»å¯ä»¥æ­£å¸¸è®¿é—®FastDFSä¸Šä¼ çš„æ–‡ä»¶å†…å®¹äº†ã€‚

# FastDFS-Nginxé…ç½®æ‰©å±•æ¨¡å—(é‡è¦)

## é‡‡å‘ä¹‹è·¯

ã€€ã€€nginxå¦‚æœåœ¨åŸæ¥çš„åŸºç¡€æ¨¡å—ä¸Šï¼Œè¿½åŠ æ–°æ¨¡å—ï¼Œé‡æ–°ç¼–è¯‘ï¼ŒåŸå…ˆçš„ä¸ä¼šè¦†ç›–ï¼Œæˆ‘ä¸çŸ¥é“æ˜¯ç‰ˆæœ¬çš„åŸå› è¿˜æ˜¯æ€ä¹ˆå›äº‹ï¼Œæˆ‘çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯æŠŠåŸå…ˆçš„nginxï¼Œå…ˆåˆ æ‰ï¼Œåœ¨é‡æ–°ä¸€æ¬¡æ€§ç¼–è¯‘ä¸å®‰è£…ã€‚

```
rm -rf /etc/nginx/ --nginxçš„å®‰è£…ç›®å½•
rm -rf /usr/sbin/nginx

å¦‚æœå»ºç«‹è½¯è¿æ¥çš„è¯ï¼Œåˆ«å¿˜è®°ä¸€å—åˆ äº†å“¦
rm -rf /usr/local/sbin/nginx
```

[![img](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200505141826372-341108779.png)](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200505141826372-341108779.png)

## èƒŒæ™¯

ã€€ã€€ä¸Šé¢ç¤ºä¾‹ï¼Œ**FastDFSä¸Šä¼ çš„æ–‡ä»¶**ï¼Œ**å·²ç»å¯ä»¥é€šè¿‡nginxæ­£å¸¸è®¿é—®**äº†ï¼Œ**ä¸ºä»€ä¹ˆè¿˜è¦ä½¿ç”¨Nginxæ‰©å±•æ¨¡å—æ¥è®¿é—®å­˜å‚¨æ–‡ä»¶å‘¢ï¼Ÿ**

1. **å¦‚æœè¿›è¡Œæ–‡ä»¶åˆå¹¶**ï¼Œé‚£ä¹ˆä¸ä½¿ç”¨FastDFSçš„Nginxæ‰©å±•æ¨¡å—ï¼Œæ˜¯æ— æ³•è®¿é—®åˆ°å…·ä½“çš„æ–‡ä»¶çš„ï¼Œå› ä¸ºæ–‡ä»¶åˆå¹¶ä¹‹åï¼Œå¤šä¸ªå°æ–‡ä»¶éƒ½æ˜¯å­˜å‚¨åœ¨ä¸€ä¸ªtrunkæ–‡ä»¶ä¸­çš„ï¼Œåœ¨å­˜å‚¨ç›®å½•ä¸‹ï¼Œæ˜¯çœ‹ä¸åˆ°å…·ä½“çš„å°æ–‡ä»¶çš„ã€‚
2. **å¦‚æœæ–‡ä»¶æœªåŒæ­¥æˆåŠŸ**ï¼Œé‚£ä¹ˆä¸é€‚ç”¨FastDFSçš„Nginxæ‰©å±•æ¨¡å—ï¼Œæ˜¯æ— æ³•æ­£å¸¸è®¿é—®åˆ°æŒ‡å®šçš„æ–‡ä»¶çš„ï¼Œè€Œä½¿ç”¨äº†FastDFSçš„Nginxæ‰©å±•æ¨¡å—ä¹‹åï¼Œå¦‚æœè¦è®¿é—®çš„æ–‡ä»¶æœªåŒæ­¥æˆåŠŸï¼Œé‚£ä¹ˆä¼šè§£æå‡ºæ¥è¯¥æ–‡ä»¶çš„æºå­˜å‚¨æœåŠ¡å™¨ipï¼Œç„¶åå°†è®¿é—®è¯·æ±‚é‡å®šå‘æˆ–è€…ä»£ç†åˆ°æºå­˜å‚¨æœåŠ¡å™¨ä¸­è¿›è¡Œè®¿é—®ã€‚

## ä¸‹è½½æ–‡ä»¶

**æ³¨ï¼šFastDFSçš„Nginxæ‰©å±•æ¨¡å—éœ€è¦å®‰è£…åˆ°æ¯ä¸ªStorage Serverä¸­**

```
githubï¼šhttps://github.com/happyfish100/fastdfs-nginx-module/releases/tag/V1.22
```

[![img](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200504195339879-1343327546.png)](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200504195339879-1343327546.png)

## è§£å‹ç¼©

[![img](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200504200039737-1827666880.png)](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200504200039737-1827666880.png)

## ä¿®æ”¹configæ–‡ä»¶(å…³é”®ä¸€æ­¥)

[![img](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200504200318714-312087882.png)](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200504200318714-312087882.png)

### ä¿®æ”¹ç¬¬6ã€15è¡Œçš„å†…å®¹

[![img](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200504201506508-1752484532.png)](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200504201506508-1752484532.png)

```
ç¬¬6è¡Œï¼š
ngx_module_incs="/usr/include/fastdfs /usr/include/fastcommon/"

ç¬¬15è¡Œï¼š
CORE_INCS="$CORE_INCS /usr/include/fastdfs /usr/include/fastcommon/"
```

## æ‹·è´mod_fastdfs.conf

å°†/cyb/soft/fastdfs-nginx-module-1.22/src/mod_fastdfs.confæ‹·è´è‡³/etc/fdfs/ä¸‹

```
cp /cyb/soft/fastdfs-nginx-module-1.22/src/mod_fastdfs.conf /etc/fdfs/
```

## ä¿®æ”¹mod_fastdfs.conf

```
vim /etc/fdfs/mod_fastdfs.conf
base_path=/cyb/server/fastdfs/storage # åŸºç¡€è·¯å¾„,å­˜å‚¨æ—¥å¿—æ–‡ä»¶
tracker_server=192.168.31.220:22122  # trackeræœåŠ¡å™¨çš„ip 
url_have_group_name=true  # urlä¸­æ˜¯å¦åŒ…å«groupåç§°
store_path0=/cyb/server/fastdfs/storage # æŒ‡å®šæ–‡ä»¶å­˜å‚¨è·¯å¾„ï¼Œè®¿é—®æ—¶ä½¿ç”¨è¯¥è·¯å¾„
```

## æ‹·è´libfdfsclient.so(é«˜ç‰ˆæœ¬å¯å¿½ç•¥)

```
cp /usr/lib64/libfdfsclient.so /usr/lib/
```

**æ³¨ï¼šè‹¥/usr/lib/ä¸‹å·²å­˜åœ¨libfdfsclient.soï¼Œåˆ™æ­¤æ­¥éª¤å¯å¿½ç•¥ï¼ï¼ï¼**

## æ‰§è¡Œconfigureé…ç½®

[![img](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200504214549009-113993284.png)](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200504214549009-113993284.png)

## é‡æ–°ç¼–è¯‘ä¸å®‰è£…

[![img](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200504212940822-317677021.png)](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200504212940822-317677021.png)

## é‡å¯å¹¶æŸ¥çœ‹æ‰©å±•åŒ…

```
nginx -V    --->Væ˜¯å¤§å†™çš„

æ˜¾ç¤º--add-moduleï¼Œæ‰ä»£è¡¨å®‰è£…æ¨¡å—æˆåŠŸï¼Œæ²¡æˆåŠŸçš„ï¼Œè¯·çœ‹æˆ‘é‡‡å‘ä¹‹è·¯ä»‹ç»
```

[![img](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200505143121633-157388388.png)](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200505143121633-157388388.png)

## ä¿®æ”¹nginx.confé…ç½® 

[![img](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200505143350264-2046763758.png)](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200505143350264-2046763758.png)

## æå®š

ä¸€æ ·å¯ä»¥æ­£å¸¸è®¿é—®

[![img](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200505143428255-494863774.png)](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200505143428255-494863774.png)

# Javaå®¢æˆ·ç«¯

## githubä¸‹è½½

```
https://github.com/happyfish100/fastdfs-client-java/releases/tag/V1.26
```

å¦‚ä½•æ‰“åŒ…ï¼Œè¯·çœ‹ï¼šhttps://www.cnblogs.com/chenyanbin/p/12831553.html

æ³¨æ„ä¿®æ”¹pom.xmlä¸­çš„<jdk.version>ç‰ˆæœ¬

## Mavenä¾èµ–

```
        <!--fastdfsä¾èµ–-->
        <dependency>
            <groupId>org.csource</groupId>
            <artifactId>fastdfs-client-java</artifactId>
            <version>1.27-SNAPSHOT</version>
        </dependency>
```

## javaé¡¹ç›®ç»“æ„

[![img](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200505183822750-1618687285.png)](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200505183822750-1618687285.png) 

### pom.xml

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.cyb</groupId>
    <artifactId>fastdfs-demo</artifactId>
    <version>1.0-SNAPSHOT</version>
    <dependencies>
        <!--fastdfsä¾èµ–-->
        <dependency>
            <groupId>org.csource</groupId>
            <artifactId>fastdfs-client-java</artifactId>
            <version>1.27-SNAPSHOT</version>
        </dependency>
    </dependencies>

</project>
```

### fdfs_client.conf

```
tracker_server=192.168.31.220:22122
```

### FastDFSClient.java

```
package com.cyb.fdfs.client;

import org.csource.common.NameValuePair;
import org.csource.fastdfs.*;
import java.net.URLDecoder;

public class FastDFSClient {
    private static TrackerClient trackerClient = null;
    private static TrackerServer trackerServer = null;
    private static StorageServer storageServer = null;
    private static StorageClient1 client = null;
    // fdfsClientçš„é…ç½®æ–‡ä»¶è·¯å¾„
    private static String CONF_NAME="/fdfs/fdfs_client.conf";


    static {
        try{
            //é…ç½®æ©å»ºå¿…é¡»åˆ¶å®šå…¨è·¯å¾„
            String confName=FastDFSClient.class.getResource(CONF_NAME).getPath();
            //é…ç½®æ–‡ä»¶å…¨è·¯å¾„å¦‚æœæœ‰ä¸­æ–‡ï¼Œéœ€è¦è¿›è¡Œutf8è½¬ç 
            confName= URLDecoder.decode(confName,"utf8");

            ClientGlobal.init(confName);
            trackerClient=new TrackerClient();
            trackerServer=trackerClient.getConnection();
            storageServer=null;
            client=new StorageClient1(trackerServer,storageServer);
        }
        catch (Exception e){
            e.printStackTrace();
        }
    }

    /**
     * ä¸Šä¼ æ–‡ä»¶æ–¹æ³•
     * @param fileName æ–‡ä»¶å…¨è·¯å¾„
     * @param extName æ–‡ä»¶æ‰©å±•åï¼Œä¸åŒ…å«(.)
     * @param metas æ–‡ä»¶æ‰©å±•ä¿¡æ¯
     * @return
     * @throws Exception
     */
    public static String uploadFile(String fileName, String extName, NameValuePair[] metas) throws Exception{
        String result = client.upload_file1(fileName, extName, metas);
        System.out.println(result);
        return result;
    }

    public static void main(String[] args) {
        try
        {
            uploadFile("/Users/chenyanbin/Desktop/1.jpg","jpg",null);
        }
        catch (Exception e){
            e.printStackTrace();
        }
    }
}
```

**æ³¨ï¼šè¿™æ¬¡æˆ‘åªå†™äº†ä¸€ä¸ªä¸Šä¼ çš„ï¼Œä»–ä¼šè¿”å›ä¸€ç›´Stringå­—ç¬¦ä¸²ï¼Œä¹Ÿå°±æ˜¯æ–‡ä»¶å­˜å‚¨çš„ä½ç½®ï¼Œå‰é¢åœ¨è¿½åŠ ipï¼Œæ‹¼æˆurlï¼Œç›´æ¥å¯ä»¥è®¿é—®ï¼Œè¿™é‡Œçš„clientè¿˜æœ‰å…¶ä»–APIï¼Œè‡ªè¡ŒæŸ¥é˜…ï¼Œclient.API**

## æµ‹è¯•

ä¸Šä¼ æœ¬åœ°çš„1.jpgï¼Œç„¶åé€šè¿‡ip+è¿”å›å­—ç¬¦ä¸²ï¼Œæ‹¼æˆurlè®¿é—®

[![img](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200505184319944-1360639547.gif)](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200505184319944-1360639547.gif)

## é¡¹ç›®ä¸mavenä¾èµ–æºç ä¸‹è½½

```
é“¾æ¥: https://pan.baidu.com/s/11kZfO_MRvwErnseWSVgSog  å¯†ç : d0pp
```

mavenæºç åŒ…ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘

# åˆå¹¶å­˜å‚¨(é‡è¦)

## ç®€ä»‹

ã€€ã€€åœ¨å¤„ç†æµ·é‡å°æ–‡ä»¶é—®é¢˜ä¸Šï¼Œæ–‡ä»¶ç³»ç»Ÿå¤„ç†æ€§èƒ½ä¼šå—åˆ°æ˜¾è‘—çš„å½±å“ï¼Œåœ¨è¯»æ­¤ä¹¦(IOPS)ä¸ååé‡(Throughput)è¿™ä¸¤ä¸ªæŒ‡æ ‡ä¸Šä¼šæœ‰ä¸å°‘çš„ä¸‹é™ã€‚ä¸»è¦éœ€è¦é¢å¯¹å¦‚ä¸‹å‡ ä¸ªé—®é¢˜

- **å…ƒæ•°æ®ç®¡ç†ä½æ•ˆ**ï¼Œç£ç›˜æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œç›®å½•é¡¹(dentry)ã€ç´¢å¼•èŠ‚ç‚¹(inode)å’Œæ•°æ®(data)ä¿å­˜åœ¨ä»‹è´¨çš„ä¸åŒä½ç½®ä¸Šã€‚å› æ­¤ï¼Œ**è®¿é—®ä¸€ä¸ªæ–‡ä»¶éœ€è¦ç»å†è‡³å°‘3æ¬¡ç‹¬ç«‹çš„è®¿é—®**ã€‚è¿™æ ·ï¼Œå¹¶å‘å°æ–‡ä»¶è®¿é—®å°±è½¬å˜æˆäº†å¤§é‡çš„éšæœºè®¿é—®ï¼Œè€Œè¿™ç§è®¿é—®å¹¿æ³›ä½¿ç”¨çš„ç£ç›˜æ¥è¯´æ˜¯éå¸¸ä½æ•ˆçš„
- **æ•°æ®å¸ƒå±€ä½æ•ˆ**
- **IOè®¿é—®æµç¨‹å¤æ‚**ï¼Œå› æ­¤ä¸€ç§è§£å†³é€”å¾„å°±æ˜¯å°†å°æ–‡ä»¶åˆå¹¶å­˜å‚¨æˆå¤§æ–‡ä»¶ï¼Œä½¿ç”¨seekæ¥å®šä½åˆ°å¤§æ–‡ä»¶çš„æŒ‡å®šä½ç½®æ¥è®¿é—®è¯¥å°æ–‡ä»¶ã€‚

 æ³¨ï¼š

ã€€ã€€FastDFSæä¾›çš„åˆå¹¶å­˜å‚¨åŠŸèƒ½ï¼Œé»˜è®¤åˆ›å»ºçš„**å¤§æ–‡ä»¶ä¸º64MB**ï¼Œç„¶ååœ¨**è¯¥å¤§æ–‡ä»¶ä¸­å­˜å‚¨å¾ˆå¤šå°æ–‡ä»¶**ã€‚å¤§æ–‡ä»¶ä¸­å®¹çº³ä¸€ä¸ªå°æ–‡ä»¶çš„ç©ºé—´ç§°ä¸ºä¸€ä¸ªSlotï¼Œè§„å®š**Slotæœ€å°å€¼ä¸º256å­—èŠ‚**ï¼Œ**æœ€å¤§ä¸º16MB**ï¼Œä¹Ÿå°±æ˜¯å°äº256å­—èŠ‚çš„æ–‡ä»¶ä¹Ÿéœ€è¦å ç”¨256å­—èŠ‚ï¼Œ**è¶…è¿‡16MBçš„æ–‡ä»¶ä¸ä¼šåˆå¹¶å­˜å‚¨è€Œæ˜¯åˆ›å»ºç‹¬ç«‹çš„æ–‡ä»¶**ã€‚

## åˆå¹¶å­˜å‚¨é…ç½®

ã€€ã€€FastDFSæä¾›äº†åˆå¹¶å­˜å‚¨åŠŸèƒ½ï¼Œæ‰€æœ‰çš„é…ç½®åœ¨tracker.confæ–‡ä»¶ä¹‹ä¸­ï¼Œå¼€å¯åˆå¹¶å­˜å‚¨åªéœ€è¦è®¾ç½®æ¯”ï¼š**use_trunk_file=true å’Œstore_server=1**

## ä¿®æ”¹tracker.conf(ä¿®æ”¹çš„trackeræœåŠ¡å™¨)

```
 vim /etc/fdfs/tracker.conf
```

### store_serveræ”¹ä¸º1

[![img](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200506175702878-1205747253.png)](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200506175702878-1205747253.png)

 

###  use_trunk_fileæ”¹true

[![img](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200506175823825-214299406.png)](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200506175823825-214299406.png)

 

## é‡å¯tracker

```
/usr/bin/fdfs_trackerd /etc/fdfs/tracker.conf restart
```

# å­˜å‚¨ç¼©ç•¥å›¾

## FastDFSä¸»ä»æ–‡ä»¶

### åº”ç”¨èƒŒæ™¯

ã€€ã€€ä½¿ç”¨FastDFSå­˜å‚¨ä¸€ä¸ªå›¾ç‰‡çš„å¤šä¸ªåˆ†è¾¨ç‡çš„å¤‡ä»½æ—¶ï¼Œå¸Œæœ›åªè®°å½•æºå›¾çš„fileidï¼Œå¹¶èƒ½å°†å…¶åˆ†è¾¨ç‡çš„å›¾ç‰‡ä¸æºå›¾å…³è”ã€‚å¯ä»¥ä½¿ç”¨ä»æ–‡ä»¶æ–¹æ³•

### è§£å†³åŠæ³•

åè¯æ³¨è§£ï¼šä¸»ä»æ–‡ä»¶æ˜¯æŒ‡æ–‡ä»¶IDæœ‰å…³è”çš„æ–‡ä»¶ï¼Œä¸€ä¸ªä¸»æ–‡ä»¶å¯ä»¥å¯¹åº”å¤šä¸ªä»æ–‡ä»¶ã€‚

- ä¸»æ–‡ä»¶ID=ä¸»æ–‡ä»¶å+ä¸»æ–‡ä»¶æ‰©å±•å
- ä»æ–‡ä»¶ID=ä¸»æ–‡ä»¶å+ä»æ–‡ä»¶åç¼€å(å¦‚ï¼š200*200)+ä»æ–‡ä»¶æ‰©å±•å

### æµç¨‹è¯´æ˜

ã€€ã€€1ã€å…ˆä¸Šä¼ ä¸»æ–‡ä»¶(æ—¢ï¼šæºæ–‡ä»¶ï¼Œå¾—åˆ°ä¸»æ–‡ä»¶FID)

ã€€ã€€2ã€ç„¶åä¸Šä¼ ä»æ–‡ä»¶(æ—¢ï¼šç¼©ç•¥å›¾)ï¼ŒæŒ‡å®šä¸»æ–‡ä»¶FIDå’Œä»æ–‡ä»¶åç¼€åï¼Œä¸Šä¼ åå¾—åˆ°ä»æ–‡ä»¶FID

### javaå®¢æˆ·ç«¯æ–¹å¼(ä¸æ¨è)

```
package com.cyb.fdfs.client;

import com.sun.tools.corba.se.idl.StringGen;
import org.csource.common.NameValuePair;
import org.csource.fastdfs.*;

import java.net.URLDecoder;

public class FastDFSClient2 {
    private static TrackerClient trackerClient = null;
    private static TrackerServer trackerServer = null;
    private static StorageServer storageServer = null;
    private static StorageClient1 client = null;
    // fdfsClientçš„é…ç½®æ–‡ä»¶è·¯å¾„
    private static String CONF_NAME = "/fdfs/fdfs_client.conf";


    static {
        try {
            //é…ç½®æ©å»ºå¿…é¡»åˆ¶å®šå…¨è·¯å¾„
            String confName = FastDFSClient2.class.getResource(CONF_NAME).getPath();
            //é…ç½®æ–‡ä»¶å…¨è·¯å¾„å¦‚æœæœ‰ä¸­æ–‡ï¼Œéœ€è¦è¿›è¡Œutf8è½¬ç 
            confName = URLDecoder.decode(confName, "utf8");

            ClientGlobal.init(confName);
            trackerClient = new TrackerClient();
            trackerServer = trackerClient.getConnection();
            storageServer = null;
            client = new StorageClient1(trackerServer, storageServer);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    /**
     * ä¸Šä¼ ä¸»æ–‡ä»¶
     *
     * @param filePath
     * @return ä¸»æ–‡ä»¶ID
     * @throws Exception
     */
    public static String uploadFile(String filePath) throws Exception {
        String fileId = "";
        String fileExtName = "";
        if (filePath.contains(".")) {
            fileExtName = filePath.substring(filePath.lastIndexOf(".")+1);
        } else {
            return fileId;
        }
        try {
            fileId = client.upload_file1(filePath, fileExtName, null);
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            trackerServer.close();
        }
        return fileId;
    }

    /**
     * ä¸Šä¼ ä»æ–‡ä»¶
     *
     * @param masterFileId  FastDFSæœåŠ¡å™¨è¿”å›çš„ä¸»æ–‡ä»¶çš„fileid
     * @param prefixName    ä»æ–‡ä»¶åç¼€å(å¦‚ï¼š_200*200)
     * @param slaveFilePath ä»æ–‡ä»¶æ‰€åœ¨è·¯å¾„(ä¸»ä»æ–‡ä»¶åœ¨æœ¬åœ°éƒ½éœ€è¦æœ‰å¯¹åº”çš„æ–‡ä»¶)
     * @return
     * @throws Exception
     */
    public static String uploadSlaveFile(String masterFileId, String prefixName, String slaveFilePath) throws Exception {

        String slaveFileId = "";
        String slaveFileExtName = "";
        if (slaveFilePath.contains(".")) {
            slaveFileExtName = slaveFilePath.substring(slaveFilePath.lastIndexOf(".") + 1);
        } else {
            return slaveFileId;
        }
        try {
            slaveFileId = client.upload_file1(masterFileId, prefixName, slaveFilePath, slaveFileExtName, null);
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            trackerServer.close();
        }
        return slaveFileId;
    }

    public static int download(String fileId, String localFile) throws Exception {
        int result = 0;
        //å»ºç«‹è¿æ¥
        TrackerClient tracker = new TrackerClient();
        TrackerServer trackerServer = tracker.getConnection();
        StorageServer storageServer = null;
        StorageClient1 client = new StorageClient1(trackerServer, storageServer);
        //ä¸Šä¼ æ–‡ä»¶
        try {
            result = client.download_file1(fileId, localFile);
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            trackerServer.close();
        }
        return result;
    }

    public static void main(String[] args) {
        try {
            //ä¸Šä¼ ä¸»æ–‡ä»¶
            String masterFileId=uploadFile("/Users/chenyanbin/Desktop/1.jpg");
            System.out.println("ä¸»æ–‡ä»¶:"+masterFileId);
            //ä¸‹è½½ä¸Šä¼ æˆåŠŸçš„ä¸»æ–‡ä»¶
            download(masterFileId,"/Users/chenyanbin/Desktop/11.jpg");
            //ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šå¾…ä¸Šä¼ çš„ä»æ–‡ä»¶(ç”±æ­¤å¯çŸ¥é“ï¼Œè¿˜éœ€è¦æŠŠä¹‹å‰çš„ä¸‹è½½ï¼Œåœ¨æœ¬åœ°ç”Ÿæˆåï¼Œåœ¨ä¸Šä¼ )
            String slaveFileId=uploadSlaveFile(masterFileId,"_120x120","/Users/chenyanbin/Desktop/2.jpg");
            System.out.println("ä»æ–‡ä»¶:"+slaveFileId);
            //ä¸‹è½½ä¸Šä¼ æˆåŠŸçš„ç¼©ç•¥å›¾
            download(slaveFileId,"/Users/chenyanbin/Desktop/22.jpg");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

## Nginxç”Ÿæˆç¼©ç•¥å›¾(æ¨èğŸ‘)

## image_filteræ¨¡å—

nginx_http_image_filter_moduleåœ¨nginx 0.7.54ä»¥åæ‰å‡ºç°çš„ï¼Œç”¨äºå¯¹**jpegã€gifå’Œpng**å›¾ç‰‡è¿›è¡Œè½¬æ¢å¤„ç†(**å‹ç¼©ã€è£å‰ªã€æ—‹è½¬**)ã€‚è¿™ä¸ªæ¨¡å—é»˜è®¤ä¸è¢«ç¼–è¯‘ï¼Œæ‰€ä»¥è¦åœ¨ç¼–è¯‘nginxæºç çš„æ—¶å€™ï¼ŒåŠ å…¥ç›¸å…³é…ç½®ä¿¡æ¯

### æ£€æµ‹nginxæ¨¡å—å®‰è£…æƒ…å†µ

[![img](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200505211335063-675347336.png)](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200505211335063-675347336.png)

### å®‰è£…æ­¥éª¤

**å®‰è£…gdï¼ŒHttpImageFilterModuleæ¨¡å—éœ€è¦ä¾èµ–gd-develçš„æ”¯æŒ**

```
yum -y install gd-devel
```

### åœ¨åŸæ¥æ¨¡å—åŸºç¡€ä¸Šè¿½åŠ 

```
--with-http_image_filter_module
```

[![img](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200505221903513-402937197.png)](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200505221903513-402937197.png)

### è®¿é—®æ™®é€šå›¾ç‰‡

éœ€æ±‚ï¼Œå‡è®¾æˆ‘ä»¬å›¾ç‰‡çš„çœŸå®è·¯å¾„æ˜¯åœ¨æœ¬åœ°/cyb/data/img/1.jpgï¼Œä¸‹é¢æœ‰ç‹ æ¯’ojpgæ ¼å¼çš„å›¾ç‰‡ï¼Œæˆ‘ä»¬å¸Œæœ›é€šè¿‡è®¿é—®/img/1_100x100.jpgè¿™æ ·çš„è¯·æ±‚è·¯å¾„å¯ä»¥ç”Ÿæˆå®½ä¸º100ï¼Œé«˜ä¹Ÿä¸º100çš„å°å›¾ï¼Œå¹¶ä¸”è¯·æ±‚çš„å®½å’Œé«˜æ˜¯å¯å˜çš„ï¼Œé‚£ä¹ˆè¿™æ—¶å€™éœ€è¦åœ¨nginxæ¨¡å—ä¸­æ‹¦æˆªè¯·æ±‚å¹¶è¿”å›è½¬æ¢åçš„å°å›¾ï¼Œåœ¨å¯¹åº”server{}æ®µä¸­è¿›è¡Œé…ç½®ã€‚

### nginx.confé…ç½®å¦‚ä¸‹

```
      location ~* /img/(.*)_(\d+)x(\d+)\.(jpg|gif|png)$ {
          root /;
        set $s $1;
        set $w $2;
        set $h $3;
        set $t $4;
        image_filter resize $w $h;
        image_filter_buffer 10M;
        rewrite ^/img/(.*)$ /cyb/data/img/$s.$t break;
       }
æ—‹è½¬ï¼šimage_filter_rotate åº¦æ•°;
image_filter rotate 90; --æ—‹è½¬90åº¦
image_filter rotate 180; --æ—‹è½¬180åº¦

è£å‰ªï¼šimage_filter crop width height;
image_filter crop 120 60; --è£å‰ªæˆå®½120ï¼Œé«˜60
```

[![img](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200505233908526-608143719.png)](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200505233908526-608143719.png)

#### ç„¶ååœ¨/cyb/data/img/ä¸‹å­˜æ”¾ä¸€å¼ å›¾ç‰‡

[![img](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200505234002392-26906562.png)](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200505234002392-26906562.png)

ã€€ã€€æ³¨æ„ï¼šè¯¥å›¾ç‰‡ä¸€å®šè¦æœ‰è¯»å–æƒé™ï¼Œè¦ä¸ç„¶nginxæ˜¯è¯»å–ä¸åˆ°çš„ï¼ï¼ï¼

[![img](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200505234121751-960326419.png)](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200505234121751-960326419.png)

### å…³é—­nginxï¼Œå¹¶é‡å¯(å¹³æ»‘é‡å¯æ²¡ç”¨)

```
nginx -s stop
nginx
```

### æµ‹è¯•(æ™®é€šå›¾ç‰‡)

[![img](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200506155407755-756822264.gif)](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200506155407755-756822264.gif)

### è®¿é—®FastDFSå›¾ç‰‡

```
      location ~ group1/M00/(.+)_(\d+)x(\d+)\.(jpg|gif|png){
        # è®¾å¤‡åˆ«åï¼ˆç±»ä¼¼äºrootçš„ç”¨æ³•ï¼‰
        alias /cyb/server/fastdfs/storage/data/;
        # fastdfsä¸­çš„ngx_fastdfs_moduleæ¨¡å—
        ngx_fastdfs_module;

        set $w $2;
        set $h $3;

        if ($w != "0"){
            rewrite group1/M00(.+)_(\d+)x(\d+)\.(jpg|gif|png)$ group1/M00$1.$4 break;
        }

        if ($h != "0"){
            rewrite group1/M00(.+)_(\d+)x(\d+)\.(jpg|gif|png)$ group1/M00$1.$4 break;
        }
        # æ ¹æ®ç»™å®šé•¿å®½ç”Ÿæˆç¼©ç•¥å›¾
        image_filter resize $w $h;
        # åŸå›¾æœ€å¤§2Mï¼Œè¦è£å‰ªçš„å›¾ç‰‡è¶…è¿‡2Mè¿”å›415é”™è¯¯ï¼Œéœ€è¦è°ƒèŠ‚å‚æ•°image_filter_buffer
        image_filter_buffer 2M;
       }
```

[![img](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200506154300525-158052122.png)](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200506154300525-158052122.png)

### æµ‹è¯•(FastDFSå›¾ç‰‡)

[![img](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200506154729603-593732699.gif)](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200506154729603-593732699.gif)

## Nginx Imageç¼©ç•¥å›¾ æ¨¡å—

- è¯¥æ¨¡å—ä¸»è¦åŠŸèƒ½æ˜¯å¯¹è¯·æ±‚çš„å›¾ç‰‡è¿›è¡Œç¼©ç•¥/æ°´å°å¤„ç†ï¼Œæ”¯æŒæ–‡å­—æ°´å°å’Œå›¾ç‰‡æ°´å°
- æ”¯æŒè‡ªå®šä¹‰å­—ä½“ï¼Œæ–‡å­—å¤§å°ï¼Œæ°´å°é€æ˜åº¦ï¼Œæ°´å°ä½ç½®
- æ”¯æŒjpeg/png/gif(Gifç”Ÿæˆåå˜æˆé™æ€å›¾ç‰‡)

### å®‰è£…nginx imageæ¨¡å—

ç¼–è¯‘nginxå‰ï¼Œè¯·ç¡®è®¤æ˜¯å¦å®‰è£…è¿‡libcurl-dev libgd2-dev libpcre-devä¾èµ–åº“

```
yum install -y dg-devel pcre-devel libcurl-devel
```

### ä¸‹è½½nginx imageæ¨¡å—

```
https://github.com/oupula/ngx_image_thumb/archive/master.zip
```

### è§£å‹

```
tar -zxvf ngx_image_thumb-master.zip
```

### æ‰§è¡Œconfigure

[![img](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200506162331415-480383696.png)](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200506162331415-480383696.png)

### ç¼–è¯‘ä¸å®‰è£…

```
make && make install
```

### ä¿®æ”¹nginx.confé…ç½®

```
      location /img/ {
        root /cyb/data/;
        # å¼€å¯å‹ç¼©åŠŸèƒ½
        image on;
        # æ˜¯å¦ä¸ç”Ÿæˆå›¾ç‰‡è€Œç›´æ¥å¤„ç†åè¾“å‡º
        image_output on;

        image_water on;
        # æ°´å°ç±»å‹ï¼š0ä¸ºå›¾ç‰‡æ°´å°ï¼Œ1ä¸ºæ–‡å­—æ°´å°
        image_water_type 0;
        #æ°´å°å‡ºç°ä½ç½®
        image_water_pos 9;
        # æ°´å°é€æ˜åº¦
        image_water_transparent 80;
        # æ°´å°æ–‡ä»¶
        image_water_file "/cyb/data/logo.png";
    }
```

### å…³é—­å¹¶é‡å¯nginx

```
nginx -s stop
nginx
```

### è®¿é—®æ™®é€šå›¾ç‰‡

- æºå›¾ç‰‡ï¼š192.168.1.109/img/cyb.jpg
- å‹ç¼©å›¾ç‰‡:192.168.1.109/img/cyb.jpg**!c300x200.jpg**

å…¶ä¸­cæ˜¯ç”Ÿæˆå›¾ç‰‡ç¼©ç•¥å›¾çš„å‚æ•°ï¼Œ300æ˜¯ç”Ÿæˆçš„ç¼©ç•¥å›¾çš„å®½ï¼Œ200æ˜¯é«˜

**å‚æ•°è¯´æ˜ï¼š**

ä¸€å…±å¯ä»¥ç”Ÿæˆå››ç§ä¸åŒç±»å‹çš„ç¼©ç•¥å›¾

```
Cï¼šå‚æ•°æŒ‰ç…§è¯·æ±‚å®½é«˜æ¯”ä¾‹ä»å›¾ç‰‡é«˜åº¦ 10% å¤„å¼€å§‹æˆªå–å›¾ç‰‡ï¼Œç„¶åç¼©æ”¾/æ”¾å¤§æŒ‡å®šå°ºå¯¸(å›¾ç‰‡ç¼©ç•¥å›¾å¤§å°ç­‰äºè¯·æ±‚çš„å®½é«˜)

mï¼šå‚æ•°æŒ‰è¯·æ±‚å®½é«˜æ¯”ä¾‹å±…ä¸­æˆªå–å›¾ç‰‡ï¼Œç„¶åç¼©æ”¾/æ”¾å¤§åˆ°æŒ‡å®šå°ºå¯¸(å›¾ç‰‡ç¼©ç•¥å›¾å¤§å°ç­‰äºè¯·æ±‚çš„å®½é«˜)

tï¼šå‚æ•°æŒ‰è¯·æ±‚å®½é«˜æ¯”ä¾‹æŒ‰æ¯”ä¾‹ç¼©æ”¾/æ”¾å¤§åˆ°æŒ‡å®šå°ºå¯¸(å›¾ç‰‡ç¼©ç•¥å›¾å¤§å°å¯èƒ½å°äºè¯·æ±‚çš„å®½é«˜)

wï¼šå‚æ•°æŒ‰è¯·æ±‚å®½é«˜æ¯”ä¾‹ç¼©æ”¾/æ”¾å¤§åˆ°æŒ‡å®šå°ºå¯¸ï¼Œç©ºç™½å¤„å¡«å……ç™½è‰²èƒŒæ™¯è‰²(å›¾ç‰‡ç¼©ç•¥å›¾å¤§å°ç­‰äºè¯·æ±‚çš„å®½é«˜)
```

### æµ‹è¯•(æ™®é€šå›¾ç‰‡)

[![img](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200506170743466-671640366.gif)](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200506170743466-671640366.gif)

ç»†å¿ƒçš„å°ä¼™ä¼´å‘ç°ï¼Œæ°´å°æ²¡æœ‰å‡ºç°ï¼Œæœ¯å°å‡ºæ²¡å‡ºæ¥æœ‰ä¸ªé˜ˆå€¼ï¼š600x600(ç‰ˆæœ¬ä¸åŒï¼Œé˜ˆå€¼å¯èƒ½ä¸åŒ)

[![img](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200506171151392-183405895.png)](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200506171151392-183405895.png)

### è®¿é—®FastDFSå›¾ç‰‡

```
    location /group1/M00/ {
        alias /cyb/server/fastdfs/storage/data/;
    
        image on;
        image_output on;
        image_jpeg_quality 75;
    
        image_water on;
        image_water_type 0;
        image_water_pos 9;
        image_water_transparent 80;
        image_water_file "/cyb/data/logo.png";

        # é…ç½®ä¸€ä¸ªä¸å­˜åœ¨çš„å›¾ç‰‡åœ°å€ï¼Œé˜²æ­¢æŸ¥çœ‹ç¼©ç•¥å›¾æ—¶ç…§ç‰‡ä¸å­˜åœ¨ï¼ŒæœåŠ¡å™¨å“åº”æ…¢
        # image_backend_server http://www.baidu.com/img/baidu_jpglogo3.gif
    }
```

### æµ‹è¯•(FastDFSå›¾ç‰‡)

[![img](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200506174126846-1901221043.png)](https://img2020.cnblogs.com/blog/1504448/202005/1504448-20200506174126846-1901221043.png)